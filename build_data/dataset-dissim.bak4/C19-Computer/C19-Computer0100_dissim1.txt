计算机工程
Computer Engineering
1999年　第25卷　第9期　Vol.25 No.9  1999



更实际的民构并行计算模型
黄伟民　陆鑫达　钟　嵘
　　摘　要　通过结合多种代表性并行计算模型，给出异构环境中的HBSP模型和程序开销计算方法．采用基于消息长度的线性模型具有通信开销的计算更精确、程序和算法在异构环境中的设计灵活、且可解除原有BSP模型对h-relation的限制等优点．当构成BSP计算机的各处理机速度相同原有BSP算法达到最优(即各处理机上所分配的计算量与通信量完全均衡)时,HBSP模型等同于原有模型.
　　关键词　异构计算；BSP模型；并行计算模型
More Practical Heterogeneous Parallel Computing Model
Huang Weimin, Lu Xinda, Zhong Rong
(Dept.of Computer Science of Shanghai Jiaotong Univ., Shanghai200030)
　　Abstact　In this paper, severtal standing parallel computing models are combined and Heterogeneous Bulk Synchronous Parallel(HBSP) model is proposed. The communication cost prediction is made more precisely based on liner model of message length, and the restriction on h-relation of original BSP model is canceled to make the algorithm and program design in HBSP more flexible. The HSBP model is same as the orignal when processor speed of BSP computer is all the same and the original BSP algorithm is optimized(e.g.the computation load and communication load are totally balanced).
　　Key words　Heterogeneous computing;Bulk synchronous parallel model; Parallel computing model
　　由多个独立计算系统通过网络构成的异构系统群，可以转变成一个一致的、功能强大的和较高性能价格比的并行计算资源。近年来，异构并行计算在高性能科学计算和通用应用领域受到广泛研究。在异构网络计算中，常采用消息传递编程模型，即一个并行程序由一组相互协作的进程组成，每个进程都完成相同的任务，在执行时交换消息。消息传递编程具有较强的功能，可以设计出高效和可移植的并行程序，但缺乏理论指导，需要编程人员将数据和计算量手工分配到各个处理器上，源码中需显式增加用于处理器之间通信的例程。若代码具有清晰的并行结构和较少且规则的通信，则易于实现。当代码难以并行且并行进程产生处理器之间的大量不规则通信时，消息传递库函数的使用将变得很困难。具体的编程方法、正确性检查、性能分析等方面仍然处于经验阶段，且易于出错。从编程模型的角度来看，需要一种更自然和简单的计算模型来解决这一问题。以下结合多种代表性计算模型，给出适合于异构网络计算环境的程序设计和开销计算方法。
1 并行计算模型
　　并行计算模型是一个将高层次特点与低层次特性分离开来的界面，提供在其上进行编程的特定操作，对其下所有结构中每个操作的实现作出要求。

图6　“有反馈的自底向上”模式
3.6　“有反馈的平行开发”模式
　　在“有反馈的平行开发”模式（见图7）中，在开发的初始阶段，开发人员主要是在全局性数据仓库数据模型的指导下建立部门数据集市，并把在建立过程中所遇到的问题及其解决方案以及用户的意见等信息，反馈给全局性数据仓库数据模型。抽象性是由于模型提供的操作比底层结构所提供的操作高级得多，简化了软件结构，减少了软件设计的困难。稳定性是由于软件设计可以基于一个长时间保持稳定不变的标准接口，不用考虑并行计算机结构的变化。同时，模型形成了每个并行机实现时所基于的固定起点(程序转换系统、编译和运行系统)。
1.1 共享存储同步计算模型PRAM
　　常见的PRAM是一种共享存储的同步计算模型，各处理器均可在单位时间内读、写共享内存，处理器间同步在一个全局时钟下以锁步(Lockstep)方式实现，因而在算法设计和分析时同步是隐含的，无需在算法中明确设置同步点。在这个模式中用户的新需求的反馈分为两个阶段。PRAM的算法设计和分析比较简单，可用于对并行算法的总体分类，然而却不适合于异步操作的MIMD机器；同时考虑到存储带宽和存储管理的开销，假定访问内存为单位时间也是不合适的，因而也不适合于对实际的并行计算机进行性能预测。
1.2 BSP模型
　　在BSP模型(Bulk Synchroneous Parallel)中，计算由一系列全局同步分开的长度至少为L的超步组成。在每个超步中，每个处理器均执行局部计算，并通过网络接收和发送至多h条消息(称为h-relation)，然后作同步检查，以确定该超步是否完成。在每个超步开始时，处理器仅对已经有效的局部数据进行操作，若数据未准备好，则推迟到下一个超步开始时再进行计算。

图5　“有反馈的自顶向下”模式
3.5　“有反馈的自底向上”模式
　　在“有反馈的自底向上”模式（见图6）中由于采取的是先建设部门数据集市，再以各部门的数据集市为基础建立全局性数据仓库的方式。BSP在一条长为m的消息和m条长为1的消息之间不作区分，两种开销均为mhg；L为连续两个同步操作之间最少所需时间间隔。
1.3 LogP模型
　　LogP模型主要由4个参数描述：L：消息从源到目的地的延迟；o：处理器发送/接收一条消息所需的额外开销；g：处理器可连续发送或接收消息的最小间隔；P：处理器数目。LogP模型中计算也是一系列的超步，超步内消息一旦到达，处理器就可计算，不必等特，超步间无显式同步操作，每个处理器均利用点到点消息传递方式实现隐含的同步。理论上LogP的超步不必像BSP那样受接收或发送消息数目的限制，且超步之间无需显式的同步操作，算法的设计似应更加方便和灵活。“自底向上”模式的特点是初期投资少，见效快。不同的LogP算法其设计技巧亦不同，基本上无章可循。
1.4 LogGP模型
　　LogGP模型[1]是对LogP模型的扩展。在只有短消息时，LogP可以准确地预测通信性能，但对长消息却不能。LogGP模型将LogP模型和一个用于描述长消息的线性模型结合起来，增加了一个参数G，用以描述发送长消息时的网络带宽。一些算法(如FFT、排序等)设计分析和实验数据表明，这个扩展可以准确地预测长短两种消息的通信性能。LogGP的算法与LogP的优化算法相比，执行速度和性能有较大提高，但随着模型的进一步复杂化，LogGP上的算法设计和分析也更为复杂。
1.5 并行计算模型小结
　　与BSP相比，LogP在三方面有所不同：(1)LogP采用基于pairwise同步的消息传递方式；(2)LogP增加参数o，以表示发送消息时所需额外开销，而BSP中除应用于单个消息通信外，这个参数一般可以忽略；(3)LogP模型中的g是从局部的角度来定义的。
2　元数据（Metadata）
　　数据仓库中存储着几百G B的数据。两者相比，BSP模型更具有结构性，也更加简单。LogP模型似乎更为灵活，却要求很强的设计技巧，使算法和程序设计的复杂性难于控制。研究表明[2]，BSP和LogP模型可以有效地相互模拟，使用更简单的BSP编程方式基本不会对性能造成影响。同时，对LogGP的研究发现，实现长消息的最简单办法是将发往同一处理器的几个消息合并成一个消息。
　　由于元数据在数据仓库中的重要作用，当今各大数据仓库生产厂商纷纷把元数据的生成和管理功能集成到产品中，形成元数据的管理环境，如图1。在“平行开发”模式中数据集市的这种相对独立性有利于全局性数据库的建设。从总体上看，对计算模型的研究在经历了从PRAM->BSP->LogP->LogGP的过程之后，又重新回到BSP，对BSP的概念和优缺点有了更深刻的认识和了解。
　　BSP模型指导下的并行程序设计[3]具有编程简单、独立于目标结构和执行性能可预测等特点。BSP程序由于其超步的结构使消息传递操作不会出现死锁，同时在正确性、性能分析和编程方法上都简单易行，很适合异构环境下的消息传递编程。但仍存在要求机间通信满足h-relation条件、g的测算不够精确、在异构环境下不再适合等问题，以下给出适合于异构网络计算环境的BSP模型和开销计算方法。
2 异构环境中的BSP模型和开销计算
　　异构BSP模型(HBSP)中计算由一系列连续的超步组成。每个超步中，每个处理单元使用超步开始前已存放在本地的数据进行计算和处理，这 些任务包括：(1)对存放在本地的数据进行计算；(2)消息传递；(3)消息接收。对于异构计算系统P={P1，P2，…，Pp}，其中处理机数p=|P|,处理机速度参数集合S={S1，S2，…，Sp}，任务分配W={w1，w2，…，wp}，通信量分配集合H={h1，h2，…，hp}。但是在开发的过程中人们发现了一些问题。wtj=wj/s'为处理机Pj完成任务wj所需时间，gt为发送一个字节消息所需时间，Lt为完成Barrirer同步所需时间。
　　这样，每个超步的开销由两部分组成：每个处理器上所进行的本地处理的最大开销(包括局部计算和机间通信开销)和超步结束时barrier同步的开销。
　　　　　　　　　　　　　　　　　　　　　　　　　　　　　　(1)
第i个超步的执行时间T(x)=Tlocalproc+Tsync=
　　　　　　　　　　　　　　　　　　　　　　　　　　　　　　　　(2)
　　在异构BSP模型中，参数L是根据交换空消息然后实现Barrier同步的超步来测算的。
　　机器的指令速度S随着计算类型的重叠不同，会有很大变化，一般对下列两种值进行平均，[s]：给出两个二维数组A[n][m]和B[n][m]，其中m远远大于每个处理器的cache大小，检测一维数组A[i][0]XB[i][0](i=1,…，n-1)的开销，由于每次计算操作需调入cache的数据都不相同，从而产生一次cache miss，可求出处理器速度的下界。
3.4　“有反馈的自顶向下”模式
　　“有反馈的自顶向下”模式（见图5）。
许多现有的并行计算机对于长消息提供特殊的支持，发送长消息的带宽要远大于发送短消息的带宽。考虑到这些因素，更精确地，在异构BSP模型中，将消息大小引入通信开销中，用一个线性公式来描述发送n字节长消息所用的时间：t=t0+tB.n，其中t0是将一个消息发往目标处理机的通信启动开销时间，tB是每字节所用时间。实验数据(图1和表1)表明，这个扩展可以准确地预测消息的通信性能。
　　〈例1〉由(SunE450,SunCreator,SunUltarSparc,SunUltraSparc等)多种机器通过100Mb Ethernet构成的异构计算系统，采用MPI通信原语MPIsend和MPI-Recv来测试不同性能处理机间的通信速度和通信启动开销，得到以下测试结果示意图。
　　从图1和表1中可以看出，3种不同性能处理机间分别交换3种不同数据类型的消息，通信时间基本是通信消息大小的线性函数，各个不同处理机间的通信启动开销基本相同，当发送消息的类型变化时(从char,integer到double)，表示通信速度的斜率基本与消息大小保持一致。需要注意到，通信启动的开销时间与发送2500字节的消息所需时间基本相同。这就需要重新考虑通信与计算的重叠在异构网络环境中的实用性，重叠最多可以使并行计算的速度加倍，实际加速比远小于此，大部分并行算法的计算量比通信量增加得快，所以在设计程序和算法时应合并发往相同处理器的消息。

图1 异构处理机系统中机间通信结果示意图
表1 异构系统机间通信不同类型消息的斜率

处理机斜率
发送消息类型：char发送消息类型：integer发送消息类型：double
Sun USparc-Sun Creator0.1143210.4054830.756228
Sun USparc-Sun USparc0.1124040.3995760.746370
Sun E450-Sun USparc0.1184140.4054830.756047

　　在一个超步中，设处理机Pi需要发送的消息集合为H={h1,h2,…,hk}，其中hi表示消息的长度，一般情况下消息数目k与问题规模相关，显然有k>>p。令h0是将一个消息发往目标处理机的通信启动开销，g是每字节所需操作开销(需要注意到，这里所定义的g小于原有BSP模型中的g)，则每条消息开销为h0+hi.g，从而Pi的通信开销为。由于BSP程序是在所有结果都计算出来以后再进行处理机间的消息传递操作，因此可将发往相同处理机的消息合并成一个大的消息包，则通信启动开销可以减少到不超过p-1次，使得通信开销小于等于。
　　不失一般性，假设处理机集合P={P1,P2,…,Pp}通过相同的网络连接而构成一个BSP计算机，各处理机的通信速度g基本相同。设处理机实际速度参数S'={S'1，S'2，…，S'p}，令，显然处理机完成Barrier同步所需时间Lt通常是由速度最慢的处理机的完成时间所决定，即Lt=L/Smin'。
　　令P*=(P1*,P2*,…,Pp*)，其中Pi*=Si*/Smin'，得出：
　　
　　通信启动开销(p-1)・h0只与处理机数目相关，在问题规模扩大时可以忽略，为简单和易于应用，
　　可使：　　　　　　　　　　　　　　　　　　　　　　　(3)
　　根据异构BSP模型，得出编写高效异构BSP程序的策略：
　　(1)由于每个超步中的Barrier同步必须等待最慢的进程，要使T(x)最小，就应使各处理机的本地计算时间和处理机间通信时间之和尽量均衡。
　　定义1：在BSP计算机上执行的一个计算任务，其分配到某个处理机Pi的计算子任务中，本地计算开销与处理机之间通信开销之比称为该计算任务在Pi上的本地性水平，记作αt。
　　定义2：使BSP计算机的p个处理机达到相同任务完成时间的任务分配W，所对应的在处理机P1,P2,…,Pp上的本地性水平 {α1，α2，…αp}，称为 {Pi} 的临界本地性水平，记作
{αci}。 

　　　显然有：{
　　　　　　　　　Wi/Pi*+hi.g=Wj/Pi*+hj.g　　　i,j p
　　上式成立时的任务分配W达到P1,P2,…,Pp的临界本地性水平，T(x)最小。

图3　“自底向上”模式
3.3　“平行开发”模式
　　“平行开发”模式(见图4)是指在一个全局性数据仓库的数据模型的指导下数据集市的建立和全局性数据仓库的建立同时进行。
　　(3)合并发往相同处理器的多个消息，使每个超步的通信启动开销至多为p-1次。
3 结束语
　　这里给出异构计算环境中的BSP模型(HBSP)和程序开销计算方法。原BSP模型要求处理机间通信满足h-relation关系，HBSP模型中则不再有此限制，为算法和程序设计提供更多的自由。在处理机速度相同的情况下，即P*i=1(i=1…p)时，且各处理机上所分配的计算量与通信量完全均衡时，(1)和(3)式可转化为BSP的标准开销模型：
　　C(x)=max wi+max hi.g+L=w+h.g+L
　　Ti=Tcompi+Tcommi+Tsyni=(w+h.g+L)/S
　　其中：{pj的本地计算时间}，{pj的机间通信时间}，S为构成BSP计算机的单个处理器的执行速度。
　　即：当构成BSP计算机的各处理机速度相同且原有BSP算法达到最优(即各处理机上所分配的计算量与通信量完全均衡)时，异构BSP开销模型等同于原有模型。
*基金项目：国家自然科学基金
作者简介：黄伟民(1970～)，男，博士生，主要研究领域：并行与分布式处理
作者单位：上海交通大学计算机科学与工程系，上海　200030
参考文献
1 Sunderam V.Heterogeneous Network Computing:The Next Generation.Journal of Parallel Computing,1997,23:121-170
2 Bilardi G.BSP vs LogP.In 8th ACM Symp.on Parallel Algorithms and Architectures,1996:25-32
3 McColl W F.Scalability,Portability and Predictability:The BSP Approach to Parallel Programming.Journal of Future Generation Computer Systems,1996,12(4):265-272
收稿日期：1998-11-30
