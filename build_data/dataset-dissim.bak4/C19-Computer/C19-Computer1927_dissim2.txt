微型机与应用
MICROCOMPUTER & ITS APPLICATIONS
2000　Vol.19　No.6　P.32-33




NAT技术及其在防火墙中的应用
户现锋　张大陆
摘要：讨论了NAT的工作原理及其在防火墙中的应用，并对NAT技术的安全性进行了分析。
关键词：网络地址转换技术 连接 防火墙 代理
　　随着Internet网的飞速发展，每年连入的主机数成倍增长。由于开始设计Internet网的时候并没有考虑到这么大的规模，所以分组的地址选择了32位，它可以使分组的格式很好地对齐，但Internet网面临着B类地址耗尽、路由表爆炸和整个地址耗尽的危机。网络地址转换NAT(Network address translation)技术和无类域间路由(CIDR)就是为解决这些问题而开发的一种直接的解决方案。它可以使Internet网得到足够的喘息时间来等待新一代IP协议的出台。由于NAT技术提供了一种掩饰网络内部本质的方法，即NAT通过1个外部地址来响应外部世界的寻址，从而在防火墙中得到了广泛的应用。
1  NAT技术的工作原理
　　NAT技术的基本功能就是用1个或几个IP地址来实现1个局域网络上的所有主机都可以访问Internet。NAT技术可以为TCP、UDP以及lcmp的部分信息进行透明中继。下面以TCP为主要对象讨论其工作原理。如果由于出错而使应用中断，则操作系统不会受到影响，程序不能破坏操作系统或其它应用程序。
　　操作系统位于应用程序不能进入的单独执行域中，当应用需要调用操作系统服务时，它使用明确的程序设计界面发出请求，这些界面允许操作系统控制用户对系统服务的接收访问。
　　(2)使用分级控制，尽可能少地把操作系统特权分配给用户，以便让风险降到最低。实际上，虽然UDP是无连接的，但可以将它作为虚连接来看待。
　　NAT网关上运行的TCP／IP网关软件与常规的网关软件并不相同。通常常规路由器只是机械地根据IP包中的目的IP地址以及路由表将IP数据报从一个网络转发给另一个网络，而NAT网关在Internet内部网络和Internet之间中继IP数据报并非凭借目的IP地址，它的中继是面向连接的，如图1所示。

图1  网关在Internet内部网络和Internet之间中继IP数据报的连接
　　假设在局域网LAN A接入Internet处有1个NAT网关，网关处理所有网络内外之间的TCP／IP连接。NAT网关具有内网端口和外网端口，2个端口各被分配1个IP地址，其中外网端口的IP地址是合法的全球唯一的IP地址200.200.200.200，内网端口的IP地址一般为保留地址，如设为192.168.1.1。当内部网络中的1台主机(例如A)要访问Internet上的Web服务器X（主机地址为202.202.202.202），那么首先A要与X建立TCP连接，设定主机A为此次连接分配的TCP端口为1030，此时主机A将IP数据包（D＝202.202.202.202：80，S＝192.168.1.2：1030）发向NAT网关，当NAT接受到数据包后，会动态地分配1个未用TCP端口，例如1330，然后修改数据包中的地址为（D＝202.202.202：80，S＝200.200.200.200：1330），计算数据包的校验和后发向Internet。由此可以看到此数据包中已经不含任何私有地址的信息。NAT已经录下这对映射：（D＝202.202.202.202：80，S＝192.168.1.2：1030）（D＝202.202.202：80，S＝200.200.200.200：1330）。类似地，工作站和服务器端均能审核系统事件。
　　总之，NAT的地址转换过程存在3个不同的阶段：
　　(1)连接关系的映射关系的建立阶段。发生在会话的开始，当内部的1台机器要与外部的1台机器发生通信时发生，NAT动态地为其分配未使用的TCP端口号，并且会记下这个映射关系，为以后转发IP数据包使用。
　　(2)映射关系的查找与转换阶段。因此，该结构非常适合需要多个客户共享文件和打印机资源的模式。
　　(3)映射关系解除阶段。当TCP的1次连接关闭时，NAT会释放分配给这条连接的端口，以便以后的连接可以继续使用。
2  NAT技术在防火墙中的应用
　　防火墙的主要功能就是防止外部主机对内网中主机的非授权访问，而限制从外部网络到内部网络的连接是主要技术之一，NAT具有这种功能。IntranetWare存在二种主要类型的对象――NetWare或Novell目录服务对象和文件系统对象，每种对象使用不同的存取控制机制来控制存取，这种方法结构上不太可靠。
　　另外，通过使用代理技术也可以使用1个IP地址供多个用户同时上网，但这种技术的一个缺点就是需要对客户端的软件进行修改和配置，给用户带来很多不便。
3.2 存取控制
3.2.1 Windows NT
　　Windows NT通过对象服务器控制提供存取控制，用户能指定其它用户或用户组读、写或修改系统对象。而NAT技术则工作在网络中较低的层次，逻辑上是工作在IP层，给用户连接Internet提供了更大的透明性，其工作则更像一个路由器而并非一个代理网关，同时也便于网络应用的扩展，并不需要给每种新的应用都开发一种代理服务。由于NAT技术并没有工作在应用层（代理网关工作在应用层，它理解提供服务的每一种协议细节），从而，NAT并不需要理解和操纵应用层的数据，具有更高的效率，使得NAT技术在防火墙中得到应用。
3  NAT技术的安全性分析
　　下面，对NAT技术的安全性做一些分析。
　　IntranetWare最大的问题是应用程序与操作系统共享相同的地址空间，而事实上应用程序并不一定打算在服务器上运行，与Windows NT不同，IntranetWare上的主机应用程序可作为设备驱动器进行查看，因此，本质上，它们变成了操作系统的一部分，其明显的含义是应用程序与操作系统具有完全相同的权限。另外当端口地址在NAT内动态分配时，使得外部攻击者对NAT域中的一个特定主机的攻击更加困难。
　　(2)当NAT设备不在安全域中时，应用级的负载可以进行端到端的加密，比如利用SSL。只要负载中不包含IP地址和运输层的端口信息，就可以提高安全性。安全分区的缺陷意味着恶意的程序能破坏或入侵系统处理的任何安全机制，从而损害系统试图保护的数据。
　　(4)由于NAT设备是作为1台Internet主机出现，因此也被作为攻击的对象。
　　(3)特权允许应用程序使用一个特殊用户或组的特权运行，用户或组特权能由系统管理员控制。
　　(5)NAT在做到地址隐藏的同时，也减少了提供安全的额外选择，例如IPsec的选用。目前，我们正在进行二者的集成与开发。
户现锋（上海同济大学计算机系200092）
张大陆（上海同济大学计算机系200092）
参考文献
1，Egevang R．Francis P．The IP Network Address Translator（NAT）．RFC1631，1994；（5）
2，Srisuresh P，Holdrege M．IP Network Address Translator（NAT）Terminology and Considerations．RFC2663，1999；（8）
3，Rent S，Atkinson R．Security Architecture for the Internet Protocol RFC2401，1998；（11）
4，IETF．Security L2TP using．IPSEC，1999
5，Netscape Communication Corp．The SSL protocol Version 3．0，1996
6，Tanenbaum AS．Computer Networks．Third Edition． Prentice－Hall，1996
7，Huitema C．Routing in the Internet．北京：清华大学出 版社，1998
8，DOUGLAS E．COMER．Internetworking with TCP／IP（Vol 1）．北京：电子工业出版社，1998
9，Slattery T，Burton W．Advanced IP Routing in Cisco Networks．北京：机械工业出版社，1999；（6）
收稿日期：1999－12－23
