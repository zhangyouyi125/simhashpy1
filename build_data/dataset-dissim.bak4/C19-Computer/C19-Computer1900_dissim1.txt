微型机与应用
WEIXINGJI YU YINGYONG
2000　Vol.19　No.5　P.18-19




用PC机直接开发单片机系统
马正红　岳兴良　董小虎　郝宝钟
摘 要：一种不依赖于仿真器、通过PC机串行口直接调试目标系统的单片机自开发方法。
关键词：直接调试 自编程 自举 可重定位 PC机
　　贵刊1999年第8期登载的一篇“用PC机直接调试单片机系统的实现”的文章很有新意，拓宽了单片机开发的思路，但仍存在少许不足之处，其不足之处有：
　　（1）要求目标系统既要有外部ROM又要有外部RAM，不适合仅有外部ROM或仅有外部RAM的系统；
　　（2）要求使用地址浮动技术进行目标机程序设计，若不小心，则易出错；
　　（3）不适合ROM大、RAM小的目标系统，因为在这种情况下，系统RAM装不下被调试的代码；
　　（4）系统不具有自编程功能，仍依赖专用开发装置，限制了其应用范围。
　　本文介绍一种新的方法可克服以上不足，特别是无须编程器，目标系统自己将调试成功后的代码固化到EPROM中，真正摆脱了对专用开发设备的依赖，更加具有实用价值。
1 设计思路
　　本方法不采用EPROM存放监控程序，而是将监控程序放在CPU内，即采用内含ROM的8751、8752、89C51、89C52等作调试用CPU。此时对应的因变量估计值以及误差数据如表3。使用时不需要关心其具体的实现方法，只需要和它的对话框进行交互就可以了。
　　假若开机时，使系统工作于EA为高电平的状态，并将内含的监控程序搬移至外部RAM的高端，然后转高端的监控程序执行，待其已转入高端监控程序后，再将EA脚置低电平，则此时的系统与8031系统没有什么差别。由于监控程序在高端地址，故被调试的程序可从0000H开始放置，但这要求目标系统采用合并代码、数据空间模式。
　　（2）规划问题的数学表示目标函数：f（b0）
　　限制条件：G（b0）＜0
　　其中：b0为待定参数。
2 硬件和软件
2．1 制作开发专用CPU
　　选一块质量较好的89C52，将设计好的监控程序固化在内部（此后开发类似系统不再依赖固化设备），并将CPU的EA脚扳起来。找1个小巧的单刀双掷开关，开关的中间脚用短导线焊接至CPU的EA脚，开关的另二脚分别用短导线焊接至CPU的电源脚及接地脚，用环氧树脂将开关及导线浇铸在CPU的背部，使之成为坚固的一体，制备好的CPU就是一个功能强大的开发工具。
2．2 目标系统的线路设计
　　目标系统应采用合并代码、数据空间模式。设计时，将EPROM当作相同容量的RAM看待，即把整个系统的存储器都设计成既可存取数据又可存取指令的形式。

图1　数据点和拟合线对照
表3 计算结果
因变量自变量因变量的估计值误差平方
170.71.6148.9687391472.2476993
228.14.52241.8820534189.9449969
2586.8278.5091076420.6234954
283.78.16294.4132802114.7743716
321.311.5323.40220014.419245341
335.412.7331.548215314.83624515
378.618.2360.1970036338.6702774
434.629395.47094831531.082687
401.338.9416.8885563243.003089
42957.3444.4917783239.9951964
误差平方和->114064.5968

3 方法讨论和结论
　　从以上实例可以看出，在求解过程中没有使用任何程序的概念。考虑到在正常工作时，锁存器的G脚（或CLK）应由CPU的ALE控制，而在对EPROM编程时，G脚就不能由ALE控制，因为ALE上电平的每个指令周期都在跳变，因而无法将锁得的编程地址长时间保持不变。所以本方法在使用上是非常简便的。

图1 硬件电路的存储线路示例
　　以上做法的目的是：在调试期间，开发者可在ROM座上插入相同容量的RAM，将JP2短接，JP3断开，就可将代码装载到它自身的地址空间被调试；在固化阶段将JP1、JP2断开，JP3短接，RAM换成EPROM，在JP1的靠VPP一侧的桩上加上固化电压，让CPU中的监控程序模拟EPROM的固化时序即可实现对目标系统的自编程。当目标系统研制成功后，将JP3断开，JP1、JP2短接即可投入实际运行。
　　对目标系统的串行通信口的处理与本刊1999年第8期介绍的方法相似，但可把电平转换电路做在通信电缆上，转换电路需要的＋5V电压，可从接插口取得，即通信接插口应多加1针，并使之与＋5V电源相连。这样，目标系统就不必增加多余电路。
2．3 监控程序
　　单片机监控程序如图2所示，包括自举程序及监控程序主体。监控程序主体中的调试控制部分可烧录在CPU片内，也可在调试时动态地从微机中装入，动态装载有利于监控程序的随时改进与升级。监控程序中的EPROM固化程序必须在CPU片内取指执行，以保证P0、P2口输出数据的稳定性。
1 拟合和规划的等价关系及Excel中的规划求解工具
　　（1）拟合问题的数学表示
　　不失一般性，以最小二乘法为例，拟合问题的数学表示如下：
　　有数据x和y各为以列向量，假定它们具有关系y＝f（x，a，b），其中：a为已知常数共n个、b为待定参数共m个。包结构为：固化起址、代码长度、代码数据块。

图2 单片机部分监控程序流程图
3 开发过程
　　（1）设计制作目标系统的软硬件。
　　（2）将制备好的专用CPU插入CPU座，将CPU背部开关扳至电源端，在ROM座上插入相同容量RAM，JP2短接，JP3断开。
　　（3）开机复位，此时CPU片内程序开始进行系统自举，待自举完成后（时间一般很短），将CPU背部开关扳至接地端，这样，当CPU执行低地址指令时，执行的将是目标系统的程序而不是监控程序。
　　往DBS水溶液中投入活性炭，在等温下放置到达吸附平衡．DBS的平衡浓度C与投入活性炭的吸附量q之间的关系列于表1中。
　　（5）代码调试成功后，将系统断电，在ROM座上插上EPROM，将JP1、JP2断开，JP3短接，找一电源，将其调至EPROM所需的编程电压，关掉该电源，将正极接至JP1的靠VPP一端的桩上，负极接系统地。
　　问题为：在满足限制条件的前提下求解目标函数的最小值以及相应的参数b0。
　　（7）打开固化电源，从微机向系统发固化命令。此时，系统将从微机中逐段取得代码并将其固化在EPROM中。线性和整数规划取自Frontline Systems公司的John Watson和Dan Fylstra提供的有界变量单纯形法和分支边界法。
　　用本方法开发应用系统，允许目标系统只有外部RAM或只有外部ROM，调试期间代码的执行环境与开发成功后的实际运行环境是一样的，由于代码在其自身的空间存放，因而不会出现因RAM装不下代码而无法调试的情况。同时，由于系统具有自我固化的能力，使其真正摆脱了对专用开发工具的依赖，不但能被专业开发者使用，也为业余开发者提供了一个方便途径。Microsoft Excel Solver程序代码是以宏的方式提供调用的