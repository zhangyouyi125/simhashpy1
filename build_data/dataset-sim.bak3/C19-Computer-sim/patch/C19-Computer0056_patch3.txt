计算机工程
COMPUTER ENGINEERING
1999年  第25卷 第7期 Vol.25 No.5 1999



视频与音频实时多点传输的研究与实现
区海翔 汤庸 李显济 黄鹤远
摘要 在开发桌面视频会议系统（GdDCS）的过程中，利用Windows Socket规范实现了视频、音频在网络上的实时多点播送。首先描述了GdDCS系统多点播送的模型，然后讨论视频、音频实时多点传输的实现。
Dim FieldObjVar() As Field
′定义字段变量
SetFieldObjVar(0)=TableObjVar.CreateField(FieldName,FieldType,FieldLength)
′指定字段的名称，类型，长度
DataBaseObjVar.TableObjVar.Fields.Append FieldObjVar(0)
′添加字段到字段集合中
　　重复上述两条语句，可定义其它字段。所谓CSCW----即计算机支持的协同工作(Computer Supported Cooperative Work)的目的就是让群体在计算机支持下协同工作，共同完成某一任务，共同讨论某一课题或共同决策等。视频会议系统是CSCW研究的重要范例和内容，视频会议系统要求在与会群体中提供实时的视频、音频多点交互，提供群体协商与决策的平台，因而视频、音频信息在网络上实时多点传输是视频会议系统工程的基础。视频、音频是多媒体的重要内容，但在远程通信(特别是在Internet上)实现视频、音频实时多点交互却还存在诸多问题，例如数据的压缩与解压缩[1]，TCP/IP协议网络的广播或多点播送机制[2]，视频、音频媒体内同步与媒体间同步，视频、音频服务质量(QoS)等。合理解决这些问题已成为实现视频、音频多点传输的关键。我们在开发桌面会议系统(GdDCS)的过程中，研究了TCP/IP协议网络上多点播送的机制，并利用Windows Socket 规范，实现了视频、音频的多点传输。
1　TCP/IP协议网络的多点播送模型
　　所谓TCP/IP协议网络，指通信协议采用TCP/IP协议的网络。TCP/IP协议是在Internet上通用的协议，而大部分局域网和部门级的Internet也都采用TCP/IP协议作为通信协议。因此研究TCP/IP协议网络的多点播送机制具有普遍意义和实用价值。在TCP/IP协议网络上实现多点通信可以有两种方式：
　　(1)利用网络的广播功能　所谓'广播'，指源发方只需要发送一份数据拷贝，网络上所有站点都可以接收此数据拷贝。广播是局域网的天然特性，但在Internet上却很难实现。目前，TCP/IP协议对广播的支持还不很充分，但对虚电路通信的支持已经很成熟，因此，我们考虑从应用层上建立多点播送的模型。
　　(2)建立发送方到多个接收方的多条虚电路进行多点播送　这种方案的缺点是数据冗佘大，浪费网络带宽，数据通信效率低等，但这种方案数据传输可靠，保密性好。目前大多数多点播送使用这种方法进行模拟。
　　在GdDCS系统中，考虑到现有协议、路由软件的支持程度和数据传输的可靠性，采用了建立多条虚电路模拟多点播送的方法实现多点通信。但由于GdDCS的体系结构是服务器模型，因此作了以下改，使通信更为简单，控制更为严密。
　　中央服务器作为中央集线器或反射器，多点转发客户数据。客户与客户之间不建立虚电路，客户间通信通过服务器转发。在中央服务器上形成并维护与多个客户通信的虚电路。
2　建立多点通信网络连接
　　在实现中把视频会议系统软件分为两个部分；运行于服务器端的VideoServer及运行于客户端的VideoClient。在通信协议上采用TCP/IP协议。由于CP/IP协议是适合于在当前Internet上使用的协议，因此就为系统能够在Internet上使用奠定了良好的基础。创建索引时，包括索引对象变量，设置主索引及唯一性，创建索引的字段，最后将索引字段和索引分别添加到字段集合和索引集合中。
　　在DataBases之上还有两个DBEngine和WorkSpaces对象，即JET引擎，包含一个集合对象WorkSpaces；WorkSpaces对象包含一个数据库集合对象DataBases，Databases集合由Database对象组成。考虑到现有协议对广播的支持程度及在Internet上进行可靠的数据传输，我们采用了面向连接的虚电路传输方案。在中央服务器上形成多组Socket套构成列表，每一个Socket套与客户端对应的Socket套构成了5条虚电路。
　　DAO比DC要复杂得多，编程中需用到大量的集合和对象的概念，每个对象包括有自己的属性及方法，而且很多属性本身又可成为对象，常使VB初学者无从下手，但是由于它是用编写程序的方式访问数据库的，因此灵活性大，在实际开发程序的过程中，常用来写出高效率的操作数据库的应用程序。
　　数据传输方案采用数据类型划分的方法。
　　TableDef对象包含实际的数据内容，一个数据库可有多个表，使用CreateField方法可以建立新的Field对象，也可用OpenRecordSet方法来建立RecordSet对象，VB中在建立RecordSet对象时应指定具体的类型。
　　(1)用户信息　包括：①客户在建立连接后向中央服务器发送本地音频视频采集格式等；②服务器将用户列表发送到与会各站
　　(2)控制命令　包括：①客户向服务器请求服务；②服务器对客户的应答及广播会议状态等。
　　(3)音频数据库　与会各站点采集的音频数据。
　　(4)视频数据库　与会各站点采集的视频帧。
　　采用这种数据类型划分的方法，某一类数据只在一组Socket套中交互，这就可以简化数据格式，简化网络数据传输打包、解包的过程，而且不同类型的数据可以并行传输。
　　在客户站点建立4个Socket：①ClientSocket传输用户信息，②VideoSocket传输视频数据，③AudioSocket传输音频数据，④CommandSocket传输控制命令及状态信息。
　　客户进程在建立上述4个Socket后，通过ClientSocket套发送客户站点的用户信息，而其余3个上的4个Socket构成一对双向通信的套接字连接。Indigo2是一种高性能的图形工作站，采用Mips 250MHz主频CPU R4000；具有两个PP1像素管道处理器，提供混合、深度和抖动；一个GE11几何图形/图像发生器；一个RE4光栅发生器、能作
　　120M/Sec像素填充。端口号可以由程序设置，通常要大于1024。
　　中央服务器进程初启后立刻建立4个监听线程，分别监听来自不同端口号的Socket连接请求。一旦后台监听线程在特定的端口号检测到连接请求，它就接收请求(Accept)，建立Socket套连接。
Dim IndexObjVar As Index
′定义索引对象变量
Set IndexObjVar=DataBaseObjVar.TableObjVar(0).
CreateIndex(IndexField Name)
′在某个已经创建的表中建立索引对象，并赋给索引对象变量
IndexObjVar.Primary=True
′主索引
IndexObjVar.Uinque=True
′唯一性
Dime IndexFieldObjVar As Field
′定义索引字段对象变量
Set IndexFieldObjVar=IndexObjVar.CreateField(IndexFieldName)
′建立索引字段对象，并赋给字段对象变量
IndexObjVar.Fields.Append IndexFieldObjVar
′索引字段添加到字段集合中
DataBaeObjVar.TableObjVar(0).Inedxes.Append IndexObjVar
′建立的索引对象添加到索引集合中
　　重复上面的语句，则可创建其它表的索引。
　　在实际会议中，至少有两个站点，也可以有多个站点参加会议，中央服务器的监听线程不是简单地形成4个Socket就结束了，还必须把这些新建的Socket存入4个Socket列表中，以便在将来实现多点播送，这4个服务器端的Socket列表分别是：
　　(1)ClientSocket[MAX-USER-NUM]用户信息Socket套组；
　　(2)VideoSocket[MAX-USER-NUM]视频数据Socket套组；
　　(3)AudioSocket[MAX-USER-NUM]音频数据Socket套组；
　　(4)CommandSocket[MAX-USER-NUM]控制命令及状态信息Socket套组。
　　其中，ClientSocket列表在建立网络通信连接时用于多点播送中央服务器上形成的用户列表，而其余3个Socket列表以后用于接收及转发视频、音频数据和实现会议控制功能。
3　语音实时多点播送
　　语音交互是视频会议系统的重要组成部分，语音交互的质量好坏直接决定视频会议的效果，音频模块要保证语音远地回放的质量，延迟小，实时性等。
　　为了使系统适合在Internet上使用，音频的采集，传输与回放通过音频发送缓冲池、音频接收缓冲池进行，如图示1所示。
作者简介：梁　民　刘珍平　研究生。接收方通过接收缓冲池接收音频数据，接收缓冲池满则取出数据经解压缩后送到放音设备播放。由于客户与客户之间没有建立直接通信的逻辑信道，因此，服务器要具备音频转发的功能。在服务器端，接收缓冲池接收数据后，除了在本地回放，还将音频数据包在服务器与客户的多条逻辑信道(源发方除外)上多点播送，从而实现音频的多点交互。
　　当所有网格点三维坐标生成完毕后，则根据网格点坐标生成网格面坐标，并进一步生成asc三维空间网格文件。适合于局域网上应用，局域网带宽大，传输延迟小，N=M=1可以获最好的实时性，控制也最简单。
　　(2)N、M值设为某一域值，N=M或N≠M。在Internet上传输必须考虑媒体内同步与媒体间同步，缓冲池的包数可以在达到域值时才发送或播放，同时对音频数据包加上时间戳或同步标记。
　　(3)N、M值动态变化，这是最复杂的缓冲池控制策略，不过在Internet上也可以获得较为理想的实时性与同步性的折中。“虚拟”指的是利用虚拟现实技术所产生的局部世界是虚构的，而“现实”说明对于进入这一虚构的局部世界的人来说，在感觉上是进入了现实世界。因而，这种方法对要求实时音频的应用(如电视会议系统)的开发特别适用。
4　视频实时多点播送
　　视频模块应当作为会议系统的一个可选的组件，强化多用户之间的协同工作，实现CSCW的"WYSIWIS"的目标。所谓"可选"，指用户可以根据协同的需要、设备状况或网络通信的现状选择是否进行视频交互或调整视频交互的质量。
　　与音频采集、传输和回放类似，视频采集、传输与回放也是通过视频发送缓冲池与一组视频接收缓冲池进行的，如图2所示。

图2 视频多点播送
　　由于视频模块与音频模块在工作机理上的差异，视频模块主要在以下两个方面有所不同：
　　(1)音频流在时间上是互斥关系，即每一时刻都只有一个站点的音频流得以传输，因此一个站点只有一个音频发送缓冲池与一个音频接收缓冲池；视频流在时间上是并发关系，即某个时刻可以有多个站点的视频流在传输，因此一个站点上有一个视频发送缓冲池和多个视频接收缓冲池，多个视频接收缓冲池并行工作。在用户界面表现为同时在多个视频播放窗口上回放多个站点的视频图象。
　　(2)视频数据分为两个部分：帧与帧格式。帧位元数据必须在正确的帧格式下才能正确回放，因此视频缓冲池也分为两部分：帧缓冲池与帧格式池，两者成对采集、传输与回放。
5 小结
　　在开发桌面多点视频会议系统(GdDCS)的过程中，我们设计并实现了一个多点播送模型。它利用客户/服务器模型的特性，在客户与服务器间建立多条虚电路连接，通过服务器的转发(反射)实现多点通信。
　　建好的模型示意图如图2所示：


图2　枢纽布置三维模型列表
2.3　虚拟环境发生器
　　SGI Indigo2工作站是性能较好的图形工作站，它自带了许多高性能的图形库，以方便用户开发，其中，Performance库就是专门用于虚拟环境、视觉仿真的图形库。下一步拟用UDP协议实现通信，以提高传输效率。
　　虚拟现实是利用计算机将客观世界的局部仿造出来，并且允许用户利用自然的动作与这个仿造的局部世界进行交互，产生身临其境的感觉