计算机工程
COMPUTER ENGINEERING
1999年  第25卷 第7期 Vol.25 No.5 1999



虚拟实景空间系统HVS的研究与实现
张茂军 钟力 孙立峰 李云浩 胡晓峰
摘要 虚拟实景空间系统HVS由计算机自动拼接、变形与组织许多幅离散的实景图象或连续的视频，生成虚拟空间。这种虚拟空间具有照片质量的视觉效果，称为虚拟实景空间。虚拟实景空间能为用户提供前进、后退、仰视、俯视、360度环境、近看、远看等漫游能力，可运行于PC平台。
4　结　论
　　实验表明,我们的方法具有较高的检索速度。将介绍它的模型、组成与实现。
关键词 虚拟现实 虚拟实景空间 图象处理 虚拟空间
HVA：A Virtual Reality System Based on the Real-world Image
Zhang Maojun Zhong Li Sun Lifeng Li Yunhao
Dept.7 of National University of Defense Technology Changsha 410073
Hu Xiaofeng
Center of Electronic Teaching.National Universtiy of Defense Beijing 100091
Abstract：HVS uses panoramic video and multivision technology to construct a photo-quality virtual realiy system.Panoramic video is based on 360 degree panorama of real world scene,captured by the normal camer.Multivision provides an approach of information organization.It makes use of many panoramic videos to build a navigable virtual information space.Users can browse and immerse in this virtual information space.HVS was developed on personal computers.This papersummarizes the spatial model and implementation of HVS.
Key words：Virtual reality;Virtual real-image space;Image processing;virtual space
　　虚拟现实技术能生成一个可操纵的虚拟环境，用户通过接口设备(如三维鼠标)可以"进入"到该环境，并与之交互，使用户观察到的虚拟场景随着他的观察点和观察方向的变化而变化。


Simple shape 1, 2, 3 are boundaries of the regions that have notable features。在进行检索时,用户直接画出一个或几个简单形状,作为其查询要求,如图2所示。

Fig.1　Petri net model o fmoving windows correlation processing
图1　滑窗相关处理的Petri网模型
　　此Petri图中各个位置的具体涵义如下。第3节讨论基于形状的图像检索算法。因此,在研究过程中,常常需要作出一系列假设,进而获得这些假设条件下的优化算法。为了能满足虚拟环境的实时性要求，只能减轻场景的复杂度，降低虚拟场景的视觉效果。二是对复杂场景来说，建模工作相当费时费力。而基于实景图象的虚拟现实系统恰好能解决这些问题。
　　在虚拟实景空间系统HVS中，虚拟场景是按以下步骤生成的：首先利用采集的离散图象或连续的视频作为基础数据，经过处理形成360度柱面全景图象。然后，通过合适的空间模型把多幅全景图象组织为虚拟实景空间。在这一方面,滤波理论为我们提供了有力的手段。虚拟实景空间具有如下的优点：
　　・不需要硬件加速就能在PC机上实时运行。
　　・不依赖于特殊的设备，如头盔显示器等。
　　・能显示高质量图象，且处理时间与场景复杂度无关。
　　早在1980年，MIT媒体实验室开发成功Aspen Movie Map项目，用户可以"浏览"模拟视盘中存储的Aspen各个街道。
　　假设用户提供形状集为Ω1＝｛A1,A2,...,An｝,我们提出如下检索算法。到了90年代，基于实景图象和视频建立虚拟环境在国际上成为十分热门的研究课题。单视点描述的系统像"QuickTime VR"和"Surrounding Video"，先后已经用于旅游、多媒体光盘出版等很多方面。
　　检测原理　Rij为目标数据的充分必要条件是：除第i帧信号外,在与第i帧序号之差不超过K的2K帧信号中,存在不小于N(≤K)的L帧信号,其中的L个量测记录Ri1j1,Ri2j2,...,RiLjL满足

这里,K和N均为正整数,D为相关判别函数,G为相关门限,这些参量均由具体的物理模型确定。
　　(1) 若将Si与前K帧信号的相关处理视为一个完整的任务Ti,则由于Si的到达是周期性的,所以Ti也是周期性的任务。在图象处理领域，Image based rendering已经成为十分重要的研究方向。基于实景图象的方法建立虚拟空间具有快速、简单、逼真等独特的优点，正在为越来越多的应用采纳。
4　结　论
　　实验表明,我们的方法具有较高的检索速度。
　　但目前，这些方法大都是单视点空间，多视点组成的虚拟实景空间尚未看到。虚拟实景空间系统HVS瞄准国际上该领域的最新发展趋势，几年前便开始力图用多视点的方法实现用实景图象建立虚拟空间的设想，将其应用到军事侦察、大型建筑和武器装备空间观察、旅游空间的观察等方面，并于近期内开发成功。作为一个实用的系统，HVS在虚拟实景空间模型以及在空间中对信息组织方法等方面具有独创性。
　　Ⅱ类模型――系统以T为周期,每个帧需要完成J个相互独立的任务T1,T2,...,TJ,其中每个Ti又包含ni(k)个子任务ti1,ti2,...,tini(k)(i=1,2,...,J),这里ni(k)是第k帧内Ti中的子任务数,它在一定范围内随机变化,仅在第k周期结束时才成为已知,故｛ni(k)｝为一随机过程,且相邻或相近帧内的ni(k)具有相关性。
　　定义2 视点空间 某一视点处用户所观察到的场景。 The shapes in an image are described by the boundaries of these regions and their spatial relations。也就是说，视点空间应包含任意观察方向上用户所看到的全局场景。系统流程图如图3所示。所以,获得各个任务的估计上限后,即可根据SAA算法的原则实现多任务的分配和调度。全景图象是视点空间合适的描述形式之一。
　　存在几种全景图象：一种是球面全景图象，一种是多面体全景图象，还有一种是最常用的柱面全景图象，如图1。用X=｛fX1,fXn,...,fXn｝表示简单形状X的n个特征量为fX1,fXn,...,fXn。球面全景与多面体全景均可反映空间中任意方向的场景，处理它们的难度比较大。柱面全景实际上是它们的简化形式，如图2。柱面全景没有顶盖与底盖两部分场景，限制了用户在垂直方向的观察角度，但在水平方向是360度视角，满足大部分应用的需要，而柱面全景处理起来比球面全景与多面体全景简单得多，因而应用面比较广。对一些形状特征不很明显的图形,就不好用基于形状的方法进行检索。

图1 立方体全景图图象、球面全景图象和柱面全景图象

图2 柱面全景图象概念图
1.2　虚拟实景空间
　　单个的视点空间反映的是一个三维点空间，而一个虚拟现实系统往往需要建立起一个N维的虚拟空间。N维虚拟空间应具备什么样的特性呢？我们认为：首先，N维虚拟空间应能反映现实世界的三维空间。当然，这样的空间不仅仅是点空间。在点空间内，用户只能靠改变视角来观察不同的场景。N维虚拟空间应支持用户通过改变空间位置来观察不同的场景。其次，N维虚拟空间还应能反映虚拟空间在时间上的变化，如白天与黑夜的变化、风景名胜随季节的变化等。除此之外，还考虑了一种特殊的情况：在虚拟空间中，视点间的变换也许不仅仅局限于物理时空，比如用HVS构建一栋虚拟的教学大楼，这栋虚拟大楼基本上是按大楼的原貌建的，只是有一间房间是虚拟的美国总统克林顿办公室。
　　由于滤波－预测方程只包含6个二次多项式的计算,所以PAA算法的复杂度仍然与SAA算法相当。这便给观众一种跨越时空的感觉。而超越于现实时空又恰恰是虚拟现实系统的特性之一。为此，需要给N维虚拟空间增加"虚化"的能力。
　　　　Step  将ImageNoi置为空集。 The shape of the original image is represented with the three simple shapes and their relationship。虚拟实景空间的操纵包括两部分：视点空间内操纵与视点空间间操纵。视点空间内操纵主要是操纵视角。
　　完成时间系数――设在第n帧中最后完成所有任务的PN执行时间为Pn,则我们定义

为第n帧内的完成时间系数。通过视点空间内操纵，用户可以看到全景图象的其它部分。视点空间内操纵一般包括向左旋转(相当于用户向左看)、向右旋转(相当于用户向右看)、向上移动(相当于仰视)、向下移动(相当于俯视)4种。
　　视点空间间的操纵则建立在视点空间之间的关联上。比如视点空间VPS1与视点空间VPS2在空间位置上是相邻的(这种关联称为位置关联)，用户从视点空间VPS1过渡到空间VPS2，相当于用户从VPS1的位置行进到VPS2的位置，反之亦然。偶然因素的存在常常会导致外部输入的摄动,这样的摄动便造成计算需求的变化,仍以雷达为例,系统内部噪声及外部点状杂波出现都会增加计算需求,并且这样的摄动完全是随机的、白色化的,所以是无法预知的。
　　由于存在上述特性,此算法已经在工程实践中得到充分应用。这正是我们所采用的方法。
　　设视点空间VPS1与VPS2焦距关联，那么这两个视点空间分别反映在同一个视点处用户使用不同焦距所看到的全景图象。焦距关联可以理解为虚化关联的一种。
　　位置关联、时间关联、虚化关联与焦距关联分别赋予了虚拟实景空间的4种不同的特性。由于有位置关联，用户可以在虚拟实景空间中前进与后退；由于有时间关联，用户在虚拟实景空间中可以体会到季节、朝暮等时间上的变化。由于有焦距关联，在虚拟实景空间中，用户可以近看，看得更仔细，或远看，看到整体。由于有虚化关联，虚拟实景空间能反映一些超现实的场景变化。
　　在HVS系统中，我们借助超媒体系统中的"链"来描述视点空间间的关联。然而在很多实时系统中,周期性任务的运行时间或任务数量常常是一些具有一定规律的随机过程,因而上述静态算法的效能将受到限制。这时,我们还可以定义他们的结构距离为：disF（Ω1,Ω2）＝其中d（Ai,Aj）表示Ai与Aj的重心之间的距离。事实上,很多分布式实时系统中的通信周期、信息量及时延等参量均可以描述为一组随机过程,我们也能够对其建立合理的预测估计机制,从而在分配调度算法中综合考虑任务参量和通信参量,这样的算法必定更为完善,更具应用前景。
2　HVS系统组成与实现
　　HVS的功能可以归结为两点：一是生成虚拟实景空间，二是提供一定的手段使用户能在虚拟实景空间中漫游。
　　　　Step 对ShapeNoi中的每个形状号Sj:
　　　　Step 用模板形变的方法确定其与Ai的相似度Similarf。所以,获得各个任务的估计上限后,即可根据SAA算法的原则实现多任务的分配和调度。前者负责把多幅相互间有少量重叠区域的普通图象或连续的视频拼接为全景图象。
　　同时,我们认为,并非每一幅图像都可以用基于形状的方法进行检索。生成虚拟实景空间的过程如图3所示。

图3 虚拟实景空间生成流程
2.1　全景图象生成器
　　柱面全景图象可以由照相机或摄象机采集数据生成。将照相机或摄象机固定在可水平旋转的支架上，照相机或摄象机的镜头需位于支架的中心点。如果是照相机，转动照相机一周并隔一定角度拍照，把得到的相互间有一定接缝的一圈局部图象用于全景图象生成器的输入。如果采用摄象机生成全景图象，则把摄象机缓慢地绕中心点旋转一圈拍摄，得到的视频作为全景图象生成器的输入。
　　假设用户在平面上画出A,B,C,D这4个简单形状,如图4所示,图像库中的某个图像所包含的简单形状如图5所示,并且,通过简单形状相似性计算,已确定匹配关系：A1,B2,3,C4,6,D5,我们的问题是：在图5中是否存在形状子集｛a,b,c,d｝｛1,2,3,4,5,6｝,使得Aa,Bb,Cc,Dd,并且｛a,b,c,d｝与｛A,B,C,D｝有相同的相对空间关系。在实际应用的过程中，发现摄象机视频图象分辨率较低，影响了HVS系统的视觉效果，特别是对于由家用型摄象机采集到的视频。所以倾向于用照相机采集HVS所需的原始数据，数码相机最合适。下面主要针对使用照相机的情况介绍全景图象生成器的实现。
　　由于局部图象Lii与Lij(i≠j)分别是在不同方向上拍下的图象，它们的投影平面存在一定的夹角。在拼接全景图象之前，必须把它们统一投影到某一柱面上，使得现实世界中相同的景物在不同的局部图象中是相同的。图4显示了柱面投影的一个实例，具体算法参见文献[6]。得到投影图象后，进行无缝拼接就能得到没有图象畸变的全景图象，如图5。

图4　柱面投影

图5　一幅全景图象
2.2　可视化编辑器
　　可视化编辑器是HVS系统的重要组成部分，它能把本来互不相干的全景图象组织成用户可任意漫游的虚拟实景空间。但是,形状的特征描述仅仅是在一定的程度上体现了人们对形状的感知,给人感觉到完全不同的形状可能有相同的特征量,因而,这种方法的检索结果与用户想要得到的结果往往会相差很大。为使用户在虚拟实景空间中漫游时不致迷失方向，HVS可视化编辑器中引入了"导航图"。导航图相当于虚拟实景空间的一幅地图，虚拟实景空间中各个视点的位置以及用户当前的位置等均动态绘制在导航图中。关于样条曲线,参见文献［8］。但对于每个PN内部的调度问题,我们却不能直接应用Ⅰ类模型的方法,这是因为对Ⅰ类模型而言,系统的总响应时间并不直接取决于PN上各个子任务的响应时间,而是由各个任务的响应时间决定,因此必须采用下面的调度策略：
　　对于任务Ti,我们假设其中分配到各个PN上的子任务数分别为mi1,mi2,...,miN,于是,令

3　预测算法PAA
3.1　滤波-预测方程
　　在以下讨论中,“参量”一词对于Ⅰ类模型而言就是任务的执行时间,对于Ⅱ类模型而言就是任务中的子任务数。仿真结果表明,对于两类任务模型,PAA算法与SAA算法相比,在任务完成时间、负载均衡度、系统响应时间及任务夭折率等多方面均有显著改善。
　　HVS系统采用标准的JPEG算法对全景图象进行压缩，但在具体操作上，是把全景图象垂直分块，分成大小相等的一系列子图，例如每块为64×600。
　　　　Step 对ShapeNoi中的每个形状号Sj:
　　　　Step 用模板形变的方法确定其与Ai的相似度Similarf。考虑到各个子图是按照同一标准压缩，所以它们可共用同一套码表(包括huffman码表和量化表)，以提高压缩效率。子图的最优宽度受CPU速度、硬盘速度以及JPEG算法本身的影响。因为JPEG标准是按8×8作DCT变换的，因此子图宽度是8的倍数比较好。实践证明，64象素宽的子图对HVS的实时解压浏览最合适。
　　(4) 把E3/L(C)作为匹配的相似度。
1　任务模型
　　现代信息处理系统如雷达、超声诊断仪和CT等,常常需要面对具有以下特性的信号序列：周期性――由于传感器周期性地采集外部信号,在信息处理中可以认为信号的到达是等周期的,或可近似为等周期的,我们称这种周期为帧(frame)；随机性――由于外部环境的变化和测量噪声的存在,各种信号无论在数量上还是在属性上都具有很大的随机性；相关性――单帧信息难以完整地反映信号的属性,但连续数帧内的信号表现出较强的相关性。在导航图中任意位置处指点鼠标按钮，便可以进入到相应位置的视点空间中。在虚拟实景空间中，用户可以用键盘、鼠标与游戏操纵杆控制漫游方向，穿行于各个视点空间中。我们提出的算法便是这方面的一个尝试,初步的仿真结果说明,采用这样的方法可以得到令人满意的效果。当用户向右看时，全景图象向左移动。当用户俯视时，全景图象向上移动。当用户仰视时，全景图象向下移动。点一下近看的图标，焦距大的全景图象被逐步显示出来。点远看的图标时，焦距小的全景图象被逐步显示。点一下前进的图标时，系统将平滑过渡到下一个视点空间。
1.1　检测原理
　　一般地,在提取真实目标信息的过程中,设第i帧输入信号为Si,它包含若干组超过门限的量测记录,即

其中Rij是一个量测记录,含有距离、速度、方位、俯仰及幅度等参量;ni为第i帧输入的量测记录数,它在0与某一上限之间随机变化,故序列｛Si｝为一随机过程。首先是全景图象数据预调技术。由于整幅全景图象数据量比较大，而且浏览器一次只显示全景图象的一部分。因此，HVS浏览器进入到一个视点空间时，没有把整幅全景图象一次性调入内存中，而是只调入可见部分解压显示在屏幕窗口。这种根据索引进行检索的方法,检索速度快。
　　其二，在漫游虚拟实景空间时，用户的前进与后退、近看与远看等涉及到下一个视点空间的显示。用户可能到达的下一个视点空间数目由当前视点空间的链决定。在此我们设利用α-β-γ方法的估计误差上限为M,于是,

即为任务参量在第k帧中的估计上限值。值得指出的是,测试任务夭折率时所设的调度周期小于测试其他3类指标所使用的周期,这样,运行过程中会出现一部分任务的夭折。
　　可见,如果在系统工作过程中我们能够采用适当的方法,减小上述两类因素的影响,便能比较准确地估计出各帧的任务参量,获得理想的分配调度策略。如果浏览器只是简单地把当前图象切换为另一幅图象，是无法使用户产生在空间行进的感觉。
　　图2描绘了系统开始工作后的750帧内某一任务参量的实际值、预测值和任务上限值,由于假设任务参量按照正弦规律变化,所以参量实际值在一正弦曲线附近摄动,摄动的范围与方差的大小成正比,此时若采用参量上限来进行任务的分配和调度显然不尽合理。参考图象不是柱面全景，它的图象分辨率由浏览器决定。如浏览器表现虚拟实景空间所用的窗口大小为800×500象素点，则参考图象的分辨率也是800×500，或稍大。
简单形状1,2,3是从原始图像中提取的具有显著形状特征的区域的边界,我们用这3个简单形状及其空间关系来描述原始图像所具有的形状特征。在实际应用过程中，两种方法可以任选，在起始与终点图象中各象素点景深变化不大时，用图象插值法可得到比较好的效果。否则，应考虑参考点法，或两种方法结合使用。

图6 纵平移参考平滑过渡法
3　结束语
　　虚拟实景空间系统已成为虚拟现实技术的一个重要的发展方向。实验表明,此方法既有较高的检索速度,又有较高的检索精度。这类静态算法的主要问题是,它们均要求被调度任务的特征参数,如运行时间、所含子任务数量、彼此之间的前驱和后继关系、通信关系及通信信息量等为已知,当这些参数未知或变化范围较大时,这类算法便难以达到目标。今后，我们将对视点间过渡技术进行进一步研究。
作者简介：张茂军 男，28岁，博士，主要研究方向包括虚拟现实系统、多媒体通信、多媒体信息系统等
作者单位：张茂军　钟力　孙立峰　李云浩　国防科技大学七系 长沙 410073
　　　　　胡晓峰　国防大学电教中心 北京 100091
参考文献
1　胡晓峰，老松杨，张茂军.HVS：一个半现实全景图时空模型.小型微型计算机系统，1994，15(12)：13-18
2　张茂军，胡晓峰，库锡树.PanoVideo：摄象机运动建模以及从视频中估计摄象机运动参数的一种方法，中国图象图形学报，1997，2(8)：623-628
3　钟力，胡晓峰.全景视频的信息组织和实现方法.小型微型计算机系统，1996，17(12)：1-5
4　钟力，胡晓峰，孙立峰.全景视频信息空间模型.小型微型计算机系统，1997，18(11)：31-35
5　张茂军.基于实景图象的虚拟现实系统HVS设计报告.长沙：国防科技大学七系，1998-06
6　钟力.虚拟实景空间研究与实现.长沙：国防科技大学七系博士论文，1998-09
7　Chen S E.QuickTime VR：An Image-Based Approach to Virtual Environment Navigation，Computer Graphics Proceed-ings.Annual Conference Series，1995：29-38
收稿日期：1998-08-03
