计算机工程
COMPUTER ENGINEERING
1999年  第25卷 第7期 Vol.25 No.5 1999



高级综合中寄存器合并问题的研究
袁小龙　高德远
摘要　高级综合技术的研究在当前倍受关注。在进行资源分配时，为了减少互连线的数目，提高设计质量，应对数据路径综合中所需的寄存器进行合并。通过对寄存器合并问题进行研究分析，给出一种高级综合中的寄存器合并算法。经实验证明，该算法具有速度快、效率高的特点，应用在高级综合系统中时，可提高综合设计的质量。
关键词　高级综合寄存器合并
A Study on Register Merging Problem for High-level Synthesis
Yuan Xiaolong Gao Deyuan
Aerospace Microelectronice Center，Northwest Polytechnical University Xian 710072
Abstract：High-level synthesis is an active area of research presently.Inthe process of resource allocation,the registers required in data path should be merged in order to reduce the interconnection wires.Based on the study of the register merging,a register merging algorithm is presented in this paper.This algorithm is very efficient and can improve the quality of the design in high-level synthesis.
Key words：High-level synthesis；Register；Merge
　　高级综合也叫行为综合，其基本任务是完成从数字系统的行为描述到寄存器传输级(RTL)设计的转换。从行为描述到 RTL结构的转换可分为4个子任务，即：内部表示、操作分配和调度、映射、控制器综合。内部表示子任务将行为描述转化为计算机可以处理的机内表示形式。操作调度将构成设计行为的操作划分到控制步中，使得在一个控制步中的所有操作均可在一个时钟周期中执行。结构如图2所示：


图2
　　第二种将装有计费软件的计算机接在Router与主干线之间，结构如图3所示：


图3
　　在这个结构图中所有计算机首先必须通过这台计费计算机后才能上Internet，所以计费软件不是到Router中取IP包数据而是自动纪录下各个通过它的IP包数据。映射将行为描述设计中的操作、存储器访问及互连分配给硬件单元，得到优化的面积与性能。一旦操作调度、操作分配完成及数据路径单元选取完毕后，须根据操作调度的需要生成相应的控制器，控制器实际上是一个有限状态自动机FSM(Finite State Machine)，操作调度及操作分配确定了FSM的状态数目、状态转换情况及FSM的输入、输出信号，可由这些信息综合出相应的控制电路。
　　这4个子任务相互联系，相互影响。高级综合的第一步是将以算法形式的行为描述转化为一个内部表示，而后其它子任务在此基础之上工作。具体步骤为：
　　新建一项目，在其中插入一父窗体;
　　将子窗体设为无边框无控制象标的形式，从Windows打印管理器中取得打印纸的大小，并将此尺寸设为子窗体的尺寸；
　　在模拟纸张上，使用print 、circle、 line等方法输出文字和图形，亦可利用图形框、图像框、网格控制及统计图表等，生成符合用户要求的报表；
　　利用printform方法将生成的报表输出至打印机。和大多数高级综合系统一样，在操作调度阶段就完成了功能单元的分配，因此在资源分配阶段主要完成存储单元(主要是寄存器)与互连单元(如总线、多路选择器、三态驱动器等)的分配，其中寄存器的分配是数据路径综合中的一个重要任务，高级综合中寄存器的分配可以通过3个步骤来完成，即求出每个变量的生命期、寄存器的分配和寄存器的合并。当前，关于寄存器的分配问题所进行的研究不多，关于寄存器的合并，当前所进行的研究主要集中于用存储器来取代所需要的寄存器。基于实际的芯片设计经验，本文将探讨用寄存器组来取代单个的寄存器，在不影响芯片性能的条件下减少互连线，从而达到减小芯片的面积、提高综合设计质量的目的。这样这台服务器就象“桥”一样使内部网可以跟外部Internet网接通，所有内部计算机与Internet交换的数据都记录在这台服务器的硬盘中了。要解决这个问题，必须先求出每个变量的生命期。
　　寄存器分配是在操作调度的基础之上进行的，前面已提到过，操作调度的任务是将行为描述中的操作划分到控制步中，因而每个变量必须在有效的时间段就确定好，这个时间段就是变量的生命期，以控制步数来度量。在确定变量的生命期时需要注意的一个问题是，当行为描述中含有条件结构时，由于一个条件结构中的两个分枝不会同时执行，如果两个变量是在不同的条件分枝中产生的，则它们不会同时产生，这样，即使它们的生命期有重叠，也可用一个寄存器来保存它们的值，即需要考虑对变量的生命期进行合并的问题。对于图像框，我们必须结合水平和垂直滚动条，实现有限视区的超屏幕内容的浏览，其缺点是无法打印放置于其上的Label、Grid等对象；对于待打印窗体，我们必须设置一缩放因子，将窗体及其上的内容按照打印比例进行缩小后在屏幕上显示出来，其缺点是无法对待打印报表进行100%的全真预览。例如，变量i必须在第2个控制步、第3个控制步和第4个控制步中有效(需要对其值进行保存)时，则它的生命期为集合Si=(2,3,4)。
2　寄存器的分配
　　当确定了每个变量的生命期后，就可进行寄存器的分配。对于两个变量，当它们的生命期不重叠时，则可用一个寄存器来存储它们的值。寄存器的分配问题可采用文献[5]中的团划分算法(clique partitioning algorithm)来解决，在该算法中，用一个图来表示寄存器的分配问题，图中的节点表示变量，以弧连接在同一个控制步中不会同时有效的变量。图1中给出了文献[5]中的例子的VHDL行为描述，经操作调度后，该行为需要5个控制步就可完成执行，语句前面的括号中的数字j表示本行语句将在控制步骤j中完成执行。

图1 一段VHDL行为描述
　　从图1中可看出，该行为描述中包含了15个变量，在这里，假定图1中的VHDL行为描述是连续循环执行的，则很容易确定如图2所示的变量的生命期。Proxy 2.0还可以限制用户上网的功能，例如，企业只允许它们的员工游览Internet（即HTTP）不能Oline聊天（或游戏），那末它可以通过Proxy 2.0的设置定义用户只能HTTP，这样帮助企业减少许多无用数据，节约了开支。显然，对这15个变量，如果给每个变量均分配一个寄存器时，就需要15个寄存器，这样将会浪费硬件资源。实际上，对于这15个变量，仅需要8个寄存器r1-r8，它们分别分配给r1(v1,v14)、r2(v2,v7,v9,v15)、r3(v3,v8,v13)、r4(v4)、r5 (v5,v11)、r6(v6)、r7(v10)、r8(v12)。当确定了数据路径综合中所需的寄存器后，将讨论寄存器的合并问题。
3　寄存器的合并算法
　　对于每个寄存器，在数据路径综合过程中，需要将它与某些功能单元相连接，以进行数值的传输，从而能正确地实现行为描述所定义的功能。如果将每个连接都用连线来实现，对于某些设计，连线的数目将是非常大的。
　　关键词　Visual Basic,报表打印
　　Visual Basic是一个可视性极强的面向事件及对象的编程工具，因其简单高效，易学易用而具有极其广泛的用户基础。在寄存器的合并过程中，首先要考虑的问题就是找出可以合并成一个组的寄存器组，并且使每个组包含尽可能多的寄存器。在对高级综合技术进行研究的过程中发现，如果寄存器组具有的读出端口和写入端口数目比较多时，则每个寄存器组可包含更多的寄存器，但增加了控制开销，相反，如果寄存器组具有的读出端口和写入端口数目比较少时，则每个寄存器组可包含的寄存器就比较少，但控制开销比较小。基于对微处理器和MPP计算机的芯片设计经验，认为，每个寄存器组包含一个写入端口和两个读出端口是比较合适的。在寄存器合并中主要解决的问题就是确定出可以合并到一个寄存器组中的最大的寄存器集合。在进行寄存器的合并时，是先求出可合并到一个寄存器组的最大的寄存器集合，然后再从剩余的寄存器中求出可合并到下一个寄存器组的最大的寄存器集合，重复该过程直至剩下最后一个寄存器或所有的寄存器均已被分配到寄存器组中，当剩下最后一个寄存器时，可根据对它的读写关系将它与相关的元件相连接即可。下面给出求出可合并到一个寄存器组中的寄存器集合的算法。
　　假设每个寄存器组有2个读出端口和1个写入端口；操作调度后，操作被调度到k个控制步中完成执行，即s1--sk；进行寄存器分配后，行为描述中的变量需要y个寄存器来保存其值，即r1--ry；当寄存器i包含在寄存器组RG中时，变量Xi为1，否则，Xi为0；则找到可合并到一个寄存器组RG的最大寄存器数目的问题可定义为如下的0-1线性规划问题：

(1)
约束条件如下：

　　其中j=1,...,k；
　　cij表示寄存器i在第j个控制步中要进行读出操作；
　　dij表示寄存器i在第j个控制步中要进行写入操作。
3　计费系统的实现
3.1　实现的环境
　　图4是一个典型的代理计费网络结构,在该图中,装有计费软件代理服务器这台计算机配置二个100M的网卡，一块要与Router连接，网卡置为正规的IP地址，另一块配企业自己定义的内部IP地址跟企业网的主干线连接。　潘书军　助理工程 　　　　　　从事热电偶的计量检定及开发工作。图3(a)给出了寄存器合并前的数据路径(文献[5]中的图1)，可看出，数据路径中包括8个寄存器，采用本文给出的方法进行寄存器合并后，产生了3个寄存器组，即(v1,v3)、(v2)、(v4,v5,v6,v10,v12) ,最后生成的数据路径如图3(b)所示。因此，管理十分方便。对于图像框，我们必须结合水平和垂直滚动条，实现有限视区的超屏幕内容的浏览，其缺点是无法打印放置于其上的Label、Grid等对象；对于待打印窗体，我们必须设置一缩放因子，将窗体及其上的内容按照打印比例进行缩小后在屏幕上显示出来，其缺点是无法对待打印报表进行100%的全真预览。
　　采用本文中给出的算法对LS MPP中的处理元(包括一个ALU，一个移位器，路由器，一个缓冲器，8个寄存器)进行寄存器合并后，互连线的数目减少了许多，所产生的结果与手工设计的完全一致。
雇员情况一览表　1998.12.21

员工编号姓名性别出生年月职称工龄

制表人：　
　　新建一项目并在项目中插入一父窗体Mdiform1，在Form1上加入一个网格及三个标签，按照下表设置各对象的属性。通过寄存器的合并，不但减少了连线的数目，使芯片的面积减小了，而且使得所产生的数据路径比较规整，体现出了VLSI设计中的模块化思想，这样，有利于对芯片的测试。例如，单个用户的表和总表

姓名：日期：计算机名：
开始时间：结束时间：上机时间：
数据流量：单价：总费用：



日期： xxxx.xx.xx到 xxxx.xx.xx　
计算机名数据量金额（元）
计算机1xxxxxxxxxx
…　　
计算机nxxxxxxxxxx
总　计xxxxxxxxxxxxxx 

　　除了上面安装的软件外，这台计算机还要在安装Microsoft Internet Information server 2.0 和TCP/IP