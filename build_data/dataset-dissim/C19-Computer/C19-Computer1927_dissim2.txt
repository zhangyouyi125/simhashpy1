微型机与应用
MICROCOMPUTER & ITS APPLICATIONS
2000　Vol.19　No.6　P.32-33




NAT技术及其在防火墙中的应用
户现锋　张大陆
摘要：讨论了NAT的工作原理及其在防火墙中的应用，并对NAT技术的安全性进行了分析。
关键词：网络地址转换技术 连接 防火墙 代理
　　随着Internet网的飞速发展，每年连入的主机数成倍增长。由于开始设计Internet网的时候并没有考虑到这么大的规模，所以分组的地址选择了32位，它可以使分组的格式很好地对齐，但Internet网面临着B类地址耗尽、路由表爆炸和整个地址耗尽的危机。网络地址转换NAT(Network address translation)技术和无类域间路由(CIDR)就是为解决这些问题而开发的一种直接的解决方案。它可以使Internet网得到足够的喘息时间来等待新一代IP协议的出台。由于NAT技术提供了一种掩饰网络内部本质的方法，即NAT通过1个外部地址来响应外部世界的寻址，从而在防火墙中得到了广泛的应用。
1  NAT技术的工作原理
　　NAT技术的基本功能就是用1个或几个IP地址来实现1个局域网络上的所有主机都可以访问Internet。NAT技术可以为TCP、UDP以及lcmp的部分信息进行透明中继。
　　Windows NT不仅提供了安全的文件和打印服务，还提供了1组对Windows NT工作站和服务器均有效的统一的安全特性和1套包括把密码功能与应用程序结合起来的安全性功能，因此，对等体系结构的灵活性、认证、审核、安全性分区和管理能力，使得Windows NT成为安全性网络环境的极佳解决方案。
3.1 认  证
3.1.1 Windows NT
　　Windows NT使用加密技术保护服务器上传送和存储的口令，它总是要求认证用户。在TCP中连接是用1对端点来标识的。TCP把端点（endpoint）定义为一对整数（host，port），因此可以将1条TCP连接用1个4元组（Source address：source port；destination address：destination port）来定义，这样的一个连接抽象允许多个连接共享1个端点，例如2条连接（192.168.1.1：1184；192.168.1.3：80）、（192.168.1.2：1184；192.168.1.3：80）共享同1个端点（192.168.1.3：80），但又并不会引起歧义，从而可以看出这种基于连接的抽象为利用1个IP地址进行外部世界的访问提供了基础。实际上，虽然UDP是无连接的，但可以将它作为虚连接来看待。
　　NAT网关上运行的TCP／IP网关软件与常规的网关软件并不相同。因此，基于Windows NT工作站和服务器的网络是一个对等网络，一般来说，服务器上有效的功能对客户机同样有效。AUDITCON工具是基于命令行的，要求具有专门的命令知识，所以管理员的培训要比基于GUI工具的培训要求高得多。NAT网关具有内网端口和外网端口，2个端口各被分配1个IP地址，其中外网端口的IP地址是合法的全球唯一的IP地址200.200.200.200，内网端口的IP地址一般为保留地址，如设为192.168.1.1。当内部网络中的1台主机(例如A)要访问Internet上的Web服务器X（主机地址为202.202.202.202），那么首先A要与X建立TCP连接，设定主机A为此次连接分配的TCP端口为1030，此时主机A将IP数据包（D＝202.202.202.202：80，S＝192.168.1.2：1030）发向NAT网关，当NAT接受到数据包后，会动态地分配1个未用TCP端口，例如1330，然后修改数据包中的地址为（D＝202.202.202：80，S＝200.200.200.200：1330），计算数据包的校验和后发向Internet。由此可以看到此数据包中已经不含任何私有地址的信息。NAT已经录下这对映射：（D＝202.202.202.202：80，S＝192.168.1.2：1030）（D＝202.202.202：80，S＝200.200.200.200：1330）。以后当NAT接受到这1对主机间的任何1个IP分组时，NAT网关会查询内部的映射记录表格，根据这条映射关系使其顺利通过NAT，反之亦然。
　　总之，NAT的地址转换过程存在3个不同的阶段：
　　(1)连接关系的映射关系的建立阶段。发生在会话的开始，当内部的1台机器要与外部的1台机器发生通信时发生，NAT动态地为其分配未使用的TCP端口号，并且会记下这个映射关系，为以后转发IP数据包使用。
　　(2)映射关系的查找与转换阶段。当有外部进入的数据报或从内部出去的数据报通过NAT时，NAT都在内部进行了查找，以便找到对应的映射进行地址转换。
　　(3)映射关系解除阶段。当TCP的1次连接关闭时，NAT会释放分配给这条连接的端口，以便以后的连接可以继续使用。
2  NAT技术在防火墙中的应用
　　防火墙的主要功能就是防止外部主机对内网中主机的非授权访问，而限制从外部网络到内部网络的连接是主要技术之一，NAT具有这种功能。
　　Windows NT不仅提供了安全的文件和打印服务，还提供了1组对Windows NT工作站和服务器均有效的统一的安全特性和1套包括把密码功能与应用程序结合起来的安全性功能，因此，对等体系结构的灵活性、认证、审核、安全性分区和管理能力，使得Windows NT成为安全性网络环境的极佳解决方案。
4.3.1 Windows NT
　　当在Intranet或Internet上开发应用程序时，重要的一点是操作系统应尽可能多地提供程序所需要的安全性功能。更为重要的是需要为每一种应用都编写特定的代理服务器，使得系统的扩展性不是很好。而NAT技术则工作在网络中较低的层次，逻辑上是工作在IP层，给用户连接Internet提供了更大的透明性，其工作则更像一个路由器而并非一个代理网关，同时也便于网络应用的扩展，并不需要给每种新的应用都开发一种代理服务。由于NAT技术并没有工作在应用层（代理网关工作在应用层，它理解提供服务的每一种协议细节），从而，NAT并不需要理解和操纵应用层的数据，具有更高的效率，使得NAT技术在防火墙中得到应用。
3  NAT技术的安全性分析
　　下面，对NAT技术的安全性做一些分析。
1.2 IntranetWare
　　如图2所示，IntranetWare体系结构是一个明确的客户机／服务器模式，即客户端向服务器发出请求，服务器完成这些请求后对客户机返回结果。因此，该结构非常适合需要多个客户共享文件和打印机资源的模式。
　　(2)当NAT设备不在安全域中时，应用级的负载可以进行端到端的加密，比如利用SSL。因此，限制应用所带特权的系统在执行时更安全且不致于滥用和出错。
　　(3)如果将NAT设备和应用网关相结合，可以为应用层中含有IP地址信息的连接进行地址翻译，确保数据报不含有私有的地址信息，这样NAT可以做到对协议透明，起到透明路由器的作用。
　　(4)由于NAT设备是作为1台Internet主机出现，因此也被作为攻击的对象。例如易受SYN Flood和Ping flood attacks攻击，因此应采用相应的技术对NAT设备进行保护。
　　(5)NAT在做到地址隐藏的同时，也减少了提供安全的额外选择，例如IPsec的选用。
设计自己的安全工作站软件与IntranetWare网络通信是一件较困难的事，因为按以前的规定，工作站应能完成用户验证、保护口令、提供有关客户资源的访问控制、保护核心安全、预防应用程序相互干扰和完成审核。
户现锋（上海同济大学计算机系200092）
张大陆（上海同济大学计算机系200092）
参考文献
1，Egevang R．Francis P．The IP Network Address Translator（NAT）．RFC1631，1994；（5）
2，Srisuresh P，Holdrege M．IP Network Address Translator（NAT）Terminology and Considerations．RFC2663，1999；（8）
3，Rent S，Atkinson R．Security Architecture for the Internet Protocol RFC2401，1998；（11）
4，IETF．Security L2TP using．IPSEC，1999
5，Netscape Communication Corp．The SSL protocol Version 3．0，1996
6，Tanenbaum AS．Computer Networks．Third Edition． Prentice－Hall，1996
7，Huitema C．Routing in the Internet．北京：清华大学出 版社，1998
8，DOUGLAS E．COMER．Internetworking with TCP／IP（Vol 1）．北京：电子工业出版社，1998
9，Slattery T，Burton W．Advanced IP Routing in Cisco Networks．北京：机械工业出版社，1999；（6）
收稿日期：1999－12－23
