微型机与应用
MICROCOMPUTER & ITS APPLICATIONS
2000　Vol.19　No.6　P.15,40




基于VB与SQL Server自动构成与发送Email
张鸿源　贾克斌
摘 要：通过VB与SQL Server的集成，利用VB中的远程数据控制与远程数据对象控件从数据库中读取有关的产品信息，形成所需Email的方法。
关键词：远程数据控制 远程数据对象 ODBC驱动程序 电子邮件
　　随着数据库技术的不断发展完善以及数据仓库的出现，许多公司将大量的数据存放在数据库中，利用数据库管理系统(如：SQL Server，Oracle，Sybase等)对数据进行有效的管理。但是由此也带来了与数据库之间的通信问题。本文提出了一种与数据库进行通信的简便方法。并利用VB控件和SQL Server实现了自动发送电子邮件的功能，从而实现了办公室自动化。
1  发送Email功能的实现
　　本系统是通过加载VB的MAPI Session和MAPI Message控件并调用其函数来发送Email的。MAPI全称为电子邮件应用程序接口(Mail Application Programmer Interface)，它是Windows开发服务框架系统的一部分，MAPI开放服务框架系统如图1所示。类似地，隐式类型转换也不是真正的多态，因为在操作开始前，各值必须转换为要求的类型，而输出类型也与输入类型无关。例如，通过使用MAPI驱动程序，Microsoft Exchange消息系统可被连接到绝大多数私用或公用电子邮件系统。它采用统一的接口，即路由器选择MAPI DLL(16位)和MAPI32.DLL(32位)，用户无须考虑各种服务器之间的区别，利用它可以方便地开发邮件系统。
2  多态性应用
2.1 包含多态
　　C++中采用虚拟函数实现包含多态，虚拟函数为C++提供了更为灵活的多态机制，这种多态性在程序运行时才能确定，因此虚拟函数是多态性的精华，至少含有一个虚拟函数的类称为多态类。C++语言的一个非常有说服力的例子是count对象的插入操作(＜＜)。
从上面的分析可以看出，类A的设计尽管是用继承性语法表达的，但它的主要目的不是为代码共享而设计的，而是为了提高多态性而设计的，它是另一个维度的抽象。通过调用上述函数就可以发送Email了。应注意的是，由于VB的MAPI控件要求登录到支持MAPI.DLL的邮件服务器，必须配置Microsoft Exchange或Windows Messageing等支持MAPI.DLL的邮件服务器，否则运行时将显示login failed。
2  形成Email文本
　　由于Email的内容主要是一些相关产品的信息，而且这些信息分布在数据库的不同表格中，因此程序就要与数据库进行连接，并以不同的条件从相关的表格中读取有用信息，形成符合要求的Email文本。在VB中有3种与数据库相连的方法：
　　(1)基于RDO ＆ RDC开发与数据库连接的程序。还允许派生类的成员函数重载基类的成员函数，虚函数就属于这种形式的重载，但它是一种动态的重载方式，即所谓的“动态联编(束定)”。
　　(3)利用VBSQL DB－Library API直接与SQL Server
相连。
　　上述3种方法对数据库操作的示意图如图2所示。

图2  与数据库相连的方法对数据库的操作
　　其中开放式数据库互连(ODBC)应用程序设计接口(API)定义了与数据库无关的编程模型，利用它提供的单一API接口，可以访问任何具有ODBC驱动程序的数据库或数据库服务器，而无需考虑ODBC兼容级别。因而使用ODBC API开发的应用程序具有本地代码编程模型的性能和灵活性。同时，它的编程方法是相当通用的，可以用于多种数据库格式。而Visual Basic Library for SQL Server(VBSQL)是为Visual Basic和Microsoft SQL Server特别设计、调整的DB－Library API的实现。VBSQL提供了几乎所有的数据库API，并被支持为Microsoft SQL Server本地接口。VBSQL与ODBC API相似之处在于：它们都提供最广泛的灵活性，而且在某些情况下，都提供比RDO更好的对SQL Server的访问。
　　C++允许为类重定义已有操作符的语义，使系统预定义的操作符可操作类对象。尽管使用ODBC API和VBSQL DB－Library API能最大限度地直接控制数据库，可以得到更高的性能和更大的灵活性，但却大大增加程序的复杂性。本系统在后台运行且每天只运行1次，对程序运行速度和灵活性没有很高要求。考虑到简便性和一定的灵活性，本程序采用RDO和RDC控件实现对数据库的访问。
蓝雯飞（武汉中南民族学院计算机科学系　430074）
参考文献
1，蓝雯飞．C++中的多态性及其应用．计算机时代，1998；（7）
2，蓝雯飞．C++程序设计中的模板技术．计算机时代，1999；（2）
3，蓝雯飞．用C++中的子类型实现软件再用之探讨．计算机 系统应用，1999；（6）
4，肖基毅．面向对象程序设计中的多态性研究．微计算机应 用，1999；20（3）
5，王斌君，葛玮，王靖亚．C++语言与软件的多态性．计算 机工程与应用，1998；34（10）
收稿日期：1999－12－20
。
　　类模板中的成员函数均为函数模板，因此函数模板是为类模板服务的。当用RDC与数据源连接以后，就可以用OpenResultset(“Select *from表明Where条件”)语句建立新的RDO结果集，这样就可以访问任意的数据表从而得到有用的信息。
图3是一封自动生成的Email。包含多态在不少语言中存在，如整数类型中的子集构成1个子类型。
　　强制使类型检查复杂化，尤其在允许重载的情况下，导致无法消解的二义性，在程序设计时要注意避免由于强制带来的二义性。创建一项任务的步骤如下：
　　(1)启动SQL Executive Manager，选择相应的服务器；
　　(2)在Server菜单上单击Scheduled Tasks，出现Manage Scheduled Tasks窗口；
　　(3)单击New Tasks；
　　(4)在出现的NAME对话框中，填入任务名；
　　(5)在Type中选择CmdExec（表明此任务为COM或EXE文件）；
　　(6)选中Enable复选框，使得此任务可以被调度；
　　(7)在Command中输入此任务包含的可执行文件的路径；
　　(8)若想重复执行任务，选择Recurring；
　　(9)在Occurs下单击Daily，即每天执行1次；
　　(10)单击OK；
　　(11)单击Add。
　　这样就完成了任务的定义，此任务将根据要求每天执行1次。应注意，要进行任务调度必须保证SQL Executive Manager已经启动。
　　单独使用VB或SQL Server的邮件功能不能满足一些特殊的功能要求。本文将二种方法结合起来，利用VB实现发送邮件及与数据库通信的功能，同时利用了SQL Server的任务调度功能，实现了Email的构成和自动定时发送。
张鸿源（北京工业大学信息与信号处理研究室100022）
贾克斌（北京工业大学信息与信号处理研究室100022）
收稿日期：1999－12－12
