微型机与应用
WEIXINGJI YU YINGYONG
2000　Vol.19　No.5　P.18-19




用PC机直接开发单片机系统
马正红　岳兴良　董小虎　郝宝钟
摘 要：一种不依赖于仿真器、通过PC机串行口直接调试目标系统的单片机自开发方法。
关键词：直接调试 自编程 自举 可重定位 PC机
　　贵刊1999年第8期登载的一篇“用PC机直接调试单片机系统的实现”的文章很有新意，拓宽了单片机开发的思路，但仍存在少许不足之处，其不足之处有：
　　（1）要求目标系统既要有外部ROM又要有外部RAM，不适合仅有外部ROM或仅有外部RAM的系统；
　　（2）要求使用地址浮动技术进行目标机程序设计，若不小心，则易出错；
　　（3）不适合ROM大、RAM小的目标系统，因为在这种情况下，系统RAM装不下被调试的代码；
　　（4）系统不具有自编程功能，仍依赖专用开发装置，限制了其应用范围。
　　本文介绍一种新的方法可克服以上不足，特别是无须编程器，目标系统自己将调试成功后的代码固化到EPROM中，真正摆脱了对专用开发设备的依赖，更加具有实用价值。
1 设计思路
　　本方法不采用EPROM存放监控程序，而是将监控程序放在CPU内，即采用内含ROM的8751、8752、89C51、89C52等作调试用CPU。作为一种标准的数据记录和管理工具，它具有大多数数据分析时所需的基本工具，包括图形和线性回归等。
　　8751的特点是：当EA脚接高电平时，若指令指针IP未超过内含ROM容量，指令将从片内取得；当EA脚接低电平或IP值已超过内含ROM容量时，指令将从外部ROM中取得。
　　假若开机时，使系统工作于EA为高电平的状态，并将内含的监控程序搬移至外部RAM的高端，然后转高端的监控程序执行，待其已转入高端监控程序后，再将EA脚置低电平，则此时的系统与8031系统没有什么差别。由于监控程序在高端地址，故被调试的程序可从0000H开始放置，但这要求目标系统采用合并代码、数据空间模式。
　　往DBS水溶液中投入活性炭，在等温下放置到达吸附平衡．DBS的平衡浓度C与投入活性炭的吸附量q之间的关系列于表1中。
2 硬件和软件
2．1 制作开发专用CPU
　　选一块质量较好的89C52，将设计好的监控程序固化在内部（此后开发类似系统不再依赖固化设备），并将CPU的EA脚扳起来。找1个小巧的单刀双掷开关，开关的中间脚用短导线焊接至CPU的EA脚，开关的另二脚分别用短导线焊接至CPU的电源脚及接地脚，用环氧树脂将开关及导线浇铸在CPU的背部，使之成为坚固的一体，制备好的CPU就是一个功能强大的开发工具。经过计算可得对应的3个参数分别为：a＝0．654，b＝185．100，β＝0．878。
表2　数据准备
因变量自变量因变量的估计值误差平方
170.71.6111.34808083522.650312
228.14.52225.67944295.859096867
2586.8284.4755518700.9548418
283.78.16312.8002249846.8230885
321.311.5368.96834552272.271162
335.412.7385.81487812541.659938
378.618.2448.69847534913.796239
434.629533.43227049767.817679
401.338.9588.366487934993.87089
42957.3662.449980754498.8935
误差平方和->114064.5968

　　表格从左到右各列分别为：因变量的原始数据、自变量的原始数据、根据参数计算的估计因变量数据、单个样本点的误差平方。因程序固化时，EPROM的VPP脚应接固化电压，而正常工作时VPP与电源相连，设计时，可在VPP与VCC间加一跳线开关JP1。将待定参数的初始值填写存储在准备用于计算的单元格区域F1：F3，并使单元格F4的数值等于由误差平方累计的误差平方和数值。设计时，可将G与ALE通过跳线开关JP2连接起来，G与P1．7（或其它端口）通过跳线开关JP3连接起来，如图1所示。

图1 硬件电路的存储线路示例
　　以上做法的目的是：在调试期间，开发者可在ROM座上插入相同容量的RAM，将JP2短接，JP3断开，就可将代码装载到它自身的地址空间被调试；在固化阶段将JP1、JP2断开，JP3短接，RAM换成EPROM，在JP1的靠VPP一侧的桩上加上固化电压，让CPU中的监控程序模拟EPROM的固化时序即可实现对目标系统的自编程。当目标系统研制成功后，将JP3断开，JP1、JP2短接即可投入实际运行。
　　对目标系统的串行通信口的处理与本刊1999年第8期介绍的方法相似，但可把电平转换电路做在通信电缆上，转换电路需要的＋5V电压，可从接插口取得，即通信接插口应多加1针，并使之与＋5V电源相连。这样，目标系统就不必增加多余电路。
　　另外，由于问题的定义是直接在Excel表上构造的，所以可以方便地改变问题的构造方法，从而引入其它的拟合计算方法。监控程序主体中的调试控制部分可烧录在CPU片内，也可在调试时动态地从微机中装入，动态装载有利于监控程序的随时改进与升级。监控程序中的EPROM固化程序必须在CPU片内取指执行，以保证P0、P2口输出数据的稳定性。
　　定义最小二乘误差为：

　　问题为：求b使得E为最小。包结构为：固化起址、代码长度、代码数据块。
　　（3）拟合与规划之间的等价关系
　　显然，令拟合问题中的待定参数b为规划问题中的参数b0，令拟合问题中的最小二乘误差函数E为规划问题中的目标函数，令规划问题中的限制条件为空，则求解该规划问题就可以得到拟合问题的解。
　　（2）将制备好的专用CPU插入CPU座，将CPU背部开关扳至电源端，在ROM座上插入相同容量RAM，JP2短接，JP3断开。
　　（3）开机复位，此时CPU片内程序开始进行系统自举，待自举完成后（时间一般很短），将CPU背部开关扳至接地端，这样，当CPU执行低地址指令时，执行的将是目标系统的程序而不是监控程序。
　　（4）利用微机与单片机通信实现目标机代码装载及调试，在调试过程中若出现死机，重新复位时按步骤3进行。
　　（5）代码调试成功后，将系统断电，在ROM座上插上EPROM，将JP1、JP2断开，JP3短接，找一电源，将其调至EPROM所需的编程电压，关掉该电源，将正极接至JP1的靠VPP一端的桩上，负极接系统地。因此在进行数据分析的时候，不同的数据往往需要根据它在模型中的地位和特性进行特殊的处理。
　　（7）打开固化电源，从微机向系统发固化命令。
　　往DBS水溶液中投入活性炭，在等温下放置到达吸附平衡．DBS的平衡浓度C与投入活性炭的吸附量q之间的关系列于表1中。
　　（8）将系统断电，拔出开发专用CPU，插入普通CPU，将JP1、JP2短接，JP3断开，目标机即研制成功。
　　用本方法开发应用系统，允许目标系统只有外部RAM或只有外部ROM，调试期间代码的执行环境与开发成功后的实际运行环境是一样的，由于代码在其自身的空间存放，因而不会出现因RAM装不下代码而无法调试的情况。同时，由于系统具有自我固化的能力，使其真正摆脱了对专用开发工具的依赖，不但能被专业开发者使用，也为业余开发者提供了一个方便途径。
马正红（总装备部四川绵阳中专校第一教研室621006）
岳兴良（总装备部四川绵阳中专校第一教研室621006）
董小虎（总装备部四川绵阳中专校第一教研室621006）
郝宝钟（总装备部四川绵阳中专校第一教研室621006）
参考文献
［1］王爱民，潘建寿，康雪艳，李晓群．用PC机直接调试单片 机系统的实现．微型机与应用，1999；(8)
收稿日期：1999－12－29
