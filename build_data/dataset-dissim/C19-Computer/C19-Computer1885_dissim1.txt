微型机与应用
MICROCOMPUTER & ITS APPLICATIONS
2000　Vol.19　No.4　P.29-30



局域网视频数据传输的应用研究
莫宁　俞宁
摘 要： 在运行ＴＣＰ／ＩＰ协议的局域网环境下利用ＵＤＰ用户数据报实现视频数据传输的方法，并使用该方法给出了一个实时视频监视系统的开发实例，对在局域网上开发视频应用系统进行了有益的研究。
关键词： 局域网视频传输 ＴＣＰ／ＩＰ协议 用户数据报 线程
　　如何利用局域网资源实现视频应用系统已逐渐成为人们研究的热门话题。在局域网上实现视频应用系统的技术关键是如何实现视频信息的传输。为了解决视频数据在计算机网络上传输的问题，国际标准化组织提出了一系列的视频数据压缩传输标准。如国际电信联盟（ITU―T）提出的H．323标准，就是针对在局域网和Internet网络上传输压缩视频数据的国际标准。但是在局域网上如何传输压缩以后的视频数据与网络运行的具体通信协议有关。
1　TCP／IP网络
1．1　基本概念
　　TCP／IP得名于2个有名的协议，即TCP（Transmission Control Protocol）协议和IP（Internet Protocol）协议。然而“TCP／IP”并不仅仅指这2个协议，而是常常用来代表相关的一组协议，如UDP（用户数据报协议）、FTP（文件传输协议）等。采用TCP／IP协议的网络被称为TCP／IP网络。TCP／IP网络分层模型定义了5层网络通信协议（应用层、传输层、网际层、链接层和物理层）。其中传输层和网际层是最为重要的，而链接层和物理层在局域网上是采用局域网的协议标准。需要注意的是，图2所示的波形是解调后的波形，实际的波形是1个约38kHz的方波载波被图2所示信号所调制。TCP／IP的传输层协议与高层协议（ULP）之间的连接对应关系由套接字（Socket）来确定。网际层位于传输层的下方由多种协议组成，IP协议是其中最重要的一个，主要解决网际互联。应用层则根据不同的应用规定了一些标准，如FTP（文件传输协议）、TELENET（仿真终端协议）、SMTP（简单邮件传送协议）等等。
1．2　TCP与UDP比较
　　对于同一网络中的主机到主机的数据传输来说，传输层协议是最重要的协议。
　　在读取计数值时，因为计数器有高字节TH0和低字节TL0之分，所以读数必有先后之分，比如先读高字节，则在读低字节时高字节可能因低字节的进位而发生了变化。TCP与UDP的主要差别为：
　　（1）TCP协议是面向连接的，使用TCP协议交换数据前必须先建立通信主机之间的连接关系，在此连接之上传送TCP分组数据并维护此连接，用户数据传送完毕后要撤除连接。UDP协议是无连接的，每个UDP分组都是独立的数据单元。
　　（2）在TCP传输中，高层数据可以以字节流的形式传递给TCP，字节流被TCP缓冲，直到积累到一定的长度时启动1次发送操作。而在UDP协议中，ULP传递给UDP的是对应于UDP数据包的数据块。
　　（3）TCP协议提供可靠传输服务，包括报文序列、流控制、差错检测、优先级等等。而UDP则不提供以上控制，是不可靠服务。
　　由以上比较可以看出UDP协议比TCP协议实现更简单，它省去了建立连接和拆除连接的过程，取消了重发检验机制，能够达到较高的通信速率，其缺陷是不能保证传输的可靠性。因此，TCP协议通常用于数据文件的传输等可靠传输应用，而UDP通常用于对数据可靠性要求不高但数据量大的场合，如图像、语音数据的传输。另外，使用UDP的传输效果与网络的环境密切相关。在局域网的环境下，由于数据传输的误码率是很低的，使用UDP协议传输也能达到很不错的效果。
2　视频监视系统的设计
　　一般对视频监视系统来说，要求系统能实现视频图像的实时传送，尤其是在工业监视等应用场合，为了能及时准确地反映监视现场的情况，图像的延时应不大于400ms。而且在多数情况下，要求实现多个中心监视站同时监视多个现场监视站，这时通信方式不再是简单的点对点方式，而是多点对多点的方式。UDP协议支持广播方式通信，这对于解决图像的多点传送提供了一条简单方便的途径。当有多个中心监视站需要同时监视1个现场监视站时，现场监视站只需简单地以广播方式把数据报送到网上即可。当有多个现场监视站时，可以通过不同的UDP端口号加以区别。基于以上的分析，提出了如图1所示视频传输系统模型。

图1　视频传输系统模型
　　在图1的模型中，各个现场监视站计算机由1个视频捕捉卡与摄像机相连，负责采集并以JPEG方式压缩图像数据，然后以UDP数据报的形式向中心监视站发送。
关键词： ＬＣ７４６２芯片 ＬＣ７４６２编码 单片机解码
1　LC7462简介
　　LC7462是红外遥控发送编码芯片，双列扁平20脚封装。红外信号被接收后，首先是放大、解调，然后再倒相、整形，使之成为TTL标准的电平。但2个互为反码的8位二进制数的总宽度应该是固定的。另外即使某一图像帧在网络传送中发生错误，很快就被下一帧图像刷新，不会影响图像的监视。
3　视频数据传输软件的设计
3．1　软件开发环境
　　软件选用Windows98开发环境，开发时充分发挥Windows GUI程序的优点。
丁福庆（黑龙江呼兰师范专科学校教务处150500）
李利军（黑龙江呼兰师范专科学校教务处150500）
收稿日期：１９９９－１１－２７
。它是Microsoft牵头开发的1组Windows Socket API函数，扩展了UNIX环境下传统的4BSD Socket，以适应Windows的消息驱动。

图1　LC7462的典型应用
　　由K10～K13共4条列线和K00～K07共8条行线组成了4×8矩阵也就是共32个键的按键电路。在这套组件中，包括TNMUDP组件，这个组件就是专用于UDP通信的。本软件中的图像数据传输就是通过它来完成的。
3．2　软件的结构
　　根据以上的视频监视系统模型，软件设计包括二部分：现场监视站和中心监视站软件。处理后的负极性信号送到8031的INT1脚，并将INT1设为脉冲触发中断方式。现场监视站周期性地捕捉图像，经过压缩后再传输。本文分析了LC7462的发射波形进行了分析，并利用8031单片机对其进行了解码，它的典型应用如图1所示。本系统中使用的方法是对每帧图像以JPEG的方式进行软件压缩，压缩品质设为80。整个编码信号经三级管放大后由红外发射管发射出去。由于采用UDP方式传输图像数据，因此软件本身必须负责将每帧图像拆成UDP数据包，然后发送。以下是图像数据的发送部分程序代码（假定图像数据经过压缩后存放在流ImageStream中）：
　　bufftemp：array［1．．maxsize］of char；
　　bytes，i，divsion，remain：integer；
　　bytes：＝ImageStream．Size；　　　／／获取图像大小
if bytes，＜＞0 then begin
　　divsion：＝bytes div maxsize；　　／／maxsize为每个
　　　　　　　　　　　　　　　　　　　／／UDP包大小
　　remain：＝bytes mod maxsize；
　　FUDP1．SendBuffer（StartSend，5）；／／图像传输开始标记，FUDP1―TNMUDP对象
　　sleep（1）；
　　for i：＝0 to divsion－1 do　　　　／／拆分并发送图
　　　　　　　　　　　　　　　　　　　　／／像数据
　　begin
　　　ImageStream．ReadBuffer（bufftemp，maxsize）；
　　　FUDP1．SendBuffer（bufftemp，maxsize）；
　　end；
if remain ＜＞0 then begin
　　　Imagestream．ReadBuffer（bufftemp，remain）；
　　　FUDP1．SendBuffer（bufftemp，remain）；
　　　　　end；
　　　sleep（1）；
　　FUDP1．SendBuffer（EndSend，5）；　　／／图像传输
　　　　　　　　　　　　　　　　　　　　／／结束标记
　　end；
……
　　（2）中心监视站软件
　　中心监视站软件负责接受UDP数据包并还原成完整的图像数据，然后解压显示图像。当中心监视站的UDP组件收到1个数据包时，就会触发OnDataReceived事件。程序可以在此事件的处理函数中读取图像数据。为了使中心监视站能及时接受所有的UDP数据包，该事件处理函数应尽可能简单、迅速地完成。另外，图像的解压显示功能应在另一个线程中完成。只有获得了这个同步头以后才能开始对各位脉冲进行计数，否则按干扰处理。
　　在读取计数值时，因为计数器有高字节TH0和低字节TL0之分，所以读数必有先后之分，比如先读高字节，则在读低字节时高字节可能因低字节的进位而发生了变化。我们使用这一方法在局域网上成功地实现了1个实时视频监视系统。在此系统中，中心监视站同时监视4个现场监视站。
3　单片机解码的实现
　　以8031单片机为例进行说明。中心站选用Intel PⅢ 450 CPU，128MB内存的机器，实际效果可以达到15～20帧／秒。由于本系统使用的是单帧JPEG图像传送方式，因此图像传送的实时效果相当好，特别适用于工业监视等实时性要求比较高的场合，具有较好的实际应用前景。
莫宁（武汉水利电力大学研9703班430072）
俞宁（武汉水利电力大学研9703班430072）
收稿日期：１９９９－１１－１８
