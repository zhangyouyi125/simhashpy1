微型机与应用
MICROCOMPUTER & ITS APPLICATIONS
2000 Vol.19 No.3 P.33-34,40



分布式容错时间同步化系统的误差分析
欧阳　李榕　方维坚
　　摘　要：分布式容错时间同步化系统是为了解决分布式环境中的各种计算机同步问题的一种工具。
1.1 匹配运算
　　匹配运算有2个操作数:1个目的字符串操作数和1个正则表达式操作数。本文较为详细地分析了误差产生的主要原因,并且根据实验提出了解决误差问题的建议和方法。
　　关键词：分布式 容错 时间同步化系统 误差分析
1 分布式容错时间同步策略简介
　　目前,有许多的应用领域需要依靠电脑的高可靠性和高效率来精确掌握关键性的工作与任务,例如航管系统、医疗监视系统以及核能发电系统等等。这类系统无法容许任何的错误产生。以往传统的设计与要求,已不适合在如此严格的环境下运作,因此,如何精确地掌握错误模式与影响程度是一个相当重要的问题。
　　随着计算机网络技术的发展与主从结构（client/server）观念的提倡,比中央集权式（centralized processing）更有弹性、成本更低的分布式处理结构（distributed processing）已为现今众多系统所采用。“分布式系统容错”（fault tolerance in distributed systems）就是探讨容错技术在分布式系统中的应用。随着网络技术的发展,单机单工系统日益减少,取而代之的是多机多工的分布式电脑系统。分布式系统中主要的元件如:处理器、通信网络、计时器、资料储存装置及软件等,这些都是单一独立的元件,并且这些典型的元件通常不会考虑容错。但事实上,在分布式系统中,这些元件都是以相互合作的方式在运作,不可能脱离其它元件而独立,因而这些元件的容错能力决定了分布式系统容错能力,是分布式系统容错主要的研究范畴。“名”和“值”用“=”加以连接,构成“名=值”对,“名=值”对按表单元素的先后次序排列。
　　在目前的分布式系统的时间同步上存在着技术上的困难与限制:1.无法达成真正的时间同步化。目前,几乎在每一种流行的计算机平台上都有相应的Perl语言解释器,使得用Perl编制的CGI程序具有极好的可移植性,Perl于是成为Web上颇受欢迎的工具之一。实际通信网络的信息传递一定会有时间上的延迟（propagation delay）;3.参考时间在分布式环境中传输的正确性也会严重影响系统时间同步。
　　如果存在匹配,即如果在目的字符串中存在如正则表达式所描述的字符串模式,则返回真,否则返回假。
1.1 主仆式及时间服务器的时间同步化策略
　　主仆式及时间服务器时间同步化策略在分布系统中,是最直接、最简单也是最广泛被应用于分布式系统中达到时间同步化的方法。其策略就是在系统中建立1个或若干个具有高可信度与有效度的时间服务器,而系统中其它的节点则透过通信网络与服务器直接地撷取正确的时间来修正各自的时间,进而达到整个系统中各节点时间上的同步。
　　主仆式时间同步化策略最主要的应用是NTP（Network Time Protocol）及其相关的SNTP（Simple NTP）的制定,且成为当今国际网络中许多时间同步化机制的标准。另外运用时间服务器式的时间同步化策略的关键Novell Netware 4.01网管系统也是采用的主仆式结构。Netware 4.01将其系统区分为内部时间同步化（internal time synchronization）与外部时间同步化（external time synchronization）,主要是建立几种不同类型的时间服务器,依其不同的功能而分层管理,如图1所示。主仆式与时间服务器式时间同步化策略的优点是其原理和设备都很简单,但缺点是容错能力低、集中式管理易受瓶颈效应（bottle-neck effect）影响等。

图1 Netware 4.01时间服务器
1.2 拜占庭协议式时间同步化策略
　　拜占庭协议（Byzantine Agreement/Consensus）在分布式系统容错领域中是另一种基本且重要的容错技术,它的算法就是其中一节点充当发送者,由它发送一特定信息给所有结点,非错误节点接收到此信息一经处理后,会将它再正确地广播给其它剩余节点,每个节点透过彼此信息的交换,通过多数决定（majority）方式可以知道哪些节点发生错误,之后各节点再轮流当发送者,不断传递回交换信息,直至所有错误被找到为止,如图2所示。

图2 拜占庭协议示意图
　　拜占庭协议具有如下特性:（1）它适用于侦测所有分布式系统中的任何错误（arbitrary fault）,包括信息遗失或节点错误等等;（2）它要执行m次递归程序以决定m个错误;（3）它的容错能力可以达总节点数三分之一的错误个数,每个节点对外连接数需大于错误个数2倍。
　　拜占庭协议也被用于时间同步化的策略上,其优点:（1）容错能力强;（2）适用于任何形态的系统错误。为了简明起见,只给出主要的程序段。
1.3 收敛函数式时间同步化策略
　　收敛函数式时间同步化策略是分布式容错时间同步算法研究中第3种被广泛使用的一种策略。其目的是搜集系统中各个节点的参考时间,通过1个有效的收敛函数从所收集的参考时间里决定同步化时间,再根据其结果来调整各自的时间。基本步骤如下:
　　1.从其它的节点收集参考时间值;
　　2.考虑影响因素进而估算其时间估计值;
　　3.运用一收敛函数计算这些时间估计值,并获得一正确时间值;
　　4.根据正确时间值来修正各自的时间。
2 分布式容错时间同步化系统的误差分析
　　我们课题小组设计了1个简单网络时间协议。根据设计,此协议要求达到的精度是0.5s,所设计的系统包括1台服务器和1个客户端,客户端向服务器发送时间同步的请求,服务器在收到了请求后将时间信息发送给客户端,从而达到时间的同步化。
　　1.构成“名=值”对
　　将数据组织成由“&”隔开的、有序排列的“名=值”对,这里的“名”指的是HTML表单中数据输入区域的名字（由NAME属性指定）,而“值”指的是用户提交的数据。
根据分布式容错时间同步化系统的精度公式:

　　式中:n为节点总数,k为出错的节点数。
　　在系统中产生误差的因素为Δmax和θmax,其中Δmax为时间信息延时最大值,θmax为时间估计值中间隔最大值,也就是最大时钟误差。在整个系统启动或新的客户端加入时,可能会因为θmax值大大地影响精确度,但是经过2次时间同步化的周期后,就可收敛至一定的数值。根据我们的实践经验,在同1个局域网络上,以3分钟时间为同步化周期,则θmax值介于28550ms,因此θmax的影响会趋于固定,变动性不大。
1 正则表达式简介
　　正则表达式用于描述给定字符串的组成模式,其构成类似于算术表达式,通过使用各种运算符来组合较小的表达式。对所有的时间同步化策略而言,传输延迟都是非常重要的被考虑因素。我们认为分布式系统容错的时间同步化主要分为二大类:即决定论时间同步化和几率论时间同步化。它们二者之间最主要的差别就是网络传输的时间延迟Δ;另外经由实验得知,网络传输时间延迟越小,所得到的时间同步化结果精确度就越高。因此,网络传输的时间延迟在整个时间同步化的研究中具有举足轻重的作用,是不可忽略的。
　　根据系统的实验,误差产生最主要的原因还是因为网络传输时间延迟太大,影响了整个同步化结果的精确度。针对造成网络传输时间延迟过大的原因,经过研究和实验,得出影响网络传输延迟产生的原因和解决办法。
　　1.TCP/IP网络通信协定对网络传输延迟有影响。我们的SNTP系统是采用TCP/IP通信协议来作为网络通信的基础,虽然可以保证时间信息不遗失的重送（retransmission）机制,但增加了网络传输的时间延迟,造成Δmax过大,影响时间同步化结果的精度。
　　根据ISO所制定的ISO网络参考模型七层结构,SNTP系统属于应用层（application layer）间的网络通信,而TCP/IP是属于传输层（transport layer）的网络通信协定,我们认为造成网络传输时间延迟过大的最主要原因在于TCP/IP通信协定的通信协定延迟（Protocol delay）,造成Δmax估计值过大,如同在传输速度很慢的通信网络上进行时间同步化一样,互相传递交换的时间信息延迟自然变大,间接影响时间同步化的精度。
　　2.通信协定延迟的大小显示当时该机器的网络传输状态,影响的因素非常多,包括网络负载（network traffic load）与该机器处理程序的忙碌状态等。
　　针对上述2个影响网络传输产生延迟的原因,经过研究提出了下列解决办法:
　　（1）消除通信协定延迟的影响因素,即将整个时间同步化拉至传输层上进行,缩小信息传输的时间延迟,以接近真实的网络时间延迟,达到改善时间同步化的精确度,如图3所示。下面给出几个典型的Perl程序。但可以在进行时间同步化大量交换采集时间信息时,服务器端与客户端各自送个信息给本地主机（Local Host）,至传输层被传回来,如此可以测量当时服务器端与客户端的通信协定延迟总和。
　　（2）针对其它的影响因素,虽然可通过对当时的通信协定延迟进行测量,但无法代表在交换信息时所有信息的通信协定延迟,为此我们用最小参考值来代替,以期尽量接近当时的通信协定延迟。
　　1.GET
　　使用该方法时,Web服务器将用户提交的数据存入环境变量QUERY_STRING中,CGI程序需从该环境变量中获取所需的数据。假设真正网络传输时间延迟最大值为a,第i个客户端的通信协定延迟为Qci,服务器端通信协定延迟为Qs,因为α=（Qs+Qci）;也可取min（Qs+Qci）二者之中取较小者当作通信协定延迟的最小参考值,即选min（Qd,min（Qs+Qci））作为消除通信协定延迟的参考值。
2.1 CGI方法
　　所谓CGI方法指的是调用主机应用程序（CGI程序）时,Web服务器向其传递数据的方法和途径。由于其使用方便,编制的程序短小精悍,特别是由于其强大的文本处理能力,因而成为编制CGI（Common Gateway Interface）程序的主要语言之一