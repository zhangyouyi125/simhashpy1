微型机与应用
MICROCOMPUTER & ITS APPLICATIONS
2000　No.19　No.1　P.46-48




基于LonWorks技术的远程监控系统的设计与实现
冯显勇　陈辉堂
摘 要： 一套采用LonWorks技术的电梯远程监控系统，讨论了LON节点的工作原理及其与MODEM之间的硬件连接和软件实现。比较了二种不同的实现方法在不同场合中的应用，进一步说明了现场总线的应用价值。 
关键词：远程监控 现场控制网络 串行通信电话网络计算机节点1ModemModem节点2节点3节点4
　　近几年，基于Lonworks技术的控制系统在许多领域都取得迅速发展。在很多应用性的工程中，为了管理上的方便，经常要对一些系统（特别是分散的、无人看守的小系统）的运行状态进行监控，实现集中管理和维护，以减少人力、物力，提高经济效益和工作效率。比如电梯公司或物业管理部门要对分散全市的一些电梯运行情况进行监控。对于分布在较大范围内的系统，用电话线连接实现远程监控在目前还是有着比较重要的意义。本文虽然只是具体介绍了电梯控制系统的监控，但对于类似的控制系统具有普遍的意义。
　　本监控系统的对象是采用LonWorks技术的电梯控制系统，LonWorks是美国Echelon公司1991年推出的一种典型的现场总线系统，又称局域操作网络（Local Operation Networks）。其LonTalks协议支持多种低成本的通信介质，如双绞线、电力线、同轴电缆等，这种电梯与PLC控制的电梯相比较，有着布线少、接线灵活、成本低等优点。在工业现场，RS－485是应用较多的一种通信方式。
1 监控系统组成
　　根据应用系统的实际特点和需求，本系统考虑了2种不同的方案。第1种方案针对所要监测的控制系统为单个控制网络、现场无人值守的情况下，从经济和实用的角度出发，我们采用1个LonWorks节点来实现采集数据和通信的功能。系统的结构如图1所示。

图1 系统结构框图
　　现场部分由LON节点1和调制解调器（MODEM）及电梯控制系统组成，节点1的主要功能是采集需要监控的网络变量，并通过RS232接口与调制解调器连接，将网络变量通过MODEM发送给远端的计算机，或接收远端计算机的命令，从而实现远程监控。节点2、3、4组成电梯的控制系统，分别为外召、主控、轿箱3个控制节点，4个节点之间通过双绞线连接。之所以将数据采集和通信节点做成单独的节点，主要是为应用于别的控制系统，只要在原有的LonWorks控制网络上加1个节点即可。远端只要有计算机和MODEM即可。这种结构的特点是实现比较方便，工作原理和系统结构比较简单，成本比较低。而且通过比较发现，这种方法采集数据的速度是令人满意的，对于MODEM和电话线路的通信质量的要求不高。利用LonWorks的特点，在节点1中定义一些输入型的网络变量，用LonWorks的开发工具将节点1与控制系统中相应的网络变量连接起来，当控制系统中的网络变量发生变化时，节点1中与其相连接的网络变量也会自动更新，同时触发1个事件，所以用这种方法监测到的网络变量的变化速度快，而且简单可靠。
　　第2种方案针对同时监控多个对象（网络），在现场（附近）需要进行监控的情况下，与第1种方案比较，区别主要在现场的数据采集方法上。现场的数据采集利用计算机和SLTA／2网络适配器或PCLTA网卡完成。每个变频器被赋予各自的地址码用以识别身份，这样上位机便能通过485通信线对挂在上面的所有变频器进行控制操作。这种方法因为在现场要配置计算机和网络适配器，若只监控1个较小的系统成本相对比较昂贵，但它有一个较大的优点：可以对已有的控制系统不做任何改动。因此比较适合于对已经投入应用的系统进行监控，或者对系统进行临时的监控。而且利用1台计算机就可以同时监控多个系统，比如对1个住宅小区的多部电梯进行监控，所以也具有一定的应用价值。这种方案的结构与上面的结构图相比，只要将图1中的节点1用计算机和网络适配器代替即可。计算机和LonWorks网络以及MODEM之间的连接是很方便的。
2 系统的硬件实现
　　在第1种方案中，还要解决LON节点1与MODEM之间的数据通信问题。所以必须了解RS232的接口信号，在常用的9个信号中，RTS／CTS请求应答联络信号是用于半双工MODEM系统中作送方式和接收方式的切换，在双工方式系统中，因配置双向通道故不需RTS／CTS联络信号。为了使节点和MODEM之间的通信简化，这里只用了RS232接口的5个接口信号，如表1所示。
表1 RS232引脚信号

CD Carrier Detect数据载波侦测
RXD Receive Data接收数据
TXD Transmit Data发送数据
DTR Data Terminate Ready数据终端准备好
SG Signal Set Ready地线

　　因现场无人值守，接MODEM的DTR信号应该一直为有效（高电平），使MODEM随时能够进行自动应答和拨号的操作。并且通过RS－485通信线最多能同时控制32台变频器，同时各变频器的运行状态也能实时地回送给上位机，这就大大方便了用户，增加了控制系统的灵活性。
　　本文利用VC5．0下的ActiveX控件和MicroMaster变频器RS－485的串行通信功能，实现了在Windows95环境下用单台工控PC机控制多台变频器的任务，并能实时检测各变频器的运行状态。MODEM的RXD，TXD经电平转换分别接神经元芯片的2个I／O口。（本系统采用的3150神经元芯片、I08和I010可分别定义成输入、输出串行口），3150的串行通信是半双工方式，要用一片译码器进行输入、输出的选通。节点1和MODEM之间的电路如图2所示。以往程序员只能通过数目众多的API函数来控制串口。LonWorks提供了Neuron C的编译器，Neuron C是1种面向对象的语言，语法与C语言类似，但可以对I／O口和网络变量的变化以事件触发方式进行处理，极大地方便了软件的开发。只要根据用户的需要对各种事件进行处理，就可以实现控制、通信等各种功能。从监控的要求出发，只要实时监控系统中能反映电梯运行的一些网络变量。RS－485的驱动器可带32个接收器，在波特率为100Kb/s时，通信距离可达到1200m；通信距离为15m时，波特率可达10Mb/s。远端计算机拨通现场的电话后，节点1首先将当前的网络变量值发送过来，此后便随着系统的运行而实时地进行更新。远端主机要停止监测只需挂断电话即可。节点1还要具备自动拨号的功能，在检测到控制系统的故障信号（比如相应的网络变量或I／O口发生变化时）时，应该通过给MODEM发送AT命令，拨通远端主机的电话进行报警。在工业现场，RS－485是应用较多的一种通信方式。为此，我们为程序的某个对话框插入MSComm控件，控件ID为IDC＿MSCOMM1，并利用Class Wizard为其添加变量CCMSComm m＿Coml，则程序中对串口的各种操作都可通过变量m＿Coml来实现。
　　因此，对于变频器能通过面板按键设置的功能，通过以上的通信协议也一样能实现。然后每当有网络变量发生变化时，会触发nv＿update＿occurs（ ）事件，在本事件中首先判断CD是否有效，若有效则将该网络变量编码并发送给MODEM，再通过电话线送给远端计算机。
　　BCC：校验字符，为前面所有字节的异或和。在一定时间内若没有拨通，还要进行重拨。
　　远端计算机的数据是通过串口进入的，软件的设计与控制系统并无直接关系，所以其编程是相对独立的，只需对串口通信进行处理，利用DELPHI中的VBX控件实现Tcomm对串口的通信是非常方便的。有数据进入指定COM口的缓冲区时，会触发1个通信事件，收到数据后，首先要判断信息的类别，区分是控制信号还是要监测的数据，然后分别进行处理。值得注意的是，通过MODEM收发数据，因为数据格式和长度不固定，要采取一定的措施保证数据的有效传输和接收。对监控的数据的处理相对比较简单，只需按照电梯的工作原理和各种信号的逻辑关系用图形动态模拟或用文字加以说明。ZSW是16位的状态字来指示变频器的当前运行状态，各位的具体含义见说明书；HIW也是16位的字代表变频器的输出频率，其定义与HSW是一样的。
　　PKE：为一16位的字，用来控制变频器的运行参数设置，各Bit的含义如下：

控制位0变频器的参数值

　　对于MicroMaster，控制位为0001时，读变频器的参数；控制位为0010时，写参数到变频器的RAM和EEPROM。
　　对于第2种方案，即现场用计算机进行数据采集，其工作原理类似。计算机通过网络适配器接到LonWorks网络上，系统的客户程序是采用Delphi编写的，主要是因为Delphi编写的软件具有执行效率比较高的优点，用它可以很方便地实现应用程序与底层数据采集系统之间的动态数据交换，底层的数据采集要利用LonWorks的开发工具：LonManagerTM DDE Server软件，DDE Server主要的功能就是实现Windows应用程序与LonWorks控制网络之间的通信，实现Windows应用程序和控制网络之间的动态数据交换。DDE Server可以监测LonWorks网络上的网络变量或消息及其变化。利用DELPHI的DDE编程技术，将DDE Server作为服务程序，指定网络变量（netvar）为主题，项目则为具体的网络变量名，就可以实现和DDE Server之间的联系，收集数据或发送命令。
1 系统的总体设计
　　图1为系统的总体设计方框图，这里只重点突出工控PC机与变频器RS－485的接口部分。程序的流程和上述一样，当然用计算机实现串口通信、与MODEM之间的数据传输操作更为方便。功能上也可以做得更为完善，只是由于数据的采集是通过动态数据交换得到的，在数据的更新速度上会有一些不足。
　　本系统采用了LonWorks现场总线控制系统，由于其对等通信、无中心控制，在进行系统设计时解决数据通信问题非常轻松，而且由于其智能分散控制方式等优点，大大降低了调试难度，提高了系统的开发和设计的周期，实验表明用这种方法实现远程监控原理简单，工作可靠，具有较强的实用价值。InputMode使程序能方便地选择从缓冲区读取数据的格式，设置为0时字符串格式，设置为1时表示2进制格式