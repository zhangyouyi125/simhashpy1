微型机与应用
MICROCOMPUTER & ITS APPLICATIONS
2000 Vol.19 No.2 P.31-33




Internet服务器簇技术
何丽天
摘 要： 对当前在Internet网络上实现的各种服务器簇技术进行了概述和一定剖析，并根据其各自的特点进行了比较，为以后的研究和应用工作提供了依据。
关键词： 容错 服务器簇 流量分配 负载平衡
　　随着网络使用的日益广泛和Internet技术的日益成熟，通过Internet获取信息已经成为人们的日常工作和生活中的一部分，许多站点都需要负载沉重的客户访问量，某些热门的Web站点甚至可以达到每秒上千次的点击次数。单网络服务器已远远不能满足客户的需求，经常的网络断线和服务器崩溃造成不能容忍的等待时间和数据重传，占据了大量的网络带宽。因此，网络服务器的存取速度和容错性能越来越受到人们的关注。例如某公司有8个分支机构，其中3个分支机构请求总公司给予指示，则总公司通过自己的局部路由器把信息发入网中，由网络路由器拷贝后传到已预订该信息的3个分支机构的局部路由器，最后送到预订者站点。
　　本文概述了当前在Internet上采用的各种服务器簇技术的特点，并对其优缺点进行了分析。
1 Internet服务器簇
　　从本质上说，服务器簇是1组通过网络连接起来的服务器，每1台服务器都存储相同的信息用于客户访问，所有的服务器对簇内使用不同的IP地址和服务器名，对外界的客户则采用单一的IP地址和服务器名。簇内的服务器可以位于同一个局域网内，也可以位于物理上分布于不同地区的广域网中。服务器簇中包含1个负载平衡器，即1台专用的计算机或1个专用的软件，用于将外界客户对服务器提出的服务请求均衡地分配到每1台有效的服务器上。如果发现某1台服务器失效，将会自动从服务器簇中切除。这样，就可以屏蔽服务器簇的内部结构和簇中的服务器故障，保持对外界客户的一致性和稳定性，从而达到快速反应和容错的目的。
　　服务器簇的特点： 
　　（1）服务器负载平均分配在不同的多台机器上；
　　（2）如果任意1台服务器失效，服务器簇将屏蔽其错误，并将客户请求分配到另1台有效的服务器上完成；
　　（3）服务器簇能够在不影响网络服务的情况下增加或减少服务器的个数； 
　　（4）除了Web访问之外，服务器簇应该能够提供其它的应用级服务。为此，人们提出了一种针对Internet的更为实用的通信技术--Multicast技术，即单点对多点和多点对多点选播(Multicast)方式。
　　根据其负载平衡器的位置不同，可以将它们分为二大类，一类是服务器端的负载平衡，另一类是客户端的流量分配。
1．1 服务器端的负载平衡
　　服务器端的负载平衡是使用专用的服务器端的负载平衡器，通过一定的规则，将客户请求均衡地分配到服务器簇中，并通过某些手段保持对客户端的透明和统一。
　　1．采用Round－Robin DNS算法
　　服务器可以通过DNS方式完成从域名到IP地址的转换。采用Round－Robin DNS，是按照Round－Robin DNS算法，动态地将各个服务器与不同的客户相匹配。当1个DNS服务器接收到某个客户的域名服务请求时，它将从簇内选择1个相匹配的服务器IP来响应。这样，所有的客户机就可以通过同1个服务器名来访问簇中的所有服务器，从而将负载均衡地分配到服务器中。但是，由于DNS服务器的层次结构，并且域名到IP的映射缓存在中间DNS服务器上，因此这种方法很容易导致流量分配的不平衡。其中，最难选择的是动态匹配的生存时间。如果生存时间太长，则分配的不平衡现象将会加剧，如果太短，则R－R DNS将可能成为瓶颈。另外，由于各类客户的访问方式不同，一部分客户可能需要下载大量的页面，而另一部分客户仅需浏览少量页面，也会造成分配的不平衡。当某个服务器失效时，还将造成客户反复访问它，不仅占据了大量网络带宽，而且最终将导致连接失败。
　　2．采用IP层调度算法
　　IP层调度是通过在IP层修改数据包的IP地址来实现客户机与服务器簇之间的通信。随着Internet提供的服务种类和服务量的增加，Multicast技术将成为Internet上的一种服务标准。

　　图1 网络地址转换
　　网络地址转换（NAT）就是一种IP层的调度方法，见图1。它通过对数据包IP地址的转换来实现对不同服务器的并行访问，并使它们对外表现为使用同1个IP地址的虚拟设备。在Multicast结构的网络中，发送者发送一则信息到网络路由器，拷贝后再发送到预订者的局部路由器，最后由局部路由器传送到接收者站点。
　　加州大学伯克立分校开发了“魔法路由器”。它使用专用的协议进行流量分配，能为1组等同的服务器提供1个容错的前端平台，不仅使服务器对外成为1个单机，而且可以屏蔽服务器簇内部的故障。当客户请求建立TCP连接时，“魔法路由器”采用3种算法选择服务器：Round－Robin、随机选择、增量负载。其中，前2种算法可以支持自行扩展，第3种算法则要求额外的服务器信息，包括对服务器当前负载的估计值和每1个TCP连接的负载调度。一旦为当前的客户请求选定了服务器，“魔法路由器”将在地址转换表中增加此匹配方式，直至客户的TCP连接终止才删除匹配。对服务器的故障检测有2种方法：一种方法是由“魔法路由器”定时向所有的服务器发出ARP请求，看服务器的响应是否超时；另一种方法是当发现服务器使用服务端口返回了TCP复位信息时，认为该服务器失效。“魔法路由器”将自动屏蔽簇内的服务器故障并保持对客户的透明。 
　　Cisco公司则使用自行开发的“本地导向器”来进行服务器间的流量平衡分配。后者虽然实现了信息的多路传送，提高了信息传送效率，拓宽了应用领域，但对复杂的Internet而言，如果将某信息同时发送至网上的所有结点，包括那些不想接收此信息的结点，则会浪费网络资源，经济性差；并且还要求网络具有很高的带宽，实现复杂。另外，“本地导向器”在物理上实现冗余，从而保证了整个服务器端的容错。
　　IBM公司开发的“TCP路由器”是一种改进的NAT。客户是通过对服务器簇端的路由器的地址的访问来实现对簇内服务器的访问。当客户数据包到达路由器时，它在考虑负载平衡的基础上将客户请求分配给1台合适的服务器，并将客户数据包的目的地址改为该服务器的地址，然后，为了实现无缝的TCP连接，选中的服务器将使用路由器的地址进行应答。“TCP路由器”的缺点是，必须修改每台服务器上TCP／IP层的核心代码，以使它们使用路由器地址而不是本机地址应答。
　　得克萨斯大学的研究者们在NAT的基础上使用了另一类IP调度算法，统称为“单IP簇技术”。Multicast传播的媒体对象。Broadcast传输方式对于基于卫星传播的网络或其它类型的无线网效果较好。对于每1个TCP连接，都通过一定的hash算法将客户IP映射到某1台服务器上，以使它处理本次客户连接的所有服务。Multicast技术大大加快了软件分布，例如使用Unicast技术传送1MB文件给256个用户需6个小时，而使用Multicast技术则仅需4分钟。Multicast传播的媒体对象。另一种方法是基于广播的，路由器将到达的数据包广播给每1台服务器，同时，每1台服务器都拥有1个唯一的ID号，并运行1个小的过滤程序。所有服务器都将接收到的广播包中的客户源地址提取出来，对它进行过滤后将结果与本机的ID号相比较，如果相同则交由上层处理并使用“虚幻 IP”应答客户，否则丢弃，从而保证了只有1台服务器处理了该数据包。簇中的服务器将由1个后台运行的监测器进行监测，发现故障时监测器将修改位于路由器上的分配器的hash算法或位于每1台服务器上的过滤算法，以屏蔽故障。“单IP簇技术”的1个优点是它不需要修改应答数据包的源地址，从而简化了占据大量网络带宽的应答包的处理过程，不影响系统的效率。
　　2．每个源结点如何有效地使用自己的MCT或共享MCT。这2种方案都是在客户与服务器簇之间增加1台机器作为负载平衡器，再通过交换机或路由器与服务器簇相连。其中，基于IP隧道的技术是负载平衡器将接收到的客户数据包重新封装在1个新的IP包中，并以选中的服务器地址作为新IP包的目的地址发出。选中的服务器接收后进行解包，去除新IP包头和原IP包头，并直接应答客户，见图2。负载平衡器可以使用4种方法选择服务器：Round－Robin算法、加权Round－Robin算法、最小连接数和加权最小连接数。后者虽然实现了信息的多路传送，提高了信息传送效率，拓宽了应用领域，但对复杂的Internet而言，如果将某信息同时发送至网上的所有结点，包括那些不想接收此信息的结点，则会浪费网络资源，经济性差；并且还要求网络具有很高的带宽，实现复杂。其中，运行于负载平衡器上的后台“mon”程序用于监视系统资源的有效性，如fping．monitor每隔t秒钟检测1次服务器节点是否正常，http．monitor检测http服务是否正常。
　　5．如何组建Multicast小组，并对其进行动态管理。所有参加Multicast对话的路由器必须是多路的，当试图对不具备多路能力的Internet网区进行多路交叉通信时，必须在多路路由器之间建立通道（MCT），然后再发送信息。其缺点是服务器端的软件系统必须支持IP隧道技术，如Linux可以支持，而NT则不支持。

图2 IP隧道技术
　　3．采用应用层调度算法
　　应用层位于网络结构的最高层，基于应用层的调度算法一般是对客户的HTTP请求进行分配，交由合适的服务器处理。当1台被请求的服务器忙时，它将通过HTTP协议的重定向信息交由另1台服务器完成。
　　瑞典爱立信公司的Eddies系列产品中包括负责负载平衡的DNS服务器、通用服务器结构、IP地址转向机制和内容复制机制。其中，DNS服务器通过一定的方法获取每1个与之相连的LAN的当前状态，如是否正常工作、负载情况如何等等，在将请求服务的客户与1台服务器相匹配之前，DNS服务器使用这些信息进行衡量，并选择1台响应时间最小的服务器。
　　SWEB是一种多处理器Web服务器。它是基于Web的网络信息，通过采样和预测等方法获取相关节点的效率，以最好地满足客户请求。另一种改进是采用2层的主／从调度结构来构建Web服务器簇，通过将静态和动态内容的处理过程分离开（如将一些低负载的请求送到远程服务器执行），来保证客户请求的实时性，并实现动态资源配置和失效节点的管理。路由器、网桥、网关等，用于传播信息。另外，通过缓存动态内容的访问结果，还可以大大优化Web服务器的平均响应时间。
1．2 客户端流量分配
　　客户端流量分配要求每1台客户机清楚地知道服务器簇的系统结构，并能够以1种负载平衡的方式将服务请求发送到不同的服务器上。 
　　Netscape浏览器就使用了客户端分配技术，在访问其公司主页时，能够随机地选取1个从1～32的整数N，并将服务请求发送到wwwN．netscape．com。但是，大多数公司是不能采用这种方式的，因为他们不可能专门为本公司站点的负载平衡而修改通用的浏览器。
　　加州大学伯克立分校在内部网中开发了1种称为“智能终端”的技术。在这种模式中，1个结点做为发送者把信息传送给N个结点。Broadcast传输方式对于基于卫星传播的网络或其它类型的无线网效果较好。导向程序中的信息随着用户应用程序的不同而变化，例如，当用户发出FTP请求时，从FTP服务器镜像站点中选择1个提供FTP服务。其特点是发送者可以根据需要有选择地发送信息给那些需要此信息的结点，与传统的Unicast方式和Broadcast方式相比，Multicast技术更有效和更经济，使用带宽较低、功耗小、规模合理，并且不随结点数的增加而导致网络拥挤。
　　波士顿大学也开发了1种运行于客户端的通过探测带宽来动态地选择服务器的技术。实现这种技术的前提是客户端预先知道可以提供所需服务的所有服务器的地址列表，而不需要预先知道服务器的位置或网络连接方式。客户机通过“跳”数或回环延迟时间的比较，来选择最适合的服务器响应服务。
2 总 结
　　当前，在Internet上为了给用户提供更多、更可靠的资源，增加网络带宽，提高访问的效率，减小响应时间，已大量采用了服务器簇技术。其中，由于客户端的流量分配方案需要预先知道包含相同资源的站点镜像，并必须修改客户机上的浏览器，所以应用得不太广泛。在这种模式中，1个结点做为发送者把信息传送给N个结点。
何丽天（武汉数字工程研究所430074）
参考文献
1，Anderson E，Patterson D，Brewer E．The Magicrouter：an Application of Fast Packet Interposing．http／／www．cs． berkeley．edu／eanders／magicrouter／，1996；（5）
2，Damani Om P，Emerald Chung P，Huang Y．ONE－IP： Techniques for Hosting a Service on a Cluster of Machines．http／／www．cs．utexas．edu／users／damani／，1997；（8）
3，Zhang Wensong，Jin Shiyao，Wu Quanyuan．Creating Linux Virtual Servers．http／／proxy．iichina．net／wensong／，1999；（2）
4，Yoshikawa C，Chun B，Eastharn P，Vahdat A，Anderson T．Culler D．Using Smart Clients to Build Scalable Services．USENIX＇97，http／／now．cs．berkeley．edu／，1997
收稿日期：1999－10－25
