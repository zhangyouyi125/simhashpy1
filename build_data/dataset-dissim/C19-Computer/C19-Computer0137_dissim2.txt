计算机应用
COMPUTER APPLICATIONS
1999年 第19卷 第10期 Vol.19 No.10 1999



柔性生产线动画监视界面的实现
李秀　沈晶　姜澄宇　王宁生
　　摘　要　本文介绍了某企业柔性生产线信息管理系统监视界面的动画制作，将动画技术加入系统，可以实时仿真生产线运行情况，使之更具有生动性，为生产线的监视带来很大的便利。本文主要介绍了应用可视化编程语言VB及图像处理软件实现动画的主要技术。
　　关键词　Visual basic，仿真，柔性生产线
1　前言
　　我校CIMS实验室与某企业合作开发生产线信息管理系统，该系统在网络和分布式数据库支持下，基本实现资源、信息和人的集成。管理系统信息集成包括：接收MRPII的生产计划、完成任务令的优化调度、实现生产线监视、品质管理、完成统计查询信息，其中的生产监视在工业生产中应用十分广泛。
　　. 在ATM层,当选择优先级较低的业务轮缘信号时,由于溢出,其中一些业务可能被先占。
　　装配：　将绝缘片和制成板放进外壳，由于某系列产品的外壳侧面有一些内凹的筋用于防止制成板被拉出来，在装配时，需要有一机械手用点力将制成板压入。对于双面制成板产品，还需要在放入制成板之前先灌部分胶，另有部分产品装配时需要打螺钉。
　　灌胶：　根据产品的不同要求，分全灌封和点胶两种方式，灌胶速度为平均每个工件10秒以内。某些系列模块直接用胶封装，还有其它系列模块在局部地方点胶。
　　恒温固化：　在恒温箱内，60～70℃温度下恒温固化。经试验，约需30分钟。在轮缘和轮辐上,SDH和ATM层侧重于信号内容的不同方面。特别地,轮缘结点设计较简单,它仅利用了SDH和ATM中仅有的最小功能(即SDH的恢复机制和ATM复用机制),而这些功能恰恰在其协议中较完善。通过这种技术，有时称其为颜色循环，能模仿出流动的水、空气效果、亮度变化，甚至无需众多资源的移动物体和多帧动画。
3.1.2　子画面动画
　　子画面动画的原理如电影动画制作类似，一个达到应有长度的动画电影需要上千张画。在该机制中,ADM结点是ATM VP ADM。但每一帧中的大部分东西并不移动。因此只画一次背景。然后，人物就画在透明的胶片上，摄像师将其和背景放在一起组成一帧。
　　在计算机动画中，“电影胶片”就变成了子画面，位图图形对象和背景在屏幕上独立地移动――对象之间也是相互独立的。子画面使得生成实时计算机动画成为可能。
3.1.3　帧动画
　　帧动画的原理，在分开的纸上画上每一帧图像，然后用计时器在屏幕的相同地方显示每一帧。在星型结构中,每个轮缘结点利用所有的轮带宽同轮彀点通信。窗口有一致背景颜色时，不管图形形状如何，也可以用这个方法显示图形。
　　但通常需要在包含不同颜色的窗口动画非矩形图形，而BitBlt函数总是传送图形的矩形块。源位图中图形周围的图案会覆盖屏幕上的现用图素，从而出现难看的矩形“光环”。
　　在VB中可以有两种方法实现前景与背景的融合，从而实现透明图形的效果。
3.2.1　使用WINDOWS API
　　生成两个源位图：掩膜位图和图形位图。在掩膜位图中，图形为黑色，背景为白色。而在图形位图中，图形为正常色，背景为黑色。
　　下图所示为一设备的掩膜和图形位图。

图1　铣床的掩膜和图形位图
　　为在窗口特定位置显示图形，要调用两次BitBlt。第一次用SRCAND光栅操作码，传送掩膜位图；第二次用SRCINVERT光栅操作码，传送图形位图。
　　首次调用BitBlt显示黑色图形，不影响图形周围窗口背景上的现有图形，第二次调用BitBlt将彩色图形传到窗口，也不影响现有图形。总的结果是非矩形在窗口显示，周围是原窗口图形。
　　Declare Function BitBlt Lib "GDI32" (
ByVal hDestDC As Long, 　　′目标设备上下文句柄
ByVal X As Long, 　　　　　′目标图左上角X坐标
ByVal Y As Long,　　　　　　′目标图左上角Y坐标
ByVal nWidth As Long, 　　　′图像宽度
ByVal nHeight As Long, 　　′图像高度
ByVal hSrcDC As Long, 　　　′源设备上下文句柄
ByVal XSrc As Long, 　　　′源图左上角X坐标
ByVal YSrc As Long, 　　　′源图左上角Y坐示
ByVal dwRop As Long) As Long
3.2.2　利用PhotoShop
　　制作有透明效果的GIF图形文件。轮缘结点叫做ATM VP ADM 结点,它采用SDH 1+1保护倒换机制。
　　. 用PhotoShop调入该图形文件，将其图形模式改为Indexed Color。
　　注意：如果在轮辐信号上既检测到AIS,又检测到LOS,并且j≥i, 则自愈轮将面临着多条链路同时失效,并且一些连接将会丢失。
　　在VB中使用Image控件，调入做好的透明图片，此时无须调用BitBlt函数，就可以实现透明图形在屏幕上的移动。但这种方法有一些限制，在VB中只有Image控件可以用该法实现透明图形。
3.3　程序实例
　　创建一个工程，程序中用到的控件及其属性有：
　　窗体：Name 为Demo
　　图片框：
　　　Name　　　picCopy　picMask　　　　PicSprite
　AutoRedraw　　　True　　True　　　　　　True
　AutoSize　　　　True　　True　　　　　　True
　Picture　　　　None　MillerMask.bmp　　Miller.bmp
　ScaleMode　　　pixel　　　pixel　　　　　pixel
　Visible　　　　False　　　False　　　　　False
　　定时器 Name: TimerDemo　Interval:200
　　程序中使用了几个全局变量，NewX,NewY,PicWidth,PicHeight。
　　NewX,NewY用于确定目标的位置，PicWidth,PicHeight用于确定图像的大小。(限于篇幅，代码模块程序表单略)
3.4　生产线监视动画显示
　　生产线分为上料区、ATE检测区、接驳区、灌胶区、下料前区、下料区、恒温区和老化区几个部分。
　　程序设计采用面向对象的程序设计方法,对于生产线的各个区分别采用一个定时器事件来处理其动作:
　　程序中使用了五个定时器事件:
　　　上料区　　　　tmrLoad
　　　ATE检测区　　 tmrCheck
　　　接驳区　　　　tmrBuffer
　　　灌胶区　　　　tmrDrop
　　　下料前区　　　tmrUnload
　　　下料区tmrUnload
　　五个区动作逻辑如下：
　　. 上料区
nAction=0 从无到有上料直至有两块PCB板进入检测区
nAction=1 进两个PCB板及其外壳
nAction=2 进一个PCB板外壳
nAction=3 进两个PCB板外壳
nAction=4 进两个PCB板
　　. ATE检测区
nAction=1 ATE开始检测,机械手回至原位(第一条轨道)
nAction=2 进两个PCB板及其外壳
nAction=3 检测后两块PCB板均坏
nAction=4 检测后第一块坏,第二块正常
nAction=5 检测后第一块正常,第二块坏
nAction=6 两块均正常
nAction=7 只进两块PCB板,机械手回至原位
nAction=8 只进两块PCB板外壳
nAction=9 只进一块PCB外壳到机械手位置1
(当第二块PCB板坏)
nAction=10 只进一块PCB外壳至机械手位置2
(当第一块PCB板坏)
nAction=11 只进两块PCB板
nAction=12 机械手回至原位
　　. 接驳区
nAction=0 清空接驳区
nAction=1 进两块PCB板
nAction=2 从位置1进一块PCB板
nAction=3 从位置2进一块PCB板
　　. 灌胶区
nAction=0 当接驳区有六块PCB板,进六块PCB板
nAction=1 开始灌胶
nAction=2 当接驳区有七块PCB板,进六块PCB板 
　　. 下料区
　　nAction=0 进六个PCB板到下料前区
nAction=1 排齐PCB板(九个一组)
　　定时器事件模拟了生产线上的PLC控制器,对于每一个定时器,首先给出其动作类型,相当于PLC调用不同的程序,然后启动定时器,相当于PLC被触发。
　　每一个定时器须要满足一定的条件才能被启动,相当于PLC必需满足一定的条件才能被触发。
4.2　自愈轮协议
　　电缆的切断常引起多信号失效。
　　在非失效模式下,自愈轮的带宽和星型拓扑相当。
4　结语
　　将动画技术加入系统，可以实时仿真生产线运行情况，使之更具有生动性，为生产线的监视带来很大的便利。应用可视化编程语言VB及图像处理软件可以方便地实现动画效果。
作者简介：李秀　博士研究生。
沈晶　硕士研究生。
姜澄宇　教授，博士生导师。本文中所描述的单汇接自愈轮,不能恢复失效轮彀。
4.2　自愈轮协议
　　电缆的切断常引起多信号失效