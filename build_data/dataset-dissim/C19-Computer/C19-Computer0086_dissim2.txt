计算机工程
COMPUTER ENGINEERING
1999年 第25卷 第8期 Vol.25 No.8 1999



一个新型组播会话目录服务体系
舒南燕，方乐，白雪峰，徐公权
摘要：介绍分层媒体传输模型基础上的新型组播会话目录服务体系，可提高分层媒体传输中的信道带宽利用效率，并降低目录服务客户端的启动延迟。本文采用 HSV 彩色显示模型，建立地面点高程、坡度和表面法线方向到 HSV 色彩分量之间的映射关系，根据人眼的视觉特点，对地表方向和坡度采用线性映射，而对于高程采用了指数函数变换，这便于突出地表参数的动态范围，增强立体效果。 
3 结论
　　ARC/INF°手册中给出了基于地形高程和坡度参数的等范围赋值映射方法，用该方法制作的图具有软表面 (Soft Surface) 的感觉。但目前的组播应用尚存在以下问题。 ARC/INF°的 TIN 和 GRID 模块均提供表面阴影计算命令 ( 函数 ) ，可以利用 TIN 提供的命令计算出地形表面每一点的阴影值，也可利用 GRID 提供的函数对式 (7) 编程，实现每一表面点亮度的计算。 
　　依据式 (1) 、 (2) 、 (3) 计算地表每一点 H 、 S 、 V 分量，将它们发送到相应的显示通道，即可组合成反应地表形态特征的彩色图象。 
　　(2) 为了确保会话公告不占用过多的带宽，送往广域 Mbone 的会话公告的带宽被限制在 200b/s ，当会话发起方 25 个公告平均信息长度为 500B 的会话时，这种限制将导致单个会话的多次公告间隔时间达到十几到几十分钟。同时由于不可靠的组播，目录服务客户端必须等待 10-20 分钟才能看到某个会话公告。 
　　这是 Internet 上发展组播应用程序时不能回避的两个问题。在相当程度上，这两个问题的解决情况将影响组播应用在 Internet 上的推广。不仅需要有针对每个问题的解决方法，更需要在现有协议框架上综合考虑。 
1 背景知识 
1.1 分层媒体传输 
　　分层媒体传输是 Deering [2] 提出的一个端对端的解决方案，针对在底层异构的 Internet 上 IP 组播服务缺乏阻塞控制机制的问题。媒体分层的思想是：使用一个层次化的编码算法， 将源数据编码成一系列的层 l1 ,l2 ,..ln , 一个解码器在其余层缺失的情况下能将一个有序的层次子集 (l1 ,l2 ,..li ， 1<i<n) 解码。解码器端可用的层次越多，重组信号产生的扭曲就越少。用 z = f(x,y) 表示地面地形的高程分布，则 pα 和 α 的计算可表示为： 

图4 坡度的表示
pα(x,y)= sqrt(fx'(x,y)2+f y'(x,y)2)　　(4)
α (x,y) = Arctan(pα(x,y))*180/ π　　(5)
　　DEM 格网数据为离散的地表点高程值，由 DEM 计算地表的坡度，可用如下差分形式计算： 
pα(i,j)= sqrt((dz/dx)2 +(dz/dy)2)　　(6) 
在点 (i,j) 处的 dz/dx 和 dz/dy 可用该点周围的 8 邻域离散点的高程值计算 ( 参见图 5) ： 

图5 点（i，j）的8领域坐

　　其中： x_mesh_space 和 y_mesh_space 分别为 X 和 Y 方向的格网精度。每个层对应一个组播组。 
　　地形晕渲处理包括 DEM 数据生成、晕渲处理建模、表面色彩分量计算等步骤。这种基本架构被细化为一种特殊的协议框架－接收端驱动分层组播 RLM(Receiver-driven Layered Multicast) 
1.2 scope －组播范围界定 
　　" 组播范围 " 是一种限制组播数据传播范围的机制。通过限制只在有管理意义的网络区域内传输公告信息，降低了传输带宽，同时在不同区域之间可复用有限的组播地址集，提高了网络的可扩展性。 
　　如何界定组播范围？ IP 组播服务模型提供两种机制。当 IP 组播最初建立时， IP 报文头里用来限制报文在路径上跳跃时间的 Time-To-Live(TTL) 域被用来限制区域。报文经过路由器时 TTL 域减 1 。当减少到 0 时，报文被丢弃。由于用户可能对网络的拓扑情况不是很了解，导致不能正确设置合适的 TTL ，因此 TTL 限制并不十分有效。另一种方法可以让网络管理员通过设置 TTL 阈值定义简单的管理区域。设置了 TTL 阈值的路由器将丢弃任何 TTL 域低于阈值的组播包。然而 TTL 界定方法缺乏灵活性，并且 TTL 界定方法与某些组播路由协议的交互性很差。所以 " 系统管理界定 " 被提出作为 TTL 界定的替代。具体映射关系如下： 
s = 10.0*(90-α) / 9.0　　(1) 
　　其中： α 为地面角度坡度 ; 
　　(2)
　　其中 : Z 为地面点高程值， Zmax 、 Zmin 为区域最大和最小高程。网络管理员为该范围选择一系列地址，并在区域边界上配置所有的组播路由器，使路由器丢弃所有经过区域边界准备发往地址范围内地址的包。 
　　" 系统管理界定 " 的一个通常用法是圈定一个使用高速带宽连接的区域，使高速传输不会漏向较低速的网络。 
1.3 建立 IP 组播基础上的 SAP 
　　SAP-Session Announcement Protocol 服务公告协议。 SAP 使用会话公告模式，定期公告会话描述至一个共知的引导地址，公告中描述特定媒体流和特定组播地址的绑定。在客户端，会话目录工具维护一张表格，列出了所有近来通过 SAP 公告的会话描述。因为会话公告包括了启动实际应用所需的所有信息，当用户选择一个程序时，会话目录工具可以运行相应的应用，使用户从烦琐的命令行参数和地址处理中解脱出来。 

图1  HSV色彩模型
2 DEM 格网数据的 HSV 模型显示方法 
　　地形晕绚处理就是针对已知的地面高程数据，对地形表面进行着色。定时器超时后会话被删除。 

图1  HSV色彩模型
2 DEM 格网数据的 HSV 模型显示方法 
　　地形晕绚处理就是针对已知的地面高程数据，对地形表面进行着色。正常操作时，一个激活的会话描述被定期的信息不断刷新。当一个会话过期或应用程序宣告其停止运行时，会话描述最终超时。根据上述 HSV 视觉模型，可以对数字地面高程模型 (DEM) 数据进行分类，分类可以依据 DEM 高程数据的多种统计特征值进行，然后将不同的分类结果映射到 HSV 视觉空间中的 H 、 S 、 V 分量，最后将这些分量合成，即可形成彩色图象。 
　　(1) 建立映射模型 

图2 色度（hue）与高程值之间的映射关系图3 饱和度与坡度的映射关系

　　将高程影射到色调 h ，高程从高到低，对应的颜色由红到绿，即最高的山用红色表示，对应的 h 为 120 °，最低的山用绿色表示，对应的 h 为 240 ° ( 参见图 2) ；将地表坡度映射到饱和度 s ，坡度越大颜色越深，坡度越浅，颜色越淡 ( 参见图画 3) ；用考虑太阳光照射到地表后，在某一观测方位形成的该地表点的反射光强 I 映射成明亮度 v ，反射光越强，对应的亮度越强。在每个管理界定的区域内，运行一个 SAP 实例。由区域边界上的组播路由器限制针对局部区域的会话公告只在该局部区域内发送，从而降低公告带宽，空间复用组播地址，同时也保证了主机只收到他们能够参与的会话的公告。 
　　SDP(Session Description Protocol)- 会话描述协议定义了一个标准格式，包括媒体信道描述 ( 媒体类型和格式，传输协议，网络地址和端口 ) ，时间信息和其他会话描述信息。根据上述 HSV 视觉模型，可以对数字地面高程模型 (DEM) 数据进行分类，分类可以依据 DEM 高程数据的多种统计特征值进行，然后将不同的分类结果映射到 HSV 视觉空间中的 H 、 S 、 V 分量，最后将这些分量合成，即可形成彩色图象。饱和度是指彩色光所呈现的深浅程度，对于同一色调的彩色光，其饱和度越高，说明它的颜色越深，饱和度越低颜色越淡。使用该模型，会话目录服务必须公布媒体流在其上传输的一列组播组的地址。这些地址由会话发起方在创建会话时分配。一个直接的方法是为包括所有参与者的最小组播范围分配一块地址。但是会产生如图 1 所示的问题： 

图 1 多数据源的分层媒体接收端适应 
　　媒体流分两层，由某主机发起， R ， S1 ， S2 参加。两个组播地址代表两层数据流。若 R 没有针对单独数据源修剪流量的能力。 R 只能参加基层，否则从 S1 来的高速数据流将阻塞慢速连接。若 R 具有针对数据源的修剪能力， R 可以加入提高层传输而修剪掉由 S1 来的提高层。这样 R 接收由 S2 来的高速传输就不会阻塞与 S1 的链路。 
　　地形晕渲处理包括 DEM 数据生成、晕渲处理建模、表面色彩分量计算等步骤。目前的组播服务模型不提供这种特性。而且至少若干年后，才能大规模地扩展 IP 组播服务使之有这种能力。 
　　其次， RLM 模型通过增加订阅的层定期试探未使用的带宽。这种试探是破坏性的，特别当接受方知道高带宽的提高层超过其与发送方的实际物理连接能力，而仍然做未使用带宽的试探，宝贵的带宽将浪费在超时重传上。这种情况类似于对一条建立在低速调制解调连接上的 TCP 连接，增大拥塞窗以至于超过 modem 线的实际物理能力。饱和度是指彩色光所呈现的深浅程度，对于同一色调的彩色光，其饱和度越高，说明它的颜色越深，饱和度越低颜色越淡。针对第一个问题，管理范围边界上的路由器将防止高速 " 提高层 " 流到管理范围外。针对第二个问题，由于已限定了不同速率媒体流的传输范围，接收端无需再做带宽的探测。但是，当前 Internet 会议创建体系并不支持这种地址分配方式。在当前的体系中，由会话发起方为媒体流分配所有的地址，而我们需要在本地管理范围内分配 " 提高层 " 地址。显然，一个会话发起方不可能为网络中每一个能使用 " 提高层 " 的局部管理范围分配所需的地址。本文给出的 AML 源程序在 SGI 上的 ARC/INF°版本 1.7.4 下调试通过，可以方便地移植到其它平台的 ARC/INF°环境下运行。 
v = I*100/255　　(3) 
I 是地形表面点法线方向的函数， I 的计算将在下面介绍。色调反映了颜色的类别，彩色物体的色调决定于物体在光照射下所反射的光谱成分。当描述所有层不在同一范围内传输的分层会话时，需要多个 SDP 信息，并且 SDP 信息要提供相应的保障机制，当不同层传输到不同范围时，能够重组已分层的会话并正确公告。文中重点讨论了基于 HSV 组合视觉模型的晕渲建模和色彩分量计算方法，并给出了在 ARC/INF°环境下实现这一过程的 AML 语言程序。不连续的地址不能被描述。当会话的不同层被传播至不同的范围时，如果只用一个 SDP 信息，有两种情况可能发生：如果这时一个包含所有地址的公告在广域内被公布，所有接收者会看见提高层的地址，然而这些地址对于管理区域外的接收端并不有效，而在 IP 组播服务模型中，接收端难以确定是否和另一主机处于同一区域。所以，如果一个公告包含了提高层的地址，接收端不易确定提高层是否可用；相反，如果会话公告只在管理范围内传输，这样范围外的接收端不能看见对基层的公告，而这原本是应当被接收到的。所以要描述上述目录服务体系中的会话，须使用多个 SDP 信息。每个 SDP 信息中包含同一管理范围内的一列连续地址，但不包括不同范围内的地址。当使用 SDP 信息描述 SAP 公告时，信息在某个范围内公告，信息也在同一区域内组播。 
　　附 1 ：用本文方法制作 HSV 彩色晕渲图的 AML 程序： 
　　/* 由 DEM 栅格数据制作晕渲地形图的 AML 程序 */ 
　　/* Program Name: hsv.aml */ 
　　/* Author: Grant Lee, Hai 6, QingHe Building , BeiJing 100085*/ 
　　/* Input: DEM lattice ----%dgxlat% */ 
　　/* Output: Composite map ----hsvmap */ 
　　&getcover lattice %dgxlat% /* get lattice of elevation t°process 
　　/* construct saturation component lattice ss 
　　latticepoly %dgxlat% s_poly slope slope.lut /* slope.lut should create earlier in tables 
　　latticereplace %dgxlat% s_poly ss 1.111 slope-code 
　　kill s_poly /* kill temperary slope polygon coverage 
　　/* construct hue lattice hh 
　　grid /* use grid module t°process 
　　disp 9999 3 
　　&describe %dgxlat% 
　　&s k = 120.0 / ln( %grd$zmax% - %grd$zmin%+1 ) 
　　docell 
　　　hh = 120 + %k% * ln( %dgxlat% - %grd$zmin% ) 
　　end // end of hue lattice gereration 
　　/* generate value lattice vv through hillshade 
　　/* vv should be within the range of (0,99) 
　　v = hillshade(%dgxlat%,#,#,#,#) /* 0 -- 255 */ 
　　docell 
　　　vv = v * 0.3922 /*vv: 0--99 */ 
　　end 
　　q 
　　ap 
　　map hsvmap 
　　mape hh　　　　 /* set map extern */ 
　　gridcomposite hsv hh ss vv linear /* show composite image 
　　/* Add other map composite such as legend,tittle etc. here 
　　map end 
作者单位：第二炮兵第三研究所，北京 100085
参考文献 
1 Environmental Systems Research Institute, INC., Surface Model- ing with TIN TM 
2 Edwards K,Davis P A.The Use of Intensity-Hue-Saturation Tran- sformation for Producing Color Shaded-Relief Images.Photogra- mmetric Engineering and Remote Sensing, 1994 ， 60(11) ： 1369- 1374 
3 周新伦 . 数字图象处理 . 北京：国防工业出版社， 1988 
。这由 SDP 中的一个域 "o=" 保证。在每个会话中，对组成同一个公告的所有信息 "o=" 域设置得一样，客户端可以识别组成一个公告的所有信息。一旦相应的信息被接收到，还需 要启动相应的媒体工具重排信息。这由 SDP" 属性 "(attribute) 机制完成。 
v = I*100/255　　(3) 
I 是地形表面点法线方向的函数， I 的计算将在下面介绍。 
　　(2) 地面坡度 α 的计算 
　　坡度有两种表示方式，一种是百分比坡度 pα ，它是高度的增值与水平距离变化值之比；另一种是角度坡度 α ，即用坡面切线与水平面的夹角表示 ( 参见图 4) 。属性包含层数或一个层范围 ( 如 2 或 4-7) ，可选的是总层数。如果出现总数，则直到所有层地址被接收，一个公告才算完整。对一些分层传输方案，层总数无需对每个接收端都相同。在这种情况下，总层数不确定，如果到某个时刻的全部层都接收到，一个公告即被认为完成。也有可能一个或多个包含更高层地址的信息尚未到达，公告即被认为完成。所以在决定公告已经完整前，应用程序应该为可能到来的提高层等待一小段时间。 
v = I*100/255　　(3) 
I 是地形表面点法线方向的函数， I 的计算将在下面介绍。当规定了会话总层数，而在本地范围内一些层未被分配时，在任何本地成员加入会话前，代理必须分配缺少的层。如果有很多类似的不完整会话组，为所有的会话分配地址会浪费组播地址。因为广域范围内公布的会话总数不多，可以暂时不考虑这个问题。可能的解决方法是在代理内部定义一种策略，决定哪些会话保留不完整状态。另外，可定义一种机制，让用户自己向代理表达对某个会话的兴趣，代理分配缺失的层，完整该公告来回应用户。 
　　对于未定义总层数的会话，问题比较难解决。一个会话无论何时都可被认为是完整的。但是如果局部参与者对会话有一定兴趣，一个代理不知道是否应该分配本地高带宽提高层。在实现中，可设置代理对每个会话具有一个目标层数。 
　　(2) 地面坡度 α 的计算 
　　坡度有两种表示方式，一种是百分比坡度 pα ，它是高度的增值与水平距离变化值之比；另一种是角度坡度 α ，即用坡面切线与水平面的夹角表示 ( 参见图 4) 。用 z = f(x,y) 表示地面地形的高程分布，则 pα 和 α 的计算可表示为： 

图4 坡度的表示
pα(x,y)= sqrt(fx'(x,y)2+f y'(x,y)2)　　(4)
α (x,y) = Arctan(pα(x,y))*180/ π　　(5)
　　DEM 格网数据为离散的地表点高程值，由 DEM 计算地表的坡度，可用如下差分形式计算： 
pα(i,j)= sqrt((dz/dx)2 +(dz/dy)2)　　(6) 
在点 (i,j) 处的 dz/dx 和 dz/dy 可用该点周围的 8 邻域离散点的高程值计算 ( 参见图 5) ： 

图5 点（i，j）的8领域坐

　　其中： x_mesh_space 和 y_mesh_space 分别为 X 和 Y 方向的格网精度。 
　　如前所述，由于 SAP 公告所用带宽的限制，造成目录服务客户端较长的启动延迟。一种解决方法是在代理中加入 cache ，当代理监听所有的 SAP 公告时，它顺便维护一个 cache ，其中包括当前被公告的会话。当一个目录服务客户端启动时， cache 中的内容被迅速传播到客户端，而降低了客户端的启动时间。我们可以建立一条从客户端到 cache 的 TCP 连接实现会话目录客户端和 cache 间的通信。通过 TCP 通道传递所有的变化，如会话的创建，更新，超时等。对于少量客户端而言，这种解决方法是有效的，但是不易扩展到很多客户端的环境。对于很多客户， cache 必须承担同时维护许多 TCP 连接的重荷。 

图1  HSV色彩模型
2 DEM 格网数据的 HSV 模型显示方法 
　　地形晕绚处理就是针对已知的地面高程数据，对地形表面进行着色。 
　　更好的解决方法是在代理中引入由 Amir 提出的 " 软网 关 " 的概念。明亮度是光作用于人眼时引起的明亮程度，一般来说，彩色光所含能量越大则显得越亮，反之则暗。前一个协议实例监听广域信道上的 SAP 公告，输出一个描述当前会话更新的列表，该列表作为后一个协议实例的输入。广域 SAP 信道上被接收的每个会话公告被该 " 软网关 " 在本地范围内重新公告。由于在本地区域内的带宽上限远高于广域范围内的上限，结果使得会话描述的发送更频繁，会话客户端的列表也被更快地更新。 
　　" 软网关 " 可以大大降低会话目录客户端的启动时间。假设总共有 N 个会话需要公告，平均长度为 size ，累计用于 SAP 的带宽为 bw ， SAP 信息由 UDP 包携带发送，而 UDP 不保证可靠发送。那么，在会话目录客户端在启动阶段，如果一个会话公告丢失，则客户端必须等到公告被重传。 n 表示会话目录客户端收到所有公告前预计需传输的公告数， p 为包独立丢失率。会话目录客户端接收到所有公告前预计的时间为： 

　　由于接收方要同时监听本地和广域的公告，其中参数 bw 是本地带宽加广域带宽 ( 固定为 200b/s) 。预计的目录工具启动时间与本地带宽的关系如图 2 所示。其中， N ＝ 30 ， size=500B ， p=0 。图中 SAP 带宽为 0 处对应没有 " 软网关 " 的情况，即客户端只在广域 SAP 信道上接收公告。由此可见，软网关使会话目录工具的启动延迟大大降低。 

图2 SAP带宽与会话目录启动时间
　　在没有软网关时，包丢失率是影响启动延迟的关键。因为在大多数情况下， " 软网关 " 和客户端之间的包丢失可以忽略不计，所以 " 软网关 " 相对于 TCP 连接有两个优点：提高带宽带来的更快的收敛，降低包丢失率带来启动延迟的降低。 
3 总结与展望 
　　底层的异构性是 Internet 上的组播应用程序必须注意的一个问题。实验表明，用本文的方法绘制的晕渲图比 ARC/INF°手册上介绍的方法建立的晕渲图具有颜色动态范围大、立体感强、色彩也更丰富的特点，可以更好地反映地形形态的变化。如前所述，代理机制为解决组播目录服务中的其他问题提供了空间。本文所述的目录服务客户端启动延迟的降低只是一个例子。代理中还可以实现其他功能。在未来的工作中，我们将讨论用户根据需要加入任意服务组合的可能性，进一步，讨论在代理中实现针对每个用户的组播服务质量的控制。总之，以代理为工具，解决组播应用程序在目录服务方面的问题，不断完善该目录服务体系将是我们今后工作的重点。 
　　Internet 上的组播应用是 Internet 上新出现的事物。用 z = f(x,y) 表示地面地形的高程分布，则 pα 和 α 的计算可表示为： 

图4 坡度的表示
pα(x,y)= sqrt(fx'(x,y)2+f y'(x,y)2)　　(4)
α (x,y) = Arctan(pα(x,y))*180/ π　　(5)
　　DEM 格网数据为离散的地表点高程值，由 DEM 计算地表的坡度，可用如下差分形式计算： 
pα(i,j)= sqrt((dz/dx)2 +(dz/dy)2)　　(6) 
在点 (i,j) 处的 dz/dx 和 dz/dy 可用该点周围的 8 邻域离散点的高程值计算 ( 参见图 5) ： 

图5 点（i，j）的8领域坐

　　其中： x_mesh_space 和 y_mesh_space 分别为 X 和 Y 方向的格网精度。如果还有大容量的多媒体数据传输，真正实现组播应用还需要更多的努力。本文所介绍的会话目录服务体系只是在这方面的一个尝试，希望能和大家探讨。 
作者单位：复旦大学CAD/CAI多媒体制作中心，上海 200433
参考文献 
1 Tanenbaum A.Computer Networks(Third Edition).U.S. ： Prentice Hall PTR, 1996 
2 Deering S. Internet Multicast Routing-State of the Art and Open Research Issues. Stockholm.: Multimedia integrated Conferencing for Europe (MICE) Seminar at the Swedish Institute of Computer Science, 1993-10 
