计算机工程
COMPUTER ENGINEERING
1999年 第25卷 第8期 Vol.25 No.8 1999



HFC网络计费管理的分析与研究
罗静，汪敏
摘要：对HFC网的Internet服务计费机制进行了分析和设计，讲座了针对HFC网的用户入特点，分析了计费系统中的一些关键问题和难点，从而提出解决方法。
关键词：计费；简单网络管理；传输控制协议/网间协议；光纤同轴电缆混合
Analysis and Research on Accounting Managemetn in HFC
Luo Jin,Wang Ming
(Department of Communication Engineering,Shanghai Univ.,Shanghai 201800)
【Abstract】This article analyizes the methods of accouting for Internet service,discusses the characters of HFC access network,proposes some important questions and difficulties,and then gives the solutions to them.
【Key words】Accounting;SNMP;TCP/IP;HFC
　　网络计费系统可分两大部分：数据采集和对采集的数据进行分析处理。由于用户使用网络的方式不同，其数据的采集方法也不相同，而用户本身又可分两类：个人用户和集团用户 ( 如学校等 ) ，对他们的计费方式都有所区别。个人用户一般通过电话拨号上网，而集团用户则通过 x.25 、 DDN 、以太网等有 IP 连接的方式上网。电话拨号又可分两种：仿真终端方式和 PPP/SLIP 方式。同时在通信服务机通信软件的设计上强调协议分层，提供统一的外部调用接口，适应了各调度系统应用层协议、网络协议多样性的要求，大大方便了调度系统的接入。 
　　对于个人用户的计费将基于主机系统；对集团用户将采用基于 IP 地址的流量统计来计费 ( 数据一般取自路由器 ) 。为适应网络通信，我们对应用层协议进行了扩展，在部颁应用层协议的报文头加了 8 个字节的路由块，前 4 个字节为报文目的地址，后 4 个字节为报文源地址称之为扩展部颁应用层协议。不论从传输速度还是从网络稳定性方面 HFC 都是一个比较理想的传输网络，而且我们国家有线电视的普及率也比较高，可以利用现有的基础设施，所以 HFC 对于建设国家信息高速公路是非常有利的。 HFC 的网络管理是决定网络能否正常运转的前提，而网络计费功能又是网络管理中一个非常重要的方面，它与每个用户的切身利益密切相关。 
　　经过分析和研究 , 整个计费系统分为两部分：用户上网时间计费系统和 IP 流量计费系统。同时在通信服务机通信软件的设计上强调协议分层，提供统一的外部调用接口，适应了各调度系统应用层协议、网络协议多样性的要求，大大方便了调度系统的接入。 

　　以上针对申请固定 IP 地址的联网形式，用户不需要 Internet 帐号，主要根据 IP 流量进行计费。具体实现方案如下： 
　　(1) 用户上网时间计费系统 
　　一般用户连入 Internet 采用 Modem 拨号上网，通过拨号程序进行网络连接，登录上网，拨号完成的是网络上物理连通，帐号验证完成的是网络上逻辑连通。而 HFC 网中用户计算机通过网线连入 HFC 网中，相当于专线连接，网络在物理上是一直连通的。虽然 HFC 网不存在用户抢占 RAS 拨号端口的问题，但是 HFC 是树型拓扑结构，网内的 MAC 规约采用上、下行信道的非对称结构，并将上行信道划分成多个竞争信道和预约信道。所以也存在用户抢占上行信道传输信息的问题，这样用户占用信道类似于拨号占用通信端口，对用户连接时间记录是非常有意义的，这也是 HFC 不同于一般专线连接局域网所在。在这种情况下，如果对用户上网时间进行记录可以效仿拨号上网的通信机制，开发一个客户机 / 服务器模式的通信软件包，它由 Server Programme 和 Client Programme 两部分组成， Client Programme 提供给用户一个登录界面， Server Programme 相当于一个 RAS 软件，负责帐号的验证和用户上网信息 ( 包括上网时间 ) 的记录。这种方法的关键在于如何把该软件与用户申请 Internet 服务紧密结合，要求用户进行 Internet 服务之前必需运行该软件进行帐号验证工作。考虑到 Router 有基于 IP 地址的包过滤功能，例如 Cisco 路由器中，通过 access-list list {permit|deny} protocol source source-mask destination destination-mask [operator operand][established] 命令可以配置哪些 IP 包可以被路由器转发到 HFC 网外。 
　　增值网结构就网络通道而言有以下两个特点： 
　　(1) SUN 通信服务机通过 SunLink HSI(High-speed Serial Interface) 卡直接接入分组交换网，实现基于 X.25 的网络互联。 
　　(2) IP 流量计费系统 
　　由 HFC 网的拓扑结构可以看出 HFC 网通过 Internet 路由器连入 Internet ，当用户与 HFC 网外站点进行通信时，每一个数据包必须经过该路由器，根据记录到的 HFC 网络中每个 IP 地址的进出流量，以及在不同时间段，对不同费用网络的使用情况等进行统计，从而给出记账依据。由于在基于 TCP/IP 的互连网络中，所有应用的数据都是在 IP 数据包上进行的，因此， IP 的数据流量反应了用户对网络的实际使用情况。基于流量的记账对于租用专线或信道，它反应了每个 IP 地址使用公用线路的比例，对于按连接时间计费的线路，也具有一定的参考作用，因为一般连接时间越长，传送的数据量也越多。 
　　流量数据的收集是通过 SNMP 完成的。 SNMP 是一套标准的网络管理协议，在 SNMP 环境下，网络管理是由网络管理工作站 (NMS) 和一些被管理的网络设备 ( 如主机，中断服务器，路由器等 ) 构成的。网络设备上的 SNMP 代理监测和控制网络设备，如它收集各种网络管理信息，包括端口流量，从一个源 IP 地址到目的 IP 地址的流量等。为了让路由器记录该类信息，必须在想要计费的那个路由器的端口的配置里加入一行： IP Accounting 。 NMS 和 SNMP 代理之间则通过 SNMP 协议交换管理信息，执行管理功能。管理信息的交换是通过 SNMP 协议数据单元 (PDU) 完成的，在 SNMP 协议中，有 5 种基本的 PDU ，它们是： Getrequest-PDU ， Getnextrequest-PDU ， Getresponse-PDU ， Setrequest-PDU ， Trap-PDU 。数据收集的具体过程是在网管工作站上启动一个数据收集进程，它根据配置文件确定收集数据的行为。配置文件中有被收集数据路由器的名字， IP 地址， Community 名字，收集间隔，数据存放地址等可修改的配置信息。数据收集进程根据这些配置信息，读取相应路由器的信息并保存。 Pentium 通信服务机主要用于 RMIS 系统的接入，本文将不作详细的讨论。但考虑到华东电网各省市调的 EMS 主机负载已过重，若直接在 EMS 主机上进行增值业务 ( 网络管理、信息管理等 ) 的开发必将使负载问题严重恶化。在统计时，要考虑以下两个与记账有关的因素： 
　　1) 对于目的地址不同的 IP 流量，由于经过的线路不同，费用也就不一样。同时在通信服务机通信软件的设计上强调协议分层，提供统一的外部调用接口，适应了各调度系统应用层协议、网络协议多样性的要求，大大方便了调度系统的接入。 
　　2) IP 流量发生的时间分为高峰期，低谷期等不同的时间段。对不同时间段内的流量采取不同的收费率，这样可调节网络流量，尽量减少拥塞并利用空闲线路时间。因此还需要一张时间段费率表，含有时间段与费率的对应关系。 
　　另外，对于单位或子网的计费，要通过对每个 IP 地址汇总完成。所以还需要 IP 地址范围与单位名称的对应关系。这两张表的费率常数应该由相应的网络管理机构决定。在统计时，采用对原始收集数据顺序一次扫描，目的地址范围逐个匹配的方法。对于发送的数据，如果目的地址与某项中的地址范围匹配，则取该项的费率常数，否则继续向下比较。对于本地接收的数据，当目的地址与本地地址范围一致时，则要用源地址作匹配。应用层调用界面直接为信息网上层应用提供服务。整个系统实现的过程如图 2 所示： 

图2 IP流量计费系统实现过程
　　该计费系统只是处理一个边界路由器时的情况。该信息网主要应用于华东总调、上海市调、江苏、浙江、安徽省调和天荒坪电站各监控系统计算机间的实时通信。对于 TCP/IP 采用基于传输层的 Sockets 调用界面，网络路由由其内部的 IP 网络层解决；对于 DECNet ，则采用基于 SunLink DNI 8.0 的调用界面；对于 X.25 ，采用 SunLink X.25 8.0 网络层调用界面，该层的下层支持包括 SunLink HSI/S 2.0 driver ？我们作如下讨论： 
　　1) 用户申请一个合法的固定 IP 地址，用户通过该 IP 地址访问 Internet ，计费系统根据该 IP 地址流量信息计费。 
　　2) 对于集团用户上网，由 DHCP 分配 IP 地址，并由计费系统根据单位整体计费，再由各单位向用户收取费用，用户访问不受限制。为此，须在有关应用层协议下面增加一个表示层，用以解决异种机数据内部表示格式不一致的问题。使用 JAVA 网络编程实现灵活性比较高，易于开发出跨平台的系统，既可以运行在 UNIX 工作站上，又可以运行在 NT/95 PC 机上，对硬件要求较低。由于整个信息网涉及到异种机连网，但不同机型机器不但数据格式可能不同，甚至数据编码也可能不同。 
作者单位：上海大学通信工程系，上海 201800
参考文献 
1 Internets Structure and Identical of Management Information for TCP/IP Base.RFC1155. 1990-05 
2 A Simple Network Management Protocal.RFC1157.1990-05 
3 周明天，汪勇编 . TCP/IP 原理与技术 . 北京：清华大学出版社 , 1993 
4 石冰心 . 中国教育和科研计算机网的研究与发展 (1). 武汉：华中 理工大学出版社 , 1996 
