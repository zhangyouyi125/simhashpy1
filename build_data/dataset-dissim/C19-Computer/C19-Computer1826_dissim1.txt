微型机与应用
MICROCOMPUTER & ITS APPLICATIONS
2000 Vol.19 No.2 P.11-12




Sybase多表复杂关联数据的传输
王双成　鲁明羽　陆玉昌
摘 要： 讨论了多表复杂关联数据的传输问题，给出了避免传输错误的有效方法。其具体操作步骤如下（以VB为例）：
　　1．启动AutoCAD应用程序。在该系统中，各客户端站点需向中央服务器传输多种具有复杂关联的数据表。由于受Sybase数据库数据完整性的制约，如果传输次序不正确，容易造成某些表的整表数据或一些表的部分记录的丢失。下面从数据传输环境、数据组织、数据表排序、数据传输、出错处理5个部分阐述多表复杂关联数据的传输处理过程。
1 数据传输环境
　　国家教委服务器端的网络操作系统采用Windows NT 4.0中文版，而下属各国家重点实验室作为客户端，其操作系统平台为Windows 95／98。
　　数据库管理系统采用的是Sybase 11.5。这是一个开放的对象关系型数据库管理系统，可为用户提供1个高性能、开放的、分布式的、端到端的体系结构，能满足网络中关键任务的专业化应用开发需求。调用如下函数： 
　　Call GetHwnd（Acadhwnd，″AUTOCAD″，″AUTOCAD －″）
　　其主要思想是通过AUTOCAD窗口标题获得AUTOCAD窗口句柄Acadhwnd。
2 数据组织
　　如果源数据库和目的数据库是同构的，则可以直接建立数据管道，处理起来比较简单。但在此系统中，国家教委的数据表存放的是所有国家重点实验室的数据，因此源数据库和目的数据库对应的数据表具有不同的结构。
　　1.源数据组织
　　为使源数据库表中的记录传输到目的数据库对应表后具有唯一的标识，采用了下面的处理方法：从基本情况表中抽取实验室代码和分室代码并存入1个辅助表中这个表只存放1个记录；将这一辅助表分别和每一数据表连接，产生对应的视图作为源数据数据包。每个表中要有传输日期字段，其数据靠程序从界面读入，以便既可以传输新数据添加，又可以传输历史数据更新，并可以随时进行数据传输。
　　2.目的数据组织
　　系统采用PB数据管道的更新／添加方式进行数据传输。与DDE相比，外部应用程序通过DDE同AutoCAD通信过程较繁且效率低下。④可移植性强。
3 数据表排序
　　数据库管理系统所进行的数据完整性检验，主要有单表的数据一致性检验和多表之间的关联一致性检验。这里涉及的表与表之间的关联一致性检验就是对有关联的表进行主码-外码对应性检查。大家知道，1个表只能设置1个主码，且主码值必须唯一，即表中的记录由主码值唯一确定；外码是在建立关联的过程中由非主码的字段定义的，其值或者设置成空值，或者等于对应主码值，此即数据的参照完整性。用此方法编制程序不必在给定的二次开发环境中受到语言和接口的约束，而可用自己的风格自由编写，开发效率高。没有主码的数据表可以任意地传输。
　　数据表可分成2大类，一类是由有主码而无外码的数据表组成，其中包括主码与其它表的外码没有关联及主码与其它表的外码有关联二种情况；另一类是由既有主码又有外码的数据表组成，其中也包括主码与其它表的外码没有关联及主码与其它表的外码有关联二种情况。
　　经过对传输过程中出现的某些表部分记录丢失情况进行仔细分析后发现：1个表的外码值允许为空是造成数据丢失的原因之一，且在实际上并非必须为空。因此应将表外码设置成不允许为空。
　　数据丢失的另一个主要原因是表传输顺序错误。为了解决这一问题，提出了在传输前对数据表按关联关系进行排序的解决方法。对于各种开发环境的优劣比较在此不作详述，但需要指出的是利用基于进程通信的ActiveX Automation开发技术的好处在于：①开发语言多样化。同层次的表顺序不限，如表1.2.1和表1.2.2的顺序任意。不同层次的数据表要严格按照自下而上的原则，直至把最上面的根表表1排完为止，再选择第二个第二类表，用同样的方法排序，直到排完所有的第二类数据表，这样就把所有的数据表排了序。与AutoLISP等程序相比，系统的安全性更易于保证，也可进行加密。这里的拓朴排序算法简要描述如下：
　　（1）根据数据表向下关联全图，建立其邻接表存储结构，且在其邻接表的头结点中增加1个存放顶点入度的数据域。同时原有的计算分析等模块可重复利用。
4 数据传输
　　在PB中处理数据传输问题主要有2种常用的方式：一种是通过用户编程来实现。把源数据表中需要传输的记录读到数组，再传输到目的数据库中，数组起着缓存的作用。这种方式适用于要求对源数据进行复杂处理且传输的数据量比较小的数据传输问题，非常灵活，几乎可以满足各种需求，只要通过编程即可实现，但编程工作量比较大，而且程序调试困难；另一种是通过PB提供的数据管道来实现。首先要组织好源数据，之后建立数据管道，最后用程序调用数据管道。此方法开发的程序有较强的可移植性，当主服务软件的版本升级时，一般只需做少量改动或不作任何改动。此二种方法各有利弊，需根据实际情况做出选择。本文针对如何有效地对AutoCAD软件系统实现ActiveX控制进行了探讨。
　　解决的办法：
　　（1）确保源数据表具有正确的排序；
　　（2）确保外码的设置是不允许取空值的；
　　（3）确保调用管道的程序没有问题（程序比较简单，容易保证）；
　　（4）对每一个管道应单独手工调试，确保没有问题之后再由程序进行调用；
　　（5）如果源数据表和目的数据表的结构不一致，那么最好是把源数据组织成与目的数据表的结构一致的逻辑表（视图）作为管道中的源数据表。
　　本文介绍了Sybase数据库多表复杂关联下的数据传输处理方法和防止数据丢失措施，简要描述了数据关联约束传输的数据表拓朴解决方案，并已在实际工作中进行了测试和校验。这些方法和措施不仅适用于本课题，而且对类似项目也有一定的借鉴作用。
王双成（北京清华大学计算机科学与技术系100084）
鲁明羽（北京清华大学计算机科学与技术系100084）
陆玉昌（北京清华大学计算机科学与技术系100084）
参考文献
1，Worden D.Sybase Developer＇s Guide.Sams Publishing， 1994
2，Hatfield B著，史森译.PowerBuilder 5应用程序开发指南.北京：清华大学出版社，1997
收稿日期：1999－08－21
