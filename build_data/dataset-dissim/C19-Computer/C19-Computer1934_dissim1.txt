微型机与应用
MICROCOMPUTER & ITS APPLICATIONS
2000　Vol.19　No.6　P.48-50




基于Visual Basic的瞬态图像
采集系统软件设计
于复生　艾兴　刘素萍
摘要：对Visual Basic在动态散斑瞬态图像采集系统软件编程方面的应用进行了探讨，并对其数据处理、I／O操作、DLL动态链接库的编制与调用、测控系统动画模拟显示等进行了研究。这种文件要采用RTF格式保存；
　　②利用帮助文件编辑器创建目录文件，以分门别类形式安排各主题页的隶属关系；
　　③创建帮助项目文件，将有关RTF文件、BMP文件、AVI文件等添加到项目文件中，然后编译生成帮助文件(hlp文件)和目录文件(cnt文件)；
　　④在应用程序的相应事件中调用Showhelp()函数，触发Windows操作系统的Winhelp程序，打开相应帮助文件的例程。这类刀片往往具有复杂的三维槽型结构，不同的槽型有不同的适用范围，所以与刀片有关的参数比较多，其数据关系也较复杂。面向Microsoft Windows系统的语言程序为用户设计优美的图像界面提供了方便，为测控系统建立高度友好的用户界面奠定了基础，其中Visual C＋＋(VC)和Visual Basic(VB)都是Windows编程的强有力的工具。VC功能强大，既能直接访问CPU的各个寄存器，又能访问内存的相关单元，尤其注重于编程技术细节的应用和代码的优化，但一般人难以在短时间内掌握；而VB则摆脱了所有的低层信息处理，它只自动地处理消息，其它的处理作为事件过程由编程者自行处理。其模块化编程优势明显，因而开发者可以快捷地创建功能强大的应用程序，摆脱了传统的开发程序所带来的惊人的工作量。PB是美国Powersoft公司推出的基于客户／服务器体系结构的可视化快速交互式开发工具。本文就所研制的动态散斑图像采集系统的VB编程，对VB如何用于测控系统的软件设计作了探讨。
1  系统的构成
　　本图像采集系统的主要构成如图1所示。其主要部分有作为动态散斑光源的脉冲激光器、CCD镜头、插入计算机主板的P540图像采集卡和图像显示器及相应的测量工件。由于P540卡没有外触发接口，基于其可编程的C语言函数，本系统采用了DLL动态链接库的方式，对系统从键盘入口进行了改制，从而完成了准确的时间控制，达到激光光脉冲的出发与CCD的图像采集时间上的一致。

图1  系统构成图
2  系统的数据处理
　　相对于其它语言来说，VB的数据结构相对简单。
彭冰（武汉华中理工大学机械科学与工程学院430074）
陈永洁（武汉华中理工大学机械科学与工程学院430074）
参考文献
1，萨师煊，王珊．数据库系统概论．北京：高等教育出版社，1991
2，冯玉才．数据库系统基础．武汉：华中理工大学出版社，1993
3，Hatfield B．PowerBuilder 5应用程序开发指南．北京：清 华大学出版社，1997
4，沃得工作室．PowerBuilder 6．0应用开发指南．北京：人民 邮电出版社，1998
收稿日期：1999－12－26
。
　　用VB编制图像采集与处理的系统，由于图像数据的存储采用二进制方式，不可避免地要使用Byte数据类型。在转换期间用Byte变量存储二进制数据，当String变量在ANSI和Unicode格式间进行转换时，变量中的二进制数据会遭到破坏，在下列的任何一种情况下，VB都会自动在ANSI和Unicode之间进行转换：读文件时；写文件时；调用DLL时；调用对象的方法和属性时。有必要根据用户需求的变化及时对电子样本应用系统做一定的修改，使其进一步得到完善和提高。所以，对于图像采集中的数据处理而言，为了避免出错，数据处理应在DLL中完成，而VB仅用来在界面中显示数据结果。
3  I／O操作
　　测控系统有较多的输入输出操作。Visual Basic虽然有较强的用户界面设计能力，但没有提供直接的I／O操作功能，当用户使用诸如AD板、图像采集卡等即插即用的功能板时，给VB编程带来了一定的困难。这就需要用户利用其丰富的用户控件VBX、动态链接库DLL、动态数据交换DDE及对象的链接与嵌入技术OLE来对其功能进行扩展。从原则上说，这些技术都可以实现I／O操作，但又各有其应用上的侧重点。
3.1 使用通信控件
　　VB的通信控件MSCOMM.VBX提供了一系列标准通信命令的使用界面，可以用来建立与串行口的连接，通过串行口连接到其它设备，发出命令，交换数据，以及监视和响应串行口连接中发生的事件和错误。但它只能用于与串行口连接的器件。
3.2 使用动态数据交换DDE
　　动态数据交换是一种进程间的数据交换形式。应用程序可通过DDE进行一次性的数据传输，也可进行现场数据的交换。PB支持常见的各种数据库，既能直接连接Sybase、SQL Server、Oracle等大型数据库系统，亦可通过开放数据库互连(ODBC)连接xBase、Access、Excel等小型数据库系统。其最大优点就是当DDE会话建立起来以后，它一般可在没有用户参与的情况下，按照事先定好的规则，自动地进行数据的交换，它比较适合于二程序间实时的数据交换。
3.3 采用OLE技术
　　OLE是继DDE之后发展起来的一种崭新的数据交换技术。OLE提供的信息传递的基本单位是对象――包括数据及操纵数据的方法的完整对象。OLE功能强大，支持可视化编程、应用程序间拖放操作及OLE自动化和对象的结构化存储等多项功能的实现。
2  系统实现
　　用户界面的友好程度对于电子样本的推广使用至关重要。对于实时测控的数据处理，这种技术并不合适。
　　在我们所研制的图像采集系统中，P540图像采集卡是中科院科技嘉公司早期的图像采集系统的主要板卡。主要应用于DOS环境，有1个CCD视频信号入口和1个图像监视器信息出口，无直接的外触发功能。它的所有功能既可以作为单独的函数在Turbo C下调用，又可以用其集成环境PCANVE.EXE。为了应用该图像采集卡的图像采集和处理函数上的方便，我们采用了DLL方式，由VB来调用TC的图像采集及处理模块。
4  DLL的建立与调用
4.1 DLL的建立
　　动态链接库DLL类似于运行函数库，程序运行期间被链接进来，是组成Windows系统的重要元素之一。DLL程序一般采用C或C＋＋语言(For Windows版本)进行编程。它主要由模块定义文件(.DEF)、动态链接函数头文件(.H)、动态链接库文件(.C)三部分组成。
　　下面用我们编制的图像采集程序来示例动态链接库的各部分结构。现实世界中实体之间的关系可抽象化为1―1、1―M、M―N三类映射关系。
4.1.2 动态链接函数头文件
　　这部分主要是定义DLL的库函数，如下所示：
　　int  FAR PASCAL PICTURE＿COLLECT(int，int)；
　　int  FAR PASCAL READ＿PORT＿VALUE(int)；
　　int FAR  PASCAL WRITE＿PORT＿VALUE(int，un－
　　　　　　　　　　　　　　　signed char)；
　　int  FAR PASCAL CLR＿PORT＿BIT(int，int，int)；
　　int  FAR PASCAL SET＿PORT＿BIT(int，int，int)；
　　void FAR PASCAL INITCARD(int)；
　　int  FAR PASCAL SAVE＿PICTURE(unsigned char)；
　　int FAR PASCAL EXTERL＿SIGNLE(unsigned char)；
4.1.3 动态链接函数文件
　　这部分是DLL库函数的核心部分，每一个函数的编程大体上与在DOS下编程一样。
　　＃include ″windows.h″
　　＃include ″dos.h″
　　＃include ″pdrv.h″ ／*P540图像采集卡的驱动函数库*／
　　＃include ″stdio.h″
　　＃include ″malloc.h″
　　＃include ″bios.h″
　　int FAR PASCAL Libmain(HANDLE hinstance，WORD wDataseg，WORD wHeapsize，LPSTRlpszCmdline)
　{
　　……
　　return 1；
　}
　　int FAR PASCAL WEP(int nParameter)
　{
　　……
　　return 1；
　}
　　int FAR PASCAL set＿base(int b)
　　　　　　　　　／*设置图像采集卡的基地址*／
  int FAR PASCAL PICTURE＿COLLECT(int EX－
　　　　　　　　　TERL＿SIGNAL，int SAVE＿PICTURE)
{
　　unsigned char color[3]；
　　int i；
　　SysInit()；
　　GrabImage(greenBank)；
　　printf(″＼nPress any key to accept the EXTERL 
　　　　SIGNAL to freeze image.＼n″0；
　　　　＿bios＿keybrd(＿KEYBRD＿READ)；
　　if(EXTERL＿SIGNAL＝NULL)FreezeImage()；
　　…… ／*图像处理的其它程序*／
　}
　　注意，上面的LinMain()和WEP()函数是DLL所必需的函数，不能省略。
　　电子样本是1种应用前景相当广阔的数据库应用软件，它的出现将极大地改变用户选择产品的方式，尤其是可利用Internet网络为企业提供新的销售方式。
4.2 DLL的调用
　　Visual Basic通过Declare(声明)来访问DLL。其编译器根据声明确定参数，检查数据类型，VB在运行期间也根据声明处理参数，进行压栈、出栈的管理工作。只要程序在Form部分或共用模块中声明了DLL过程，用户就可以像使用VB关键字或用户定义的VB过程一样，方便地使用DLL中的函数。用户依据不同的应用场合、不同的使用条件、不同的加工工艺以及对工件加工精度的不同要求，需要从各式各样的刀片形式中选择最佳者。同时，在新产品面市时，亦要考虑其样本与以前电子样本的一致性、兼容性。
　　例如：Sub DataCollection(ByVal time As Integer)
　　　　　
　　　　这里放语句
　　　　　
　　　End Sub
5  动画的显示
　　为了使系统的界面丰富生动，可视性强，使系统的数据具有图像立即显示功能，系统的运行中应采用动画显示。实现动画显示的方法有很多，针对不同的部分而选择合适的方法。
　　(1)对于在程序中固定不动的图像，为了减少在系统运行时占用的时间，可以采用其它的面向Windows的作图工具，如PowerPoint，Photoshop，PaintBrush等做好图后，作为VB的Picture控件嵌入系统界面。
　　(2)对虽是动态，但其状态转换很慢的图像，如指示灯、仪表头等，可以对其每一种状态着不同的颜色后分别以不同状态部件的裁剪文件形式存盘，形成各种部件的多状态裁剪文件。然后在系统中创建1个窗体，并在窗体中使用图像控件(内部图像不变)与图片控件(内部图像可变)来构造动画显示。系统运行时，程序将根据数据的变化而动态地改变显示的内容。当部件的状态变化时，只需将部件的变化状态控件的图像内容赋值给其标准控件，而这在VB中只需要2条语句即可实现。
　　(3)对于某些部件的复杂变化或是数据曲线的显示，一方面可以利用VB提供的复杂的图像处理控件(如Gauge控件等)来实现；另一方面可以利用动态链接库DLL调用Windows的API中的图像处理函数进行编程实现。现实世界中实体之间的关系可抽象化为1―1、1―M、M―N三类映射关系。采用VB开发测控系统的应用软件，只要能够处理好实时处理部分，就能在短时间内开发出交互界面友好、功能易扩展、面向对象的测控系统。建立实体―联系模型的关键在于正确划分实体属性和实体间的关系。该编程方法同样可以很好地应用于其它的实时测控系统中。
于复生（济南山东工业大学机械工程学院250061）
艾兴（济南山东工业大学机械工程学院250061）
刘素萍（济南山东工业大学机械工程学院250061）
参考文献
1，王占杰．多进程的数据交换．工控电子，1999；（7）：30
2，史慧康．Visual Basic 5．0实用编程技术．北京：中国水利 水电出版社，1998
收稿日期：1999－12－11
