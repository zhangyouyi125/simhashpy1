航空计测技术
AVIATION METROLOGY &MEASUREMENT TEHNOLOGY
1999年　第19卷　第4期　Vol.19　No.4　1999



一种实现实时多任务操作机制的方法
吴惠明+
摘　要　介绍一种实现实时多任务操作机制的方法和两个实例，这种方法可以用于嵌入式系统中。
　　●对合格产品进行计算机库存管理。现已对实时多任务操作系统有了深入的研究，已有专业厂家提供实时多任务系统开发工具,旨在帮助产品开发者有效地将实时多任务机制嵌入到相应的系统中，目前典型的实时多任务系统开发工具有Microtec Research公司的VRTX／OS系统和INTEL公司的IRMAX系统。据资料介绍Microtec Research公司的VRTX／OS已有50，000多个用户，具体的应用很广，大到如A340、波音747喷气客机，F―16战斗机，程控交换机，小到如MOTORLA手持无线电话等精密机电产品的系统内核，都是用VRTX／OS实时多任务系统开发工具来实现的。
　　查询可以按模块序列号、模块类型、生产日期、出厂日期以及代理商对成品数据库进行检索，并可打印查询结果。
　　笔者在以单片机为核心的嵌入式测试控制仪表产品开发的多年实践中，深切体会到实现实时多任务机制的重要性，经过探索掌握了一种实时多任务操作的实现方法，使开发的产品有较好的性能和较高的技术附加值，并在几项替代进口产品开发中发挥了作用。
1　实现方法
　　实现实时多任务操作的方法是：
1)将系统软件拆成相对独立的任务；
2)设立任务调度中心；
3)将任务调度中心和所有的任务连成一个总循环。
　　整个系统由任务调度中心和一队待执行的任务组成并形成一个总循环，任务间的参数传递，通过公共数据存储单元来实现。被激活的任务完成之后，自行将激活标志关闭，再回到总循环中。任务调度中心根据系统功能和当前发生的事件，设置相应任务的激活标志，整个系统总循环始终在进行中，以实现系统对发生事件的迅速响应。
　　程序流程总图如图1所示。


图1　程序流程总图
　　测试控制仪表一般由数据采集、数据处理、键盘输入、显示、打印、串行通讯、控制输出等几部分组成。这


图2　固体物料流量电子秤
些部分对不同的测试控制仪表来说基本相同，因而任务调度中心成了确定测试控制仪表具体特性的关键。测试系统解决了这一问题，各项测试命令事先被存储进一组命令按钮，测试时只需单击各个命令按钮，命令便自动发给模块，既方便灵活，又提高了可靠性。固体物料流量电子秤用于生产线上的物流计量和工艺控制，应用于粮食、化工、糖业、建材等行业。


图3　KF8845的任务调度框图
　　KF8845是比较典型的机电一体化产品，不仅要称重而且还要进行一系列的动作控制(如图2所示)。先打开进料闸门，然后实时称重，物料达到一定量时提前关闭进料闸门，称重结束后放料，放料结束后又重新进料，如此循环动作，实现物料流量的控制和计量。过去这样的设备都需要进口。
　　在设计过程中，共建了七个任务，分别是：A／D转换和数据处理、自检、键盘处理、调试口令处理、调试命令处理、显示和循环程序控制。任务调度中心的框图如图3所示。
　　图3中带stb后缀的是申请标志位，带boxb后缀的是激活标志位。例如：errtstb为1时，表示有自检申请。该申请是在每一循环动作时提出的，经过任务调度中心的处理，自检申请在一定条件下被接受。自检申请被接受后，自检申请标志位errtstb清为0(clr errtstb)，自检任务激活标志位置为1(setb errtboxb)。自检任务就被执行。根据测试任务，分为以下几大功能模块，如图2所示。
　　KF8845固体物料流量电子秤控制仪是采用实时多任务操作方法设计的第一个产品。因为固体物料流量电子秤与物料打包电子秤相似，它的许多动作是同时进行的。正是固体物料流量电子秤的要求，迫使我们采用实时多任务操作的设计方法。把校准器与数据采集器的一个或多个采集通道相连，通过比较系统的测试结果和校准器的标称值来检验产品是否合格。
　　数据采集器外接12 V直流电源，并通过通讯电缆与主机的串行通讯口相连。煤炭集运站定量装车系统对称重仪要求较高，称重仪是定量装车系统的眼睛，称重仪将负荷称重传感器输出信号放大处理后，将重量值实时显示出来，并即时将称重值通过RS232口以2400 BIT／S的波特率传到MODICON984主控机，MODICON984主控机根据该称重值控制四个进料闸门的关闭，实现定量装车。
4)成品管理模块
　　完成合格产品的入库登记、出库登记、维修登记、查询和统计。


图4　定量装车系统


图5　KF8841的任务调度框图
　　在设计过程中，共建了九个任务，分别是：A／D转换、不稳测试、重量计算、键盘处理、调试口令处理、零位处理、调试命令处理、显示任务和通讯处理。其任务调度中心的框图如图5所示。
　　与KF8845固体物料流量电子秤控制仪的任务调度中心图一样，带stb后缀的是申请标志位，带boxb后缀的是激活标志位。例如：zerostb为1时表示有置零申请，申请由键盘处理任务中提出，经过任务调度中心的处理，置零申请在一定条件下被接受。置零申请被接受后，置零申请标志位zerostb清为0(clr zerostb)，零位处理任务激活标志位置为1(setb zeroboxb)，置零就被执行。
　　成品管理还可按年、月统计模块的生产量、销售量以及库存量，并计算出销售给每个代理商的每种模块的数量及总和，统计结果可以打印。KF8841高精度智能称重仪的调试很简便，可实现在线调试。在称重仪现场运行的同时可对其进行调试参数的设置。1994年8月KF8841高精度智能称重仪在装车现场投入运行，1995年10月集运站定量装车系统国产化项目，通过了煤炭部组织的鉴定，结论为：达到国际先进水平，填补国内空白。KF8841高精度智能称重仪一直正常运行至今，在装车现场经受了长期的考验。1996年在我们承接的大同矿务局云岗矿和四台矿两套集运站定量装车称重系统改造项目中，KF8841高精度智能称重仪替换了原进口的不能使用的称重仪，并达到很好的效果，在可靠性和精度等各方面都超过了原进口的称重系统。其中云岗矿集运站定量装车称重系统，测量不确定度为0.03％，这样高的精度在工业现场环境中是少见的。


图1　系统硬件结构图
　　ALPHA900系列数据采集器是测试系统的主要组成部分，负责完成多路传感器信号的扫描、采集、放大、A／D转换、信号发送等功能。而且从程序流程总图,KF8841高精度智能称重仪任务调度中心框图和KF8845固体物料流量电子秤控制仪任务调度中心框图来看，两个产品虽不同，但内部结构却几乎相同。用一种同样的结构去实现不同的产品，可以大大地提高产品的开发效率和成功率。1994年8月我们从接到任务开始编相应的软件一直到现场调试成功仅用了不到10天的时间，而且KF8841高精度智能称重仪在现场一直正常运行至今。之所以能做到这一点，重要的因素就是用一种同样的结构实现并利用了已经过长期考验的程序代码。把校准器与数据采集器的一个或多个采集通道相连，通过比较系统的测试结果和校准器的标称值来检验产品是否合格。
　　产品在构思、设计、制造、销售、用户使用、维护到报废整个过程中，有其固有的规律值得去发现和应用，掌握这些规律可在产品研究开发过程中掌握主动。我们认为，实时多任务操作系统的研究是精密机电产品固有规律研究的一个重要领域，特别是随着计算机技术的高速发展以及相关产品更新换代周期的加快，这一类研究工作就更显得重要。在16位Windows中，对串口的操作有其特定的函数：
.OpenComm
.CloseComm
.ReadComm
.WriteComm
.GetCommState
.SetCommState
　　它们都属于USER.EXE程序库