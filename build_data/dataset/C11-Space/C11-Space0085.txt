航空计测技术
AVIATION METROLOGY &MEASUREMENT TEHNOLOGY
1999年　第19卷　第4期　Vol.19　No.4　1999



一种实现实时多任务操作机制的方法
吴惠明+
摘　要　介绍一种实现实时多任务操作机制的方法和两个实例，这种方法可以用于嵌入式系统中。
关键词　实时多任务操作　单片机　嵌入式系统
A Practical Method to Realise Mult－task Real－time Operation
Wu Huiming
Abstract　This article describes a practical method to realise mult－task real－time operation which can be used in embedded system.Two application cases are presented.
Key words　Mult－task real－time operation,MCU,embedded system
　　实时多任务操作系统通过对内部各项任务进行调度实现对外部输入的响应，使系统在相应的工作环境中，即使在外部事件到达时间无法预知的情况下，也能有序和有效地实现其系统功能。现已对实时多任务操作系统有了深入的研究，已有专业厂家提供实时多任务系统开发工具,旨在帮助产品开发者有效地将实时多任务机制嵌入到相应的系统中，目前典型的实时多任务系统开发工具有Microtec Research公司的VRTX／OS系统和INTEL公司的IRMAX系统。据资料介绍Microtec Research公司的VRTX／OS已有50，000多个用户，具体的应用很广，大到如A340、波音747喷气客机，F―16战斗机，程控交换机，小到如MOTORLA手持无线电话等精密机电产品的系统内核，都是用VRTX／OS实时多任务系统开发工具来实现的。实时多任务系统的设计方法在精密机电产品的开发中已有深入广泛的应用。
　　笔者在以单片机为核心的嵌入式测试控制仪表产品开发的多年实践中，深切体会到实现实时多任务机制的重要性，经过探索掌握了一种实时多任务操作的实现方法，使开发的产品有较好的性能和较高的技术附加值，并在几项替代进口产品开发中发挥了作用。
1　实现方法
　　实现实时多任务操作的方法是：
1)将系统软件拆成相对独立的任务；
2)设立任务调度中心；
3)将任务调度中心和所有的任务连成一个总循环。
　　整个系统由任务调度中心和一队待执行的任务组成并形成一个总循环，任务间的参数传递，通过公共数据存储单元来实现。被激活的任务完成之后，自行将激活标志关闭，再回到总循环中。任务调度中心根据系统功能和当前发生的事件，设置相应任务的激活标志，整个系统总循环始终在进行中，以实现系统对发生事件的迅速响应。
　　程序流程总图如图1所示。


图1　程序流程总图
　　测试控制仪表一般由数据采集、数据处理、键盘输入、显示、打印、串行通讯、控制输出等几部分组成。这


图2　固体物料流量电子秤
些部分对不同的测试控制仪表来说基本相同，因而任务调度中心成了确定测试控制仪表具体特性的关键。
　　下面以两个实例说明：
2　具体实例
2.1　KF8845控制仪
　　KF8845控制仪是固体物料流量电子秤的核心。固体物料流量电子秤用于生产线上的物流计量和工艺控制，应用于粮食、化工、糖业、建材等行业。


图3　KF8845的任务调度框图
　　KF8845是比较典型的机电一体化产品，不仅要称重而且还要进行一系列的动作控制(如图2所示)。先打开进料闸门，然后实时称重，物料达到一定量时提前关闭进料闸门，称重结束后放料，放料结束后又重新进料，如此循环动作，实现物料流量的控制和计量。过去这样的设备都需要进口。
　　在设计过程中，共建了七个任务，分别是：A／D转换和数据处理、自检、键盘处理、调试口令处理、调试命令处理、显示和循环程序控制。任务调度中心的框图如图3所示。
　　图3中带stb后缀的是申请标志位，带boxb后缀的是激活标志位。例如：errtstb为1时，表示有自检申请。该申请是在每一循环动作时提出的，经过任务调度中心的处理，自检申请在一定条件下被接受。自检申请被接受后，自检申请标志位errtstb清为0(clr errtstb)，自检任务激活标志位置为1(setb errtboxb)。自检任务就被执行。任务调度中心的职能实际上是根据系统状态受理任务申请，然后激活相应的任务或提出任务申请。
　　KF8845固体物料流量电子秤控制仪是采用实时多任务操作方法设计的第一个产品。因为固体物料流量电子秤与物料打包电子秤相似，它的许多动作是同时进行的。正是固体物料流量电子秤的要求，迫使我们采用实时多任务操作的设计方法。KF8845固体物料流量电子秤控制仪和上一代替代进口的原粮秤控制仪相比，性能有明显提高，附带地还实现了物料流量的自适应调节。
2.2　KF8841高精度智能称重仪
　　国家重点项目大同矿务局马脊梁矿高山集运站，定量装车系统国产化项目中，所使用的KF8841高精度智能称重仪，也是用这种实时多任务操作的方法设计的。煤炭集运站定量装车系统对称重仪要求较高，称重仪是定量装车系统的眼睛，称重仪将负荷称重传感器输出信号放大处理后，将重量值实时显示出来，并即时将称重值通过RS232口以2400 BIT／S的波特率传到MODICON984主控机，MODICON984主控机根据该称重值控制四个进料闸门的关闭，实现定量装车。结构如图4所示。


图4　定量装车系统


图5　KF8841的任务调度框图
　　在设计过程中，共建了九个任务，分别是：A／D转换、不稳测试、重量计算、键盘处理、调试口令处理、零位处理、调试命令处理、显示任务和通讯处理。其任务调度中心的框图如图5所示。
　　与KF8845固体物料流量电子秤控制仪的任务调度中心图一样，带stb后缀的是申请标志位，带boxb后缀的是激活标志位。例如：zerostb为1时表示有置零申请，申请由键盘处理任务中提出，经过任务调度中心的处理，置零申请在一定条件下被接受。置零申请被接受后，置零申请标志位zerostb清为0(clr zerostb)，零位处理任务激活标志位置为1(setb zeroboxb)，置零就被执行。
　　由于在仪表内部实现了实时多任务机制，不发生CPU运行等待的状况，硬件资源得到了最大限度的利用，较好地解决了精度与速度的矛盾，而KF8841高精度智能称重仪的技术性能指标也达到了较高的水平，以其高精度(0.004级)、响应快(数据采样和运算处理可达70次／s)，列为国家测力称重仪表的最高等级，而且也优于许多同类进口产品(一般测力称重仪表的技术指标精度为0.01级，数据采样和运算处理速度10次／s。KF8841高精度智能称重仪的调试很简便，可实现在线调试。在称重仪现场运行的同时可对其进行调试参数的设置。1994年8月KF8841高精度智能称重仪在装车现场投入运行，1995年10月集运站定量装车系统国产化项目，通过了煤炭部组织的鉴定，结论为：达到国际先进水平，填补国内空白。KF8841高精度智能称重仪一直正常运行至今，在装车现场经受了长期的考验。1996年在我们承接的大同矿务局云岗矿和四台矿两套集运站定量装车称重系统改造项目中，KF8841高精度智能称重仪替换了原进口的不能使用的称重仪，并达到很好的效果，在可靠性和精度等各方面都超过了原进口的称重系统。其中云岗矿集运站定量装车称重系统，测量不确定度为0.03％，这样高的精度在工业现场环境中是少见的。
3　特点
　　这种实时多任务操作的实现方法简便实用，而且还可用比较简单而明晰的流程图，描述比较复杂的系统功能，这对系统的设计调试和维护是非常有益的。而且从程序流程总图,KF8841高精度智能称重仪任务调度中心框图和KF8845固体物料流量电子秤控制仪任务调度中心框图来看，两个产品虽不同，但内部结构却几乎相同。用一种同样的结构去实现不同的产品，可以大大地提高产品的开发效率和成功率。1994年8月我们从接到任务开始编相应的软件一直到现场调试成功仅用了不到10天的时间，而且KF8841高精度智能称重仪在现场一直正常运行至今。之所以能做到这一点，重要的因素就是用一种同样的结构实现并利用了已经过长期考验的程序代码。
　　我们还用这种实时多任务操作系统的设计方法成功地设计了动态汽车衡、动态轨道衡，都取得了较好的社会和经济效益。
　　产品在构思、设计、制造、销售、用户使用、维护到报废整个过程中，有其固有的规律值得去发现和应用，掌握这些规律可在产品研究开发过程中掌握主动。我们认为，实时多任务操作系统的研究是精密机电产品固有规律研究的一个重要领域，特别是随着计算机技术的高速发展以及相关产品更新换代周期的加快，这一类研究工作就更显得重要。
作者简介：＋36岁　男　高级工程师
作者单位：长城计量测试技术研究所，北京市1066信箱，100095
收稿日期：1999-02-24收稿，
1999-03-30收修改稿
